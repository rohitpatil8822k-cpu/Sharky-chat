<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Sharky Secure Wallet</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=IBM+Plex+Mono:wght@500&display=swap" rel="stylesheet" />
  <script src="https://unpkg.com/lucide@latest"></script>
  
  <script src="https://sdk.cashfree.com/js/v3/cashfree.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-functions-compat.js"></script>

  <style>
    :root {
      --primary: #00e5ff; 
      --bg: #080a0c;
      --card-bg: rgba(255, 255, 255, 0.04); 
      --border: rgba(255, 255, 255, 0.08);
      --text-main: #ffffff; 
      --text-dim: #8e9196;
      --error: #ff4747;
    }

    body { 
      margin: 0; 
      background: var(--bg); 
      color: var(--text-main); 
      font-family: 'Outfit', sans-serif; 
      overflow-x: hidden; 
    }
    
    .app-container { padding: 40px 20px 100px; max-width: 450px; margin: 0 auto; }
    
    .balance-hero { 
      background: linear-gradient(145deg, #111418, #080a0c); 
      border: 1px solid var(--border); 
      border-radius: 35px; 
      padding: 40px 20px; 
      text-align: center; 
      margin-bottom: 30px; 
      border-bottom: 4px solid var(--primary); 
    }

    .balance-hero h1 { font-family: 'IBM Plex Mono'; font-size: 2.8rem; margin: 10px 0; }

    .option-card { 
      background: var(--card-bg); 
      border: 1px solid var(--border); 
      border-radius: 24px; 
      padding: 20px; 
      display: flex; 
      align-items: center; 
      gap: 15px; 
      margin-bottom: 12px; 
      cursor: pointer; 
    }

    .icon-box { 
      width: 50px; 
      height: 50px; 
      border-radius: 15px; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
    }

    .modal-overlay { 
      position: fixed; 
      inset: 0; 
      background: rgba(0,0,0,0.95); 
      backdrop-filter: blur(10px); 
      display: none; 
      align-items: center; 
      justify-content: center; 
      z-index: 2000; 
      padding: 20px; 
    }

    .modal-box { 
      background: #111418; 
      border: 1px solid var(--border); 
      width: 100%; 
      max-width: 400px; 
      border-radius: 30px; 
      padding: 25px; 
    }

    .input-field { 
      width: 100%; 
      background: #000; 
      border: 1px solid var(--border); 
      padding: 15px; 
      border-radius: 15px; 
      color: #fff; 
      margin-bottom: 12px; 
      font-family: 'Outfit';
    }

    .tab-btn {
      flex: 1;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--text-dim);
      cursor: pointer;
    }

    .tab-btn.active {
      background: var(--primary);
      color: #000;
      font-weight: 700;
    }

    .action-btn { 
      width: 100%; 
      background: var(--primary); 
      color: #000; 
      border: none; 
      padding: 18px; 
      border-radius: 15px; 
      font-weight: 800; 
      cursor: pointer; 
    }

    .history-item { 
      display: flex; 
      justify-content: space-between; 
      padding: 15px; 
      background: var(--card-bg); 
      border-radius: 18px; 
      margin-bottom: 10px; 
    }

    #toast { 
      position: fixed; 
      bottom: 30px; 
      left: 50%; 
      transform: translateX(-50%); 
      background: #fff; 
      color: #000; 
      padding: 12px 25px; 
      border-radius: 50px; 
      font-weight: 700; 
      display: none; 
      z-index: 9999; 
    }
  </style>
</head>
<body>

  <div class="app-container">
    <div style="margin-bottom: 20px; cursor: pointer; color: var(--text-dim);" onclick="history.back()">
      <i data-lucide="arrow-left" style="vertical-align: middle;"></i> BACK
    </div>
    
    <div class="balance-hero">
      <span style="font-size:0.8rem; opacity:0.6; letter-spacing:1px">TOTAL BALANCE</span>
      <h1 id="mainBalance">₹0</h1>
    </div>

    <div class="option-card" onclick="openM('addM')">
      <div class="icon-box" style="background: rgba(0,229,255,0.1); color: var(--primary);"><i data-lucide="plus"></i></div>
      <div><h4 style="margin:0">Add Money</h4><p style="margin:0; font-size:0.8rem; color:var(--text-dim)">Instant deposit</p></div>
    </div>

    <div class="option-card" onclick="openM('withdrawM')">
      <div class="icon-box" style="background: rgba(255,193,7,0.1); color: #ffc107;"><i data-lucide="arrow-up-right"></i></div>
      <div><h4 style="margin:0">Withdraw</h4><p style="margin:0; font-size:0.8rem; color:var(--text-dim)">UPI or Bank Transfer</p></div>
    </div>

    <h3 style="margin: 30px 0 15px;">Transaction History</h3>
    <div id="txnHistory"></div>
  </div>

  <div id="addM" class="modal-overlay" onclick="closeM(event, 'addM')">
    <div class="modal-box">
      <h3 style="margin-top:0">Deposit</h3>
      <input type="number" id="depositAmt" class="input-field" placeholder="Enter Amount">
      <button id="checkoutBtn" class="action-btn" onclick="startCashfree()">PROCEED TO PAY</button>
    </div>
  </div>

  <div id="withdrawM" class="modal-overlay" onclick="closeM(event, 'withdrawM')">
    <div class="modal-box">
      <h3 style="margin-top:0">Withdraw Funds</h3>
      
      <div style="display:flex; gap:10px; margin-bottom:20px;">
        <button id="upiTab" class="tab-btn active" onclick="switchTab('upi')">UPI</button>
        <button id="bankTab" class="tab-btn" onclick="switchTab('bank')">Bank</button>
      </div>

      <input type="number" id="w_amount" class="input-field" placeholder="Amount (Min ₹100)">
      <input type="text" id="w_name" class="input-field" placeholder="Full Name">

      <div id="upiFields">
        <input type="text" id="w_upi" class="input-field" placeholder="UPI ID (e.g. name@apl)">
      </div>

      <div id="bankFields" style="display:none">
        <input type="text" id="w_acc" class="input-field" placeholder="Account Number">
        <input type="text" id="w_ifsc" class="input-field" placeholder="IFSC Code">
        <input type="text" id="w_bankname" class="input-field" placeholder="Bank Name">
      </div>

      <button class="action-btn" onclick="submitWithdraw()">SUBMIT REQUEST</button>
    </div>
  </div>

  <div id="toast"></div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBGfgy9OeMTJ__oOAFxoBW-eIOYlvhObZM",
      authDomain: "sharky-chat-007.firebaseapp.com",
      projectId: "sharky-chat-007",
      storageBucket: "sharky-chat-007.appspot.com",
      messagingSenderId: "637104796242",
      appId: "1:637104796242:web:74ac36b86af91be15ea58b"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const functions = firebase.functions();
    const cashfree = Cashfree({ mode: "production" });

    let myUid = "";
    let currentMethod = "upi";

    lucide.createIcons();

    function showT(m) {
      const t = document.getElementById('toast');
      t.innerText = m; t.style.display = 'block';
      setTimeout(() => t.style.display = 'none', 3000);
    }

    window.openM = (id) => document.getElementById(id).style.display = 'flex';
    window.closeM = (e, id) => { if(e.target.id === id) document.getElementById(id).style.display = 'none'; };

    function switchTab(type) {
      currentMethod = type;
      document.getElementById('upiTab').classList.toggle('active', type === 'upi');
      document.getElementById('bankTab').classList.toggle('active', type === 'bank');
      document.getElementById('upiFields').style.display = type === 'upi' ? 'block' : 'none';
      document.getElementById('bankFields').style.display = type === 'bank' ? 'block' : 'none';
    }

    async function submitWithdraw() {
      const amt = parseInt(document.getElementById('w_amount').value);
      const name = document.getElementById('w_name').value;
      
      if(!amt || amt < 100) return alert("Min withdrawal ₹100");
      if(!name) return alert("Enter account holder name");

      let details = { name, amount: amt, method: currentMethod };

      if(currentMethod === 'upi') {
        details.upi = document.getElementById('w_upi').value;
        if(!details.upi.includes('@')) return alert("Invalid UPI ID");
      } else {
        details.acc = document.getElementById('w_acc').value;
        details.ifsc = document.getElementById('w_ifsc').value;
        details.bank = document.getElementById('w_bankname').value;
        if(!details.acc || !details.ifsc) return alert("Fill all bank details");
      }

      try {
        await db.runTransaction(async (t) => {
          const wRef = db.collection("wallets").doc(myUid);
          const snap = await t.get(wRef);
          if(!snap.exists || (snap.data().realMoney || 0) < amt) throw "Insufficient Balance";

          t.update(wRef, { realMoney: firebase.firestore.FieldValue.increment(-amt) });
          
          const reqId = db.collection("withdrawals").doc().id;
          t.set(db.collection("withdrawals").doc(reqId), {
            ...details,
            uid: myUid,
            status: "pending",
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
          });

          t.set(db.collection("transactions").doc(), {
            uid: myUid,
            amount: amt,
            type: "withdrawal",
            title: `Payout (${currentMethod.toUpperCase()})`,
            status: "pending",
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
          });
        });

        showT("Withdrawal Request Submitted!");
        document.getElementById('withdrawM').style.display = 'none';
      } catch(e) { alert(e); }
    }

    function loadHistory(uid) {
      db.collection("transactions").where("uid", "==", uid).orderBy("timestamp", "desc").limit(15).onSnapshot(snap => {
        const h = document.getElementById('txnHistory');
        if(snap.empty) { h.innerHTML = "<p style='color:var(--text-dim)'>No transactions yet.</p>"; return; }
        
        h.innerHTML = "";
        snap.forEach(doc => {
          const d = doc.data();
          const isIn = d.type === "deposit";
          h.innerHTML += `
            <div class="history-item">
              <div>
                <div style="font-weight:600">${d.title}</div>
                <div style="font-size:0.7rem; color:var(--text-dim)">${d.status.toUpperCase()}</div>
              </div>
              <div style="font-family:'IBM Plex Mono'; font-weight:700; color:${isIn ? 'var(--primary)' : '#fff'}">
                ${isIn ? '+' : '-'}₹${d.amount}
              </div>
            </div>`;
        });
      });
    }

    auth.onAuthStateChanged(user => {
      if(!user) return location.href = "login.html";
      myUid = user.uid;
      db.collection("wallets").doc(myUid).onSnapshot(doc => {
        const bal = doc.exists ? (doc.data().realMoney || 0) : 0;
        document.getElementById('mainBalance').innerText = "₹" + bal.toLocaleString();
      });
      loadHistory(myUid);
    });

    async function startCashfree() {
      const amt = document.getElementById('depositAmt').value;
      if(!amt || amt < 1) return alert("Enter valid amount");
      try {
        const createOrder = functions.httpsCallable('createCashfreeOrder');
        const result = await createOrder({ amount: amt, uid: myUid });
        cashfree.checkout({ paymentSessionId: result.data.payment_session_id, redirectTarget: "_self" });
      } catch(e) { alert("Error: " + e.message); }
    }
  </script>
</body>
</html>