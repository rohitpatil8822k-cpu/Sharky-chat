<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Sharky Chat â€” Wallet</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0,user-scalable=no" />
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6924983412433035"
     crossorigin="anonymous"></script>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Roboto:wght@400;500;700&family=Poppins:wght@600;700&family=Inter:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    html,body {
      background: #0f172a;
      color: #e0f2fe;
      font-family: 'Roboto', Arial, sans-serif;
      min-height: 100vh;
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      overflow-x: hidden;
      scroll-behavior: smooth;
      user-select: none;
    }
    main {
      padding: 90px 16px 40px; /* accommodate fixed header */
      max-width: 420px;
      margin: 0 auto;
      box-sizing: border-box;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      user-select: text;
    }
    .wallet-block {
      width: 100%;
      padding: 36px 24px 22px;
      border-radius: 20px;
      background: #182338;
      box-shadow: 0 8px 32px #151a2540;
      margin: 48px auto 0;
      transition: background 0.3s ease;
      box-sizing: border-box;
      max-width: 420px;
      min-width: 320px;
    }
    .wallet-block:hover {
      background: #1c2748;
    }
    .wallet-block h2 {
      font-size: 1.36rem;
      font-weight: 800;
      text-align: center;
      margin-bottom: 20px;
      color: #60a5fa;
      text-shadow: 0 0 10px #60a5faaa;
    }
    .coins-list {
      display: flex;
      justify-content: center;
      gap: 36px;
      flex-wrap: nowrap;
      padding-bottom: 16px;
      border-bottom: solid 1px #1f2f57;
      box-sizing: border-box;
    }
    .coin-display {
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 110px;
      transition: transform 0.28s ease;
      cursor: default;
      box-sizing: border-box;
    }
    .coin-display:hover {
      transform: scale(1.08);
    }
    .coin-img {
      width: 72px;
      height: 72px;
      border-radius: 50%;
      border: 3px solid #38bdf8;
      box-shadow: 0 2px 14px #38bdf86e;
      background: linear-gradient(145deg, #1f2d4f 0%, #0f172a 100%);
      transition: box-shadow 0.3s ease;
    }
    .coin-img:hover {
      box-shadow: 0 2px 24px #33b8ffcc;
    }
    .coin-label {
      font-size: 1.1rem;
      color: #bae6fd;
      font-weight: 600;
      margin-top: 14px;
      user-select: none;
      font-family: 'Poppins', Arial, sans-serif;
    }
    .coin-count {
      font-size: 1.3rem;
      font-weight: 700;
      padding: 10px 28px;
      border-radius: 16px;
      background: #23304b;
      color: #60a5fa;
      margin-top: 8px;
      font-family: 'Orbitron', monospace;
      user-select: none;
      box-shadow: inset 0 0 12px #53a9faaa;
      transition: background 0.25s ease;
    }
    .missions-container {
      margin: 32px auto 0;
      background: #20325b;
      border-radius: 16px;
      padding: 24px 20px;
      box-shadow: 0 10px 32px #14223965;
      transition: background 0.3s ease;
      box-sizing: border-box;
      max-width: 420px;
      min-width: 320px;
    }
    .missions-container:hover {
      background: #264270;
    }
    .missions-container h3 {
      font-size: 1.4rem;
      margin-bottom: 20px;
      text-align: center;
      color: #68bafc;
      font-weight: 800;
      letter-spacing: 0.06em;
      font-family: 'Poppins', sans-serif;
    }
    .mission-item {
      background: #192642;
      border-radius: 14px;
      padding: 16px 20px;
      font-size: 1.1rem;
      margin-bottom: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 1px 1px 10px #16203c66;
      transition: background 0.22s ease;
      box-sizing: border-box;
    }
    .mission-item:hover:not(.claimed):not(.active) {
      background: #1e2d57;
      cursor: pointer;
    }
    .mission-item .claim-btn {
      background: #344763;
      color: #7fd5ff;
      border-radius: 16px;
      padding: 7px 20px;
      font-weight: 700;
      cursor: pointer;
      opacity: 0.7;
      border: none;
      outline: none;
      transition: background 0.3s ease, opacity 0.3s ease;
      font-family: 'Poppins', sans-serif;
      font-size: 1rem;
      user-select: none;
      box-shadow: 0 2px 12px #21467f9f;
      white-space: nowrap;
    }
    .mission-item.active .claim-btn {
      background: linear-gradient(98deg,#38bdf8 61%,#60a5fa 100%);
      color: #fff;
      opacity: 1;
      box-shadow: 0 0 18px #7ed0ffcc;
    }
    .mission-item.claimed .claim-btn {
      background: #213967;
      color: #a1a1aa;
      opacity: 0.85;
      cursor: not-allowed;
      box-shadow: none;
    }
    .reward {
      font-weight: 700;
      color: #b0daff;
      font-family: 'Orbitron', monospace;
      letter-spacing: 0.04em;
      user-select: none;
      white-space: nowrap;
    }
    .loss-msg {
      background: #25335c;
      color: #fda58e;
      font-weight: 700;
      text-align: center;
      border-radius: 14px;
      margin: 24px auto 12px;
      padding: 14px 15px;
      max-width: 400px;
      font-size: 1rem;
      font-family: 'Poppins', sans-serif;
      box-shadow: 0 2px 16px #ff887737;
      user-select: none;
    }
    .congrats-popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: linear-gradient(105deg,#42bafe 60%,#89f8ff 100%);
      color: #232b47;
      border-radius: 22px;
      box-shadow: 0 8px 44px #1e293b88;
      font-size: 1.4rem;
      font-weight: 900;
      padding: 32px 26px;
      display: none;
      flex-direction: column;
      align-items: center;
      z-index: 9999;
      font-family: 'Orbitron', monospace;
      user-select: none;
      max-width: 320px;
      text-align: center;
    }
    .congrats-popup .popup-close {
      position: absolute;
      top: 12px;
      right: 16px;
      font-size: 1.8rem;
      border: none;
      background: none;
      cursor: pointer;
      color: #16224fdd;
      font-weight: 900;
      transition: color 0.2s ease;
      user-select: none;
    }
    .congrats-popup .popup-close:hover {
      color: #002b7a;
    }
    .congrats-emoji {
      font-size: 3.2rem;
      margin-bottom: 18px;
      user-select: none;
      animation: bounce 1.3s ease infinite;
    }
    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-8px); }
    }
    @media (max-width: 440px) {
      main {
        max-width: 100%;
        padding: 90px 12px 32px;
      }
      .wallet-block,
      .missions-container {
        min-width: auto;
        max-width: 100%;
        padding: 28px 16px 18px;
        margin: 32px auto 0;
        border-radius: 16px;
      }
      .coins-list {
        gap: 18px;
      }
      .coin-display {
        width: 90px;
      }
      .coin-img {
        width: 56px;
        height: 56px;
      }
      .coin-label {
        font-size: 1rem;
      }
      .coin-count {
        font-size: 1.15rem;
        padding: 8px 22px;
        border-radius: 14px;
      }
      .missions-container h3 {
        font-size: 1.2rem;
        margin-bottom: 18px;
      }
      .mission-item {
        font-size: 0.95rem;
        padding: 12px 14px;
      }
      .mission-item .claim-btn {
        padding: 5px 14px;
        font-size: 0.9rem;
        border-radius: 14px;
      }
      .reward {
        font-size: 0.95rem;
      }
      .congrats-popup {
        font-size: 1.1rem;
        padding: 24px 18px;
        max-width: 270px;
      }
      .congrats-emoji {
        font-size: 2.6rem;
        margin-bottom: 14px;
      }
    }

    /* HEADER CSS copied exactly from header.html */
    header {
      background: #182338;
      position: fixed;
      top: 0;
      left: 0;
      z-index: 2000;
      width: 100vw;
      box-shadow: 0 2px 17px #10162325;
      min-height: 50px;
      user-select: none;
      transition: box-shadow 0.23s;
      color: #80caff;
      font-family: "Poppins", Arial, sans-serif;
    }
    .header-inner {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 16px;
      min-height: 50px;
      position: relative;
      z-index: 1;
      font-size: 1.02rem;
      color: inherit;
    }
    .logo-container {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .logo-container img {
      height: 25px;
      animation: float 3.3s ease-in-out infinite;
      user-select: none;
      pointer-events: none;
    }
    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-4px); }
    }
    .logo-text {
      font-family: "Orbitron", Arial, Helvetica, sans-serif;
      font-size: 1.02rem;
      color: #60a5fa;
      text-shadow: 0 0 7px #60a5fa74;
      font-weight: 800;
      letter-spacing: 0.055em;
      user-select: none;
    }
    .menu-btn {
      font-size: 1.5rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      min-width: 38px;
      height: 36px;
      color: #80caff;
      outline: none;
      border: none;
      background: none;
      border-radius: 9px;
      position: relative;
      transition: background 0.16s, transform 0.2s;
      user-select: none;
    }
    .menu-btn:active {
      background: #20325c;
      transform: scale(0.93);
    }
    .menu-btn .notif-badge {
      background: linear-gradient(105deg, #f87171 65%, #fb923c 110%);
      color: white;
      font-weight: 700;
      font-family: "Orbitron", monospace;
      min-width: 12px;
      height: 12px;
      padding: 0 6px;
      font-size: 12px;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      position: absolute;
      top: 1px;
      right: 1px;
      border: 1px solid #182338;
      box-shadow: 0 2px 6px #ef444488;
      pointer-events: none;
      z-index: 10;
      user-select: none;
    }
    .menu-dropdown {
      position: fixed;
      top: 0;
      right: -100%;
      height: 100vh;
      width: 220px;
      background: rgba(21, 33, 58, 0.97);
      box-shadow: -4px 0 26px rgba(0, 0, 0, 0.77);
      padding-top: 54px;
      padding-bottom: 22px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      font-family: "Poppins", Arial, sans-serif;
      font-weight: 600;
      font-size: 0.85rem;
      overflow-y: auto;
      transition: right 0.31s cubic-bezier(0.65, 0.01, 0.32, 1.03);
      z-index: 2500;
      user-select: none;
    }
    header.expanded .menu-dropdown {
      right: 0;
    }
    .menu-dropdown .close-btn {
      position: absolute;
      left: 11px;
      top: 13px;
      background: transparent;
      border: none;
      cursor: pointer;
      padding: 0;
      outline: none;
      z-index: 2600;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.2s ease;
      color: #60a5fa;
      user-select: none;
    }
    .menu-dropdown .close-btn:hover,
    .menu-dropdown .close-btn:focus {
      color: #a78bfa;
      transform: scale(1.22);
    }
    .menu-dropdown .close-btn svg {
      width: 22px;
      height: 22px;
      stroke: currentColor;
      stroke-width: 2.5;
      stroke-linecap: round;
      stroke-linejoin: round;
      user-select: none;
    }
    .menu-dropdown a {
      color: #60a5fa;
      padding: 13px 17px 13px 46px;
      text-decoration: none;
      border-bottom: 2px solid #20325c;
      display: flex;
      align-items: center;
      gap: 15px;
      background: none;
      transition: background 0.13s, color 0.13s, padding-left 0.11s, transform 0.16s;
      letter-spacing: 0.02em;
      user-select: none;
      font-weight: 600;
      font-size: 0.85rem;
      will-change: transform;
      position: relative;
    }
    .menu-dropdown a:hover,
    .menu-dropdown a:focus {
      background: #213967;
      color: #fff;
      padding-left: 51px;
      outline: none;
      transform: scale(1.05) translateX(-2px);
    }
    .menu-dropdown a:active {
      background: #09196a;
      color: #fbbf24;
      transform: scale(0.97);
    }
    .menu-dropdown .notif-badge {
      position: static;
      margin-left: 7px;
      box-shadow: none;
      border: none;
      font-weight: 700;
      font-family: "Orbitron", monospace;
      font-size: 13px;
      min-width: 22px;
      height: 18px;
      background: linear-gradient(120deg, #fae024 70%, #f87171 100%);
      color: #222b3a;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 7px;
      user-select: none;
    }
    .menu-dropdown a .icon {
      display: inline-flex;
      width: 22px;
      height: 22px;
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      fill: #60a5fa;
      filter: drop-shadow(0 1px 6px #60a5fa66);
      transition: fill 0.13s, filter 0.11s;
      user-select: none;
    }
    .menu-dropdown a:hover .icon,
    .menu-dropdown a:focus .icon {
      fill: #fff;
      filter: drop-shadow(0 2px 8px #fff4);
    }

    body.light-theme {
      background: #f5f6fa;
      color: #222c3b;
    }
    body.light-theme header {
      background: #eaf0fb;
      color: #222c3b;
    }
    body.light-theme .logo-text {
      color: #1d4ed8;
      text-shadow: 0 0 8px #60a5fa60;
    }
    body.light-theme .menu-btn {
      color: #2563eb;
    }
    body.light-theme .menu-dropdown {
      background: rgba(234, 240, 251, 0.94);
      color: #1e293b;
      box-shadow: -4px 0 24px rgba(16, 24, 39, 0.09);
    }
    body.light-theme .menu-dropdown a {
      color: #2563eb;
      border-bottom: 1px solid #bfdbfe;
    }
    body.light-theme .menu-dropdown a:hover,
    body.light-theme .menu-dropdown a:focus {
      background: #dbeafe;
      color: #1e293b;
    }
    body.light-theme .menu-dropdown a:active {
      background: #dbeafe;
      color: #eab308;
    }
    body.light-theme .menu-dropdown .close-btn {
      color: #2563eb;
    }
    body.light-theme .menu-dropdown .close-btn:hover,
    body.light-theme .menu-dropdown .close-btn:focus {
      color: #a78bfa;
    }
    @keyframes notifpop {
      0% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.18) rotate(-3deg);
      }
      100% {
        transform: scale(1) rotate(0deg);
      }
    }
  </style>
</head>
<body>
  <header id="mainHeader">
    <div class="header-inner">
      <div class="logo-container">
        <img src="https://firebasestorage.googleapis.com/v0/b/sharky-chat-007.firebasestorage.app/o/gc-logo.png?alt=media&token=ddfe6e46-7351-4a07-8140-ea702b1bd823" alt="Sharky Logo" />
        <div class="logo-text">SHARKY CHAT</div>
      </div>
      <button class="menu-btn" id="menuBtn" type="button" aria-label="Toggle menu">
        â˜°
        <span class="notif-badge" id="menuNotif" style="display:none;">0</span>
      </button>
    </div>
    <nav class="menu-dropdown" role="menu" aria-label="Main Navigation">
      <button class="close-btn" aria-label="Close menu" title="Close menu">
        <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
          <line x1="18" y1="6" x2="6" y2="18" />
          <line x1="6" y1="6" x2="18" y2="18" />
        </svg>
      </button>
      <a href="profile.html" role="menuitem"><span class="icon"><svg viewBox="0 0 32 32"><circle cx="16" cy="12" r="7"/><ellipse cx="16" cy="23.5" rx="12" ry="6.5"/></svg></span>Profile</a>
      <a href="chatrooms.html" role="menuitem"><span class="icon"><svg viewBox="0 0 32 32"><rect x="2" y="8" width="28" height="16" rx="5"/><rect x="12" y="6" width="8" height="4" rx="2"/><circle cx="7" cy="12" r="2"/><circle cx="25" cy="12" r="2"/></svg></span>Chat Rooms</a>
      <a href="friends.html" role="menuitem">
        <span class="icon"><svg viewBox="0 0 32 32"><circle cx="10" cy="12" r="5"/><circle cx="22" cy="12" r="5"/><ellipse cx="16" cy="23" rx="12" ry="6"/></svg></span>Friends
        <span id="friends-notif" class="notif-badge" style="display:none;">0</span>
      </a>
      <a href="add-friends.html" role="menuitem"><span class="icon"><svg viewBox="0 0 32 32"><circle cx="15" cy="13" r="7"/><rect x="23" y="19" width="9" height="3" rx="1.5"/><rect x="26" y="16" width="3" height="9" rx="1.5"/></svg></span>Add Friend</a>
      <a href="inbox.html" role="menuitem">
        <span class="icon"><svg viewBox="0 0 32 32"><rect x="4" y="8" width="24" height="16" rx="4"/><polyline points="4,8 16,18 28,8" fill="none" stroke="#60a5fa" stroke-width="2"/></svg></span>Messages
        <span id="messages-notif" class="notif-badge" style="display:none;">0</span>
      </a>
      <a href="wallet.html" role="menuitem">
        <span class="icon"><svg viewBox="0 0 32 32"><rect x="4" y="10" width="24" height="12" rx="3"/><ellipse cx="24" cy="16" rx="2" ry="2"/><rect x="6" y="13" width="20" height="4" rx="2"/><circle cx="17" cy="16" r="2" fill="#fff"/></svg></span>Wallet
        <span id="wallet-notif" class="notif-badge" style="display:none;">0</span>
      </a>
      <a href="shop.html" role="menuitem"><span class="icon"><svg viewBox="0 0 32 32"><rect x="6" y="13" width="20" height="9" rx="3"/><rect x="12" y="7" width="8" height="6" rx="2"/><rect x="13" y="22" width="6" height="4" rx="2"/><circle cx="10" cy="26" r="2"/><circle cx="22" cy="26" r="2"/></svg></span>Shop</a>
      <a href="inventory.html" role="menuitem"><span class="icon"><svg viewBox="0 0 32 32"><rect x="7" y="10" width="18" height="12" rx="3"/><rect x="11" y="6" width="10" height="4" rx="2"/><rect x="13" y="22" width="6" height="4" rx="2"/><path d="M7 22h18"/><circle cx="16" cy="18" r="2"/></svg></span>Inventory</a>
      <a href="news.html" role="menuitem"><span class="icon"><svg viewBox="0 0 32 32"><rect x="5" y="7" width="22" height="18" rx="4"/><rect x="9" y="11" width="14" height="2" rx="1"/><rect x="9" y="16" width="8" height="2" rx="1"/><circle cx="10" cy="21" r="2"/><rect x="14" y="20" width="7" height="2" rx="1"/></svg></span>News</a>
      <a href="level.html" role="menuitem"><span class="icon"><svg viewBox="0 0 32 32"><path d="M16 5v17" stroke="#6699ff" stroke-width="2.5" stroke-linecap="round"/><circle cx="16" cy="26" r="5" fill="#38bdf8" stroke="#bae6fd" stroke-width="1.5"/><rect x="11" y="13" width="10" height="4" rx="2" fill="#bae6fd" /><rect x="13" y="8" width="6" height="3" rx="1.5" fill="#60a5fa"/></svg></span>Level</a>
      <a href="refer.html" role="menuitem"><span class="icon"><svg viewBox="0 0 32 32"><circle cx="16" cy="16" r="13" fill="#5eead4" /><path d="M22.5,14h-8.7l3-3m-2.8,8a3,3,0,1,0-3,-3" stroke="#262626" stroke-width="2.3" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg></span>Refer A Friend</a>
      <a href="verify-email.html" role="menuitem"><span class="icon"><svg viewBox="0 0 32 32"><rect x="5" y="8" width="22" height="16" rx="5"/><polyline points="5,8 16,18 27,8" fill="none" stroke="#2dd4bf" stroke-width="2"/><circle cx="16" cy="19" r="2.5"/></svg></span>Email Verification</a>
      <a href="help.html" role="menuitem"><span class="icon"><svg viewBox="0 0 32 32"><circle cx="16" cy="16" r="12" fill="none" stroke="#fbbf24" stroke-width="2"/><text x="16" y="20" text-anchor="middle" fill="#fbbf24" font-size="8" font-family="Orbitron">?</text></svg></span>Help</a>
      <a href="social-media.html" role="menuitem"><span class="icon"><svg viewBox="0 0 32 32"><circle cx="8" cy="12" r="3"/><circle cx="24" cy="12" r="3"/><circle cx="16" cy="22" r="3"/><line x1="8" y1="15" x2="16" y2="19" stroke="#60a5fa" stroke-width="2"/><line x1="24" y1="15" x2="16" y2="19" stroke="#60a5fa" stroke-width="2"/></svg></span>Social Media</a>
      <a href="#" id="themeSwitch" role="menuitem"><span class="icon"><svg viewBox="0 0 32 32"><circle cx="16" cy="16" r="12"/><path d="M16 4v8"/><circle cx="16" cy="16" r="5" fill="#fff"/></svg></span>Change Theme</a>
    </nav>
  </header>

  <main>
    <div class="wallet-block">
      <h2>Your Wallet</h2>
      <div class="coins-list">
        <div class="coin-display">
          <img src="https://user-gen-media-assets.s3.amazonaws.com/gpt4o_images/2fcd666d-0c17-4861-bd36-3f7ff94e242c.png" class="coin-img" alt="Sharky Coin" />
          <div class="coin-label">Sharky Coin</div>
          <div class="coin-count" id="sharkyCoinCount">0</div>
        </div>
        <div class="coin-display">
          <img src="https://user-gen-media-assets.s3.amazonaws.com/gpt4o_images/7b852f75-8330-4a86-8c7c-f528de84c4de.png" class="coin-img" alt="Sharky Gold" />
          <div class="coin-label">Sharky Gold</div>
          <div class="coin-count" id="sharkyGoldCount">0</div>
        </div>
      </div>
    </div>

    <section class="missions-container">
      <h3>Daily Login Streak Rewards</h3>
      <div id="lossMsg" class="loss-msg" style="display:none;"></div>
      <div id="loginStreakMission"></div>
    </section>
  </main>

  <div id="congratsPopup" class="congrats-popup" role="alert" aria-live="assertive">
    <button class="popup-close" aria-label="Close notification" onclick="document.getElementById('congratsPopup').style.display='none'">&times;</button>
    <div class="congrats-emoji">ðŸŽ‰</div>
    <div id="popupContent"></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, onSnapshot,
      collection, query, where, getDocs, updateDoc
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBGfgy9OeMTJ__oOAFxoBW-eIOYlvhObZM",
      authDomain: "sharky-chat-007.firebaseapp.com",
      projectId: "sharky-chat-007",
      storageBucket: "sharky-chat-007.appspot.com",
      messagingSenderId: "637104796242",
      appId: "1:637104796242:web:74ac36b86af91be15ea58b",
      measurementId: "G-HT9T3P9KST"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let uid = "", myUsername = "", todayStr = (new Date()).toISOString().split('T')[0];

    // Badge animation helper functions from header.html logic
    function bumpBadge(el) {
      if (!el) return;
      el.style.animation = "";
      setTimeout(() => {
        el.style.animation = "notifpop .34s";
      }, 25);
    }
    function bumpBadgeDropdown(el) {
      if (!el) return;
      el.style.animation = "";
      setTimeout(() => {
        el.style.animation = "notifpop .33s";
      }, 30);
    }

    // Setup notification badges as per header.html logic
    function setupMenuNotifications(uid, username) {
      onSnapshot(
        query(collection(db, "friendRequests"), where("to", "==", uid), where("status", "==", "pending")),
        (snap) => {
          const frCount = snap.size;
          const menuNotif = document.getElementById("menuNotif");
          const friendsNotif = document.getElementById("friends-notif");
          const messagesNotif = document.getElementById("messages-notif");
          let msgCount = parseInt(messagesNotif?.dataset?.count) || 0;

          menuNotif.dataset.fr = frCount;
          if(friendsNotif) {
            friendsNotif.textContent = frCount > 99 ? "99+" : frCount;
            friendsNotif.style.display = frCount > 0 ? "inline-flex" : "none";
            bumpBadgeDropdown(friendsNotif);
          }

          const total = frCount + msgCount;
          menuNotif.textContent = total > 99 ? "99+" : total;
          menuNotif.style.display = total > 0 ? "inline-flex" : "none";
          bumpBadge(menuNotif);
        }
      );
    }

    async function setupMessageNotifications(uid, username) {
      const friendsDoc = await getDocs(collection(db, "friends"));
      let myFriends = [];
      friendsDoc.forEach((docSnap) => {
        if (docSnap.id === uid && docSnap.data()) myFriends = Object.keys(docSnap.data());
      });
      if (!myFriends.length) return;
      let unseenTracker = {};
      let usernamesData = {};
      let snap = await getDocs(
        query(collection(db, "users"), where("__name__", "in", myFriends.slice(0, 10)))
      );
      snap.forEach((d) => {
        usernamesData[d.id] = d.data().username;
      });
      if (myFriends.length > 10) {
        for (let i = 10; i < myFriends.length; i += 10) {
          let s = await getDocs(
            query(collection(db, "users"), where("__name__", "in", myFriends.slice(i, i + 10)))
          );
          s.forEach((d) => {
            usernamesData[d.id] = d.data().username;
          });
        }
      }
      for (const fid of myFriends) {
        const friendUsername = usernamesData[fid];
        if (!friendUsername || friendUsername === username) continue;
        const chatId = [username, friendUsername].sort().join("_");
        const msgRef = collection(db, "personalMessages", chatId, "messages");
        onSnapshot(
          query(msgRef, where("recipient", "==", username), where("seen", "==", false)),
          (snap) => {
            let unseen = 0;
            snap.forEach((doc) => {
              if (doc.data().sender !== username) unseen++;
            });
            unseenTracker[chatId] = unseen;
            updateBadges();
          }
        );
      }
      function updateBadges() {
        let totalUnseen = Object.values(unseenTracker).reduce((a, b) => a + b, 0);
        const messagesNotif = document.getElementById("messages-notif");
        const menuNotif = document.getElementById("menuNotif");
        const friendsNotif = document.getElementById("friends-notif");

        if(messagesNotif){
          messagesNotif.dataset.count = totalUnseen;
          messagesNotif.textContent = totalUnseen > 99 ? "99+" : totalUnseen;
          messagesNotif.style.display = totalUnseen > 0 ? "inline-flex" : "none";
          bumpBadge(messagesNotif);
        }

        const frCount = parseInt(menuNotif.dataset.fr) || 0;
        const sum = frCount + totalUnseen;

        menuNotif.textContent = sum > 99 ? "99+" : sum;
        menuNotif.style.display = sum > 0 ? "inline-flex" : "none";

        bumpBadge(menuNotif);
      }
    }

    function updateWalletBadge(show) {
      const walletNotif = document.getElementById("wallet-notif");
      if (!walletNotif) return;
      if (show) {
        walletNotif.textContent = "!";
        walletNotif.style.display = "inline-flex";
        bumpBadgeDropdown(walletNotif);
      } else {
        walletNotif.style.display = "none";
        walletNotif.textContent = "0";
      }
    }

    function setupWalletNotifications(uid) {
      const notifCol = collection(db, "notifications");
      const notifQuery = query(
        notifCol,
        where("to", "==", uid),
        where("type", "==", "walletClaim"),
        where("seen", "==", false)
      );
      onSnapshot(notifQuery, (snapshot) => {
        updateWalletBadge(!snapshot.empty);
      });
    }

    // Wallet mission & claim logic
    function showCongratsPopup(day) {
      const popup = document.getElementById("congratsPopup");
      const content = document.getElementById("popupContent");
      content.textContent = `You claimed reward for ${day} day streak`;
      popup.style.display = "flex";
      setTimeout(() => popup.style.display = "none", 2500);
    }

    function getLoginStreakRewards(days) {
      let rewards = [];
      for(let d=1; d<=days; d++){
        if(d===10) rewards.push({day:d,type:"gold",val:1,label:"Sharky Gold"});
        else rewards.push({day:d,type:"coin",val:d,label:"Sharky Coin"});
      }
      return rewards;
    }

    function renderLoginMissions(streak, claimedToday) {
      const container = document.getElementById("loginStreakMission");
      container.innerHTML = "";
      const rewards = getLoginStreakRewards(10);
      rewards.forEach(r => {
        const item = document.createElement("div");
        item.className = "mission-item";
        const complete = (streak > r.day || (streak === r.day && claimedToday));
        const active = (!claimedToday && streak === r.day);
        if(complete) item.classList.add("claimed");
        else if(active) item.classList.add("active");
        const text = (streak === r.day) ? `Today: ${r.day} day streak` : `Day ${r.day}`;
        const btn = document.createElement("button");
        btn.className = "claim-btn";
        btn.textContent = complete ? "Claimed" : "Claim";
        btn.disabled = !active;
        if(active) btn.onclick = () => claimLoginReward(r.day);
        item.innerHTML = `<span>${text}</span><span class="reward">+${r.val} ${r.label}</span>`;
        item.appendChild(btn);
        container.appendChild(item);
      });
    }

    async function claimLoginReward(day) {
      const streakRef = doc(db,"streaks",uid);
      const walletRef = doc(db,"wallets",uid);
      const missionRef = doc(db,"missions",uid);
      const reward = getLoginStreakRewards(10)[day - 1];

      const snap = await getDoc(walletRef);
      const walletData = snap.exists() ? snap.data() : {sharkyCoin:0, sharkyGold:0};
      if(reward.type === "coin") walletData.sharkyCoin = (walletData.sharkyCoin||0) + reward.val;
      else walletData.sharkyGold = (walletData.sharkyGold||0) + reward.val;

      await setDoc(walletRef, walletData, {merge:true});
      await setDoc(missionRef, {loginStreakLastClaim: todayStr}, {merge:true});
      await setDoc(streakRef, {count: day, lastLogin: todayStr, lastClaim: todayStr}, {merge:true});

      renderLoginMissions(day, true);
      showCongratsPopup(day);

      await markWalletNotificationsSeen(uid);
    }

    async function markWalletNotificationsSeen(uid) {
      const notifCol = collection(db, "notifications");
      const q = query(
        notifCol,
        where("to", "==", uid),
        where("type", "==", "walletClaim"),
        where("seen", "==", false)
      );
      const querySnapshot = await getDocs(q);
      const updates = [];
      querySnapshot.forEach(docSnap => {
        updates.push(updateDoc(doc(db, "notifications", docSnap.id), {seen:true}));
      });
      await Promise.all(updates);
    }

    async function initMissions() {
      const streakRef = doc(db,"streaks",uid);
      const streakSnap = await getDoc(streakRef);
      let streak = 1, msgShow = false;
      let lastLogin = "";

      if(streakSnap.exists()) {
        lastLogin = streakSnap.data().lastLogin || "";
        streak = streakSnap.data().count || 1;
        const yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1);
        const ystr = yesterday.toISOString().split('T')[0];

        if(lastLogin === todayStr) {
          streak = streakSnap.data().count;
        } else if(lastLogin === ystr) {
          streak = streakSnap.data().count + 1;
        } else {
          streak = 1;
          msgShow = true;
        }
      }
      await setDoc(streakRef, {count: streak, lastLogin: todayStr}, {merge:true});
      const lossMsg = document.getElementById("lossMsg");
      lossMsg.style.display = msgShow ? "block" : "none";
      if(msgShow) lossMsg.textContent = "You lost your streak! Reset to Day 1.";

      const missionRef = doc(db, "missions", uid);
      const missionSnap = await getDoc(missionRef);
      const claimedToday = missionSnap.exists() && missionSnap.data().loginStreakLastClaim === todayStr;

      renderLoginMissions(streak, claimedToday);

      onSnapshot(doc(db, "wallets", uid), snap => {
        const data = snap.exists() ? snap.data() : {sharkyCoin:0, sharkyGold:0};
        document.getElementById("sharkyCoinCount").textContent = data.sharkyCoin || 0;
        document.getElementById("sharkyGoldCount").textContent = data.sharkyGold || 0;
      });
    }

    onAuthStateChanged(auth, async (user) => {
      if(!user) {
        location.href = "login.html";
        return;
      }
      uid = user.uid;
      // Fetch username for notifications setup
      const userSnap = await getDoc(doc(db,"users",uid));
      myUsername = userSnap.exists() && userSnap.data().username ? userSnap.data().username : "";

      setupMenuNotifications(uid, myUsername);
      setupMessageNotifications(uid, myUsername);
      setupWalletNotifications(uid);

      initMissions();
    });

    // Header menu toggle
    const mainHeader = document.getElementById("mainHeader");
    document.getElementById("menuBtn").addEventListener("click", (e) => {
      mainHeader.classList.toggle("expanded");
      e.stopPropagation();
    });
    document.querySelector(".menu-dropdown .close-btn").addEventListener("click", (e) => {
      mainHeader.classList.remove("expanded");
      e.stopPropagation();
    });
    document.addEventListener("click", (e) => {
      if (!mainHeader.contains(e.target)) mainHeader.classList.remove("expanded");
    });
    document.querySelector(".menu-dropdown").addEventListener("click", (e) => {
      if (e.target.tagName === "A") mainHeader.classList.remove("expanded");
    });

    // Theme toggler
    const themeSwitch = document.getElementById("themeSwitch");
    function setTheme(theme) {
      if (theme === "light") {
        document.body.classList.add("light-theme");
        localStorage.setItem("sharky-chat-theme", "light");
      } else {
        document.body.classList.remove("light-theme");
        localStorage.setItem("sharky-chat-theme", "dark");
      }
    }
    function toggleTheme() {
      if(document.body.classList.contains("light-theme")) {
        setTheme("dark");
      } else {
        setTheme("light");
      }
    }
    themeSwitch.addEventListener("click", (e) => {
      e.preventDefault();
      toggleTheme();
    });
    (() => {
      const savedTheme = localStorage.getItem("sharky-chat-theme");
      if(savedTheme === "light") {
        setTheme("light");
      } else {
        setTheme("dark");
      }
    })();
  </script>
</body>
</html>
