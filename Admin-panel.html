<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Sharky Admin Panel</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron&family=Roboto&display=swap" rel="stylesheet"/>
  <style>
    body {background:linear-gradient(110deg,#1a223d 40%,#273c68 100%);
      color: #e2eaf3; font-family: "Roboto",sans-serif; margin:0; min-height:100vh;}
    header {
      background: #212d48;
      color: #60a5fa;
      padding: 0 20px;
      height: 58px;
      font-family: 'Orbitron', sans-serif;
      font-size: 1.19rem;
      display: flex; align-items: center; box-shadow: 0 2px 17px #08112948;
      font-weight: 600; letter-spacing:.08em;
    }
    .brand-logo { height:31px; margin-right:11px;}
    main {
      display: flex; flex-direction:column; align-items:center;
      width: 100vw; max-width: 700px; margin:0 auto; min-height:86vh;
    }
    .searchbar-section {width:100%;max-width:430px;display:flex;flex-direction:column;gap:13px; margin-top:30px; position:relative;}
    .user-search-bar {
      width: 100%; font-size: 1.08rem; border-radius: 10px; border:none;
      background: #24345a; color: #dbeafe; padding: 13px 15px;
      outline: none; border: 1.2px solid #23314240; margin-bottom:2px;
      transition: border .13s, box-shadow .18s;
    }
    .user-search-bar:focus { border-color: #38bdf8;}
    .search-dropdown {background:#162440;border-radius:13px;box-shadow:0 8px 28px #111c3939;margin-top:2px;padding:9px 0;
      max-height:210px; overflow-y:auto; z-index: 22; position:relative;}
    .search-res {
      display: flex; align-items: center; gap: 10px;
      cursor: pointer; padding:9px 18px; font-size:1.06rem;
      color: #acd8fd; border-radius:7px; transition:background .12s;
    }
    .search-res:hover { background: #233264; color: #fff;}
    .search-avatar {width:32px;height:32px; border-radius:50%;border:2px solid #38bdf8;}
    .action-row {display: flex; gap:7px; margin-top:4px;}
    .adm-btn {
      border:none;background:#314060;font-weight:700;font-size:.99rem;color:#c6dbff;border-radius:8px;
      padding:6px 15px;cursor:pointer;transition:background .13s;
    }
    .adm-btn.ban {background:#ef4444;color:#fff;}
    .adm-btn.kick {background:#facc15;color:#191924;}
    .adm-btn.mute {background:#60a5fa;color:#fff;}
    .adm-btn.unban,.adm-btn.unmute,.adm-btn.unkick {background:#34d399;color:#1a223d;font-size:.97rem;}
    .adm-btn[disabled] {opacity:.55;}
    .status-badges {margin-left: 14px;}
    .ban-badge, .mute-badge, .kick-badge {
      padding:2.2px 8px;border-radius:7px;font-size:.88em;font-weight:700; margin-left:2px;
    }
    .ban-badge { background:#ef4444;}
    .mute-badge { background:#38bdf8;}
    .kick-badge { background:#facc15; color:#223;}
    .chatroom-section {
      margin:36px auto 0 auto; width:100%;max-width:700px;
      background:rgba(35,40,72,0.97);
      padding:20px 12px 22px 12px;
      border-radius:16px; box-shadow:0 10px 48px #11183621;
      min-height:220px;
    }
    .room-title { font-family:'Orbitron',sans-serif;font-size:1.09rem;color:#60a5fa;margin-bottom:8px;}
    .room-list { display:flex; gap:8px;flex-wrap:wrap; margin-bottom:13px;}
    .room-btn {
      border:none; border-radius:7px 7px 0 0; background:#233264;
      color:#bae6fd; font-size:1.02rem; padding:5px 14px; font-weight:bold; cursor:pointer;
      transition:.13s; margin-bottom:-4px; outline:none;
    }
    .room-btn.selected {background:#60a5fa;color:#173154;}
    .room-btn:hover {background:#365d96;color:#fff;}
    .msgs-table {width:100%;border-collapse:collapse;margin-top:11px;}
    .msgs-table th,.msgs-table td {padding:6px 5px;border-bottom:1px solid #263053;background:inherit;}
    .msgs-table th{color:#60a5fa;background:#22335e;}
    .msgs-table td.actions{white-space:nowrap;}
    .delete-btn{background:#ef4444;color:#fff;border:none;border-radius:6px;padding:2.5px 12px;font-size:.95em;cursor:pointer;}
    .delete-btn:active{transform:scale(.95);}
    .status-panel-section {
      display:flex;gap:22px;justify-content:center;flex-wrap:wrap;margin-top:33px;
    }
    .status-panel {
      flex: 1 1 120px; background:#222d44;border-radius:13px;box-shadow:0 2px 10px #161a2899;padding:9px 13px 12px 13px;
    }
    .panel-title {
      font-family:'Orbitron',sans-serif;
      color:#38bdf8; font-size:1.01em; font-weight:bold; margin-bottom:7px; letter-spacing:.045em;}
    .status-panel ul { list-style:none; padding:0; margin:0;}
    .status-panel li { margin-bottom:5px; padding:4px 0; display:flex;align-items:center;gap:7px;font-size:.96rem;}
    .status-panel li .adm-btn {padding:3px 10px;}
    .popup-msg {
      position: fixed; top:60px; left:50%; transform:translateX(-50%);
      background: #16a34a; color: #fff; font-weight: bold;
      padding: 9px 24px; border-radius: 10px; font-size: 1.01em; z-index: 250;
      box-shadow: 0 3px 22px #16a34a33; display: none; animation: popfade .4s;
    }
    @keyframes popfade { from{opacity:0;transform:scale(.92)translateY(-11px);} to{opacity:1;transform:none;}}
    .popup-msg.error { background:#ef4444;}
    @media (max-width:700px){main,.chatroom-section{max-width:99vw;}}
    @media (max-width:500px){
      header{font-size:.98rem; height:48px;}
      .brand-logo{height:23px;}
      .panel-title,.room-title{font-size:.96em;}
      .chatroom-section{padding:10px 2vw;}
      .searchbar-section{max-width:99vw;}
    }
  </style>
</head>
<body>
  <header>
    <img src="https://firebasestorage.googleapis.com/v0/b/sharky-chat-007.firebasestorage.app/o/gc-logo.png?alt=media&token=ddfe6e46-7351-4a07-8140-ea702b1bd823" class="brand-logo" alt="Sharky Chat">
    Sharky Chat â€” Admin Panel
  </header>

  <main>
    <section class="searchbar-section">
      <input type="text" id="userSearchInput" class="user-search-bar" placeholder="Search username..." autocomplete="off">
      <div id="searchDropdown" class="search-dropdown" style="display:none"></div>
      <!-- userActionBar yahi append hoga -->
    </section>

    <section class="chatroom-section">
      <div class="room-title">Chat Rooms</div>
      <div class="room-list" id="roomList"></div>
      <table class="msgs-table" id="msgsTable" style="display:none;">
        <thead>
          <tr><th>User</th><th>Text</th><th>Time</th><th>Actions</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <section class="status-panel-section">
      <div class="status-panel">
        <div class="panel-title">Banned Users</div>
        <ul id="bannedList"></ul>
      </div>
      <div class="status-panel">
        <div class="panel-title">Muted Users</div>
        <ul id="mutedList"></ul>
      </div>
      <div class="status-panel">
        <div class="panel-title">Kicked Users</div>
        <ul id="kickedList"></ul>
      </div>
    </section>
    <div class="popup-msg" id="popupMsg"></div>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import {
      getFirestore,
      collection,
      getDocs,
      getDoc,
      doc,
      setDoc,
      deleteDoc,
      query,
      orderBy
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

    // ==== FIREBASE INIT ====
    const firebaseConfig = {
      apiKey: "AIzaSyBGfgy9OeMTJ__oOAFxoBW-eIOYlvhObZM",
      authDomain: "sharky-chat-007.firebaseapp.com",
      projectId: "sharky-chat-007",
      storageBucket: "sharky-chat-007.appspot.com",
      messagingSenderId: "637104796242",
      appId: "1:637104796242:web:74ac36b86af91be15ea58b"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // === POPUP ===
    function popup(msg,err){
      const p=document.getElementById("popupMsg");
      p.textContent=msg;
      p.className="popup-msg"+(err?" error":""); p.style.display="block";
      setTimeout(()=>{p.style.display="none";},1800);
    }
    function timeLeft(until){
      if(!until) return '';
      const now=Date.now(), diff=until-now;
      if(diff<=1) return "";
      const min=Math.floor(diff/60000), h=Math.floor(min/60), m=min%60;
      return h>0 ? `${h}h${m>0?` ${m}m`:''}`: `${m}m`;
    }
    function escapeHtml(str){return (str||"").replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));}

    // ========== CHATROOMS ==========
    let allRooms=[], selectedRoom=null, shownMsgsTable=false;
    async function loadRooms(){
      let snap=await getDocs(collection(db,"chatrooms"));
      allRooms = snap.docs.map(doc=>({id:doc.id,name:doc.data().name||doc.id}));
      renderRoomBtns();
    }
    function renderRoomBtns(){
      const L=document.getElementById("roomList"); L.innerHTML="";
      allRooms.forEach(room=>{
        let btn=document.createElement("button");
        btn.className="room-btn"+(selectedRoom?.id===room.id&&shownMsgsTable?" selected":"");
        btn.textContent=room.name;
        btn.onclick=()=>{
          // Toggle: already selected+shown? then hide!
          if(selectedRoom?.id===room.id&&shownMsgsTable){
            document.getElementById("msgsTable").style.display="none";
            shownMsgsTable=false;
            selectedRoom=null;
            renderRoomBtns();
          }else{
            selectedRoom=room;renderRoomBtns();loadRoomMessages(room.id);shownMsgsTable=true;
          }
        }
        L.appendChild(btn);
      });
    }
    async function loadRoomMessages(roomId){
      const tbl=document.getElementById("msgsTable"),
            tbody=tbl.querySelector("tbody");
      const snap=await getDocs(query(collection(db,roomId),orderBy("createdAt","desc")));
      tbody.innerHTML="";
      snap.forEach(docSnap=>{
        const d=docSnap.data();
        const tr = document.createElement("tr");
        tr.innerHTML=`
          <td>${escapeHtml(d.user||d.username||d.uid||"")}</td>
          <td style="max-width:230px;overflow:hidden;text-overflow:ellipsis">${escapeHtml(d.text||d.type||"")}</td>
          <td>${d.createdAt?.seconds ? new Date(d.createdAt.seconds*1000).toLocaleString() : ""}</td>
          <td class="actions"><button class="delete-btn" onclick="window.deleteMsg('${roomId}','${docSnap.id}',this)">Delete</button></td>
        `;
        tbody.appendChild(tr);
      });
      tbl.style.display="table";shownMsgsTable=true;
    }
    window.deleteMsg = async function(roomId, msgId, btn){
      btn.disabled=true; await deleteDoc(doc(db,roomId,msgId));
      popup("Message deleted"); if(selectedRoom) loadRoomMessages(selectedRoom.id);
    }

    // ========== USER SEARCH + BAN/KICK/MUTE ==========
    let allUsers=[], userMap={};
    async function fetchAllUsers(){
      const snap=await getDocs(collection(db,"users"));
      allUsers=[];userMap={};
      snap.forEach(doc=>{
        const d=doc.data();
        allUsers.push({uid:doc.id,username:d.username||"",username_lower:(d.username||"").toLowerCase(),profilePic:d.profilePic});
        userMap[doc.id]=d;
      });
    }
    const searchInput=document.getElementById("userSearchInput"),
          searchDropdown=document.getElementById("searchDropdown");
    let selectedUser=null;

    searchInput.addEventListener("input",async function(){
      document.getElementById("userActionBar")?.remove();
      selectedUser = null;
      if(!allUsers.length) await fetchAllUsers();
      const q=this.value.trim().toLowerCase();
      if(!q){searchDropdown.style.display="none";return;}
      const filtered=allUsers.filter(u=>u.username_lower.includes(q)).slice(0,12);
      searchDropdown.innerHTML="";
      filtered.forEach(u=>{
        let div=document.createElement("div");
        div.className="search-res";
        div.innerHTML=`<img src="${u.profilePic||'https://cdn-icons-png.flaticon.com/512/149/149071.png'}" class="search-avatar"><span>${u.username}</span>`;
        div.onclick=()=>{
          showUserControls(u);
          // input/dropdown clear after selection
          searchInput.value='';
          searchDropdown.style.display="none";
        }
        searchDropdown.appendChild(div);
      });
      searchDropdown.style.display=filtered.length?"block":"none";
    });

    // Search--outside click close Dropdown & clear selected
    document.addEventListener('click', function(e){
      if(!searchInput.contains(e.target) && !searchDropdown.contains(e.target)) {
        searchDropdown.style.display="none";
        // Agar input blank hai toh action bar bhi hide
        setTimeout(()=>{
          if(!searchInput.value.trim()) {
            document.getElementById('userActionBar')?.remove();
            selectedUser = null;
          }
        }, 80);
      }
    });

    function showUserControls(user){
      selectedUser=user;
      searchDropdown.style.display="none";
      document.getElementById("userActionBar")?.remove();
      if(!user) return;
      let h=`<img src="${user.profilePic||'https://cdn-icons-png.flaticon.com/512/149/149071.png'}" class="search-avatar"><span id="popupUname">${user.username}</span><span id="userStatusBadges" class="status-badges"></span>`;
      let bar=document.createElement("div");bar.id="userActionBar";
      bar.innerHTML=`<div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
        ${h}
      </div>
      <div class="action-row">
        <button id="muteBtn" class="adm-btn mute">Mute</button>
        <button id="kickBtn" class="adm-btn kick">Kick</button>
        <button id="banBtn" class="adm-btn ban">Ban</button>
        <button id="unmuteBtn" class="adm-btn unmute" style="display:none;">Unmute</button>
        <button id="unkickBtn" class="adm-btn unkick" style="display:none;">Unkick</button>
        <button id="unbanBtn" class="adm-btn unban" style="display:none;">Unban</button>
      </div>`;
      document.querySelector(".searchbar-section").appendChild(bar);
      loadUserStatusBtns();
      setTimeout(loadUserStatusBtns,200); // update after possible writes
      // EVENTS
      bar.querySelector("#muteBtn").onclick=async()=>{
        let m=prompt("Mute for how many minutes?");
        if(m && !isNaN(m)) {
          await setDoc(doc(db,"mutedUsers",user.uid),{uid:user.uid,until:Date.now()+m*60000});
          popup(`${user.username} muted for ${m}m`);loadUserStatusBtns();fetchLists();
        }
      };
      bar.querySelector("#kickBtn").onclick=async()=>{
        let m=prompt("Kick for how many minutes?");
        if(m && !isNaN(m)) {
          await setDoc(doc(db,"kickedUsers",user.uid),{uid:user.uid,until:Date.now()+m*60000});
          popup(`${user.username} kicked for ${m}m`);loadUserStatusBtns();fetchLists();
        }
      };
      bar.querySelector("#banBtn").onclick=async()=>{
        if(confirm("Ban this user permanently?")) {
          await setDoc(doc(db,"bannedUsers",user.uid),{uid:user.uid,at:Date.now()});
          popup(`${user.username} banned.`);loadUserStatusBtns();fetchLists();
        }
      };
      bar.querySelector("#unmuteBtn").onclick=async()=>{
        await deleteDoc(doc(db,"mutedUsers",user.uid));popup("Unmuted.");loadUserStatusBtns();fetchLists();
      };
      bar.querySelector("#unkickBtn").onclick=async()=>{
        await deleteDoc(doc(db,"kickedUsers",user.uid));popup("Unkicked.");loadUserStatusBtns();fetchLists();
      };
      bar.querySelector("#unbanBtn").onclick=async()=>{
        await deleteDoc(doc(db,"bannedUsers",user.uid));popup("Unbanned.");loadUserStatusBtns();fetchLists();
      };
    }

    async function loadUserStatusBtns(){
      if(!selectedUser) return;
      // Banned/Muted/Kicked
      const [bu,mu,ku]= await Promise.all([
        getDoc(doc(db,"bannedUsers",selectedUser.uid)),
        getDoc(doc(db,"mutedUsers",selectedUser.uid)),
        getDoc(doc(db,"kickedUsers",selectedUser.uid))
      ]);
      document.getElementById("muteBtn").style.display=mu.exists()?"none":"inline-block";
      document.getElementById("kickBtn").style.display=ku.exists()?"none":"inline-block";
      document.getElementById("banBtn").style.display=bu.exists()?"none":"inline-block";
      document.getElementById("unmuteBtn").style.display=mu.exists()?"inline-block":"none";
      document.getElementById("unkickBtn").style.display=ku.exists()?"inline-block":"none";
      document.getElementById("unbanBtn").style.display=bu.exists()?"inline-block":"none";
      let badges="";
      if(bu.exists()) badges+=`<span class='ban-badge'>Banned</span>`;
      if(mu.exists()) badges+=`<span class='mute-badge'>Muted</span>`;
      if(ku.exists()) badges+=`<span class='kick-badge'>Kicked</span>`;
      document.getElementById("userStatusBadges").innerHTML=badges;
    }

    // ========== BANS/MUTES/KICKS LISTS ==========
    async function fetchLists(){
      if(!Object.keys(userMap).length) await fetchAllUsers();
      // BANNED
      const bannedL=document.getElementById("bannedList");
      bannedL.innerHTML="";
      const bannedDs=await getDocs(collection(db,"bannedUsers"));
      bannedDs.forEach(docSnap=>{
        const u=userMap[docSnap.id];
        if(u) bannedL.innerHTML+=`<li><b>${escapeHtml(u.username)}</b> <button class="adm-btn unban" onclick="window.unbanUID('${docSnap.id}')">Unban</button></li>`;
      });
      // MUTED
      const mutedL=document.getElementById("mutedList");
      mutedL.innerHTML="";
      const mutedDs=await getDocs(collection(db,"mutedUsers"));
      mutedDs.forEach(docSnap=>{
        const d=docSnap.data(); const u=userMap[d.uid];
        if(u) mutedL.innerHTML+=`<li><b>${escapeHtml(u.username)}</b> <span style="color:#38bdf8;">(${timeLeft(d.until)})</span> <button class="adm-btn unmute" onclick="window.unmuteUID('${d.uid}')">Unmute</button></li>`;
      });
      // KICKED
      const kickedL=document.getElementById("kickedList");
      kickedL.innerHTML="";
      const kickedDs=await getDocs(collection(db,"kickedUsers"));
      kickedDs.forEach(docSnap=>{
        const d=docSnap.data(); const u=userMap[d.uid];
        if(u) kickedL.innerHTML+=`<li><b>${escapeHtml(u.username)}</b> <span style="color:#facc15;">(${timeLeft(d.until)})</span> <button class="adm-btn unkick" onclick="window.unkickUID('${d.uid}')">Unkick</button></li>`;
      });
    }
    window.unmuteUID=async(uid)=>{await deleteDoc(doc(db,"mutedUsers",uid));popup("Unmuted.");fetchLists();}
    window.unkickUID=async(uid)=>{await deleteDoc(doc(db,"kickedUsers",uid));popup("Unkicked.");fetchLists();}
    window.unbanUID=async(uid)=>{await deleteDoc(doc(db,"bannedUsers",uid));popup("Unbanned.");fetchLists();}

    // ==== STARTUP ====
    onAuthStateChanged(auth, async user=>{
      if(!user) return location.href="login.html";
      await fetchAllUsers();
      await loadRooms();
      fetchLists();
    });
    setInterval(fetchLists,50000);
  </script>
</body>
</html>
