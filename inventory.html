<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Sharky Inventory</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0,user-scalable=no" />
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Poppins:wght@400;600&display=swap" rel="stylesheet"/>
  <style>
    header {
      background: #555555; 
      position: fixed;
      top: 0;
      left: 0;
      z-index: 3000;
      width: 100vw;
      box-shadow: 0 2px 17px #22222290;
      min-height: 50px;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
      border-radius: 0;
      transition: box-shadow 0.23s;
      color: #d1d1d1;
      font-family: "Poppins", Arial, sans-serif;
      font-size: 1rem;
    }
    .header-inner {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 16px;
      min-height: 50px;
      position: relative;
      z-index: 1;
      cursor: default;
      color: inherit;
    }
    .logo-container {
      display: flex;
      align-items: center;
      gap: 8px;
      -webkit-tap-highlight-color: transparent;
    }
    .logo-container img {
      height: 30px;
      animation: float 3.3s ease-in-out infinite;
      user-select: none;
      pointer-events: none;
      filter: none;
      image-rendering: crisp-edges;
    }
    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-4px); }
    }
    .logo-text {
      font-family: "Orbitron", Arial, Helvetica, sans-serif;
      font-size: 1.1rem;
      color: #bbbbbb;
      text-shadow: 0 0 5px #88888888;
      font-weight: 800;
      letter-spacing: 0.055em;
      margin-left: 2px;
      user-select: none;
      white-space: nowrap;
    }
    .menu-btn {
      font-size: 1.5rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      min-width: 38px;
      height: 36px;
      color: #d0d0d0;
      outline: none;
      border: none;
      background: none;
      border-radius: 9px;
      position: relative;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
      transition: background 0.16s, transform 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      gap: 6px;
    }
    .menu-btn:active {
      background: #444444;
      transform: scale(0.93);
    }
    .menu-btn .notif-badge {
      background: linear-gradient(105deg, #f87171 65%, #fb923c 110%);
      color: white;
      font-weight: 700;
      font-family: "Orbitron", sans-serif;
      min-width: 14px;
      height: 14px;
      padding: 0 6px;
      font-size: 12px;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      position: absolute;
      top: -4px;
      right: -4px;
      border: 1px solid #555555;
      box-shadow: 0 2px 6px #ef444488;
      pointer-events: none;
      z-index: 10;
      user-select: none;
    }
    .menu-dropdown {
      position: fixed;
      top: 0;
      right: -100%;
      height: 100vh;
      width: 220px;
      background: rgba(85, 85, 85, 0.97);
      box-shadow: -4px 0 26px rgba(0, 0, 0, 0.77);
      padding-top: 54px;
      padding-bottom: 22px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      font-family: "Poppins", Arial, sans-serif;
      font-weight: 600;
      font-size: 0.85rem;
      overflow-y: auto;
      transition: right 0.31s cubic-bezier(0.65, 0.01, 0.32, 1.03);
      z-index: 3500;
      user-select: none;
      color: #d1d1d1;
    }
    header.expanded .menu-dropdown {
      right: 0;
    }
    .menu-dropdown .close-btn {
      position: absolute;
      left: 11px;
      top: 13px;
      background: transparent;
      border: none;
      cursor: pointer;
      padding: 0;
      outline: none;
      z-index: 3600;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.2s ease;
      color: #bbbbbb;
      user-select: none;
    }
    .menu-dropdown .close-btn:hover,
    .menu-dropdown .close-btn:focus {
      color: #e0e0e0;
      transform: scale(1.22);
    }
    .menu-dropdown .close-btn svg {
      width: 22px;
      height: 22px;
      stroke: currentColor;
      stroke-width: 2.5;
      stroke-linecap: round;
      stroke-linejoin: round;
      user-select: none;
    }
    .menu-dropdown a {
      color: #bbbbbb;
      padding: 13px 17px 13px 46px;
      text-decoration: none;
      border-bottom: 2px solid #444444;
      display: flex;
      align-items: center;
      gap: 15px;
      background: none;
      transition: background 0.13s, color 0.13s, padding-left 0.11s, transform 0.16s;
      letter-spacing: 0.02em;
      user-select: none;
      font-weight: 600;
      font-size: 0.85rem;
      will-change: transform;
      position: relative;
    }
    .menu-dropdown a:hover,
    .menu-dropdown a:focus {
      background: #666666;
      color: #ffffff;
      padding-left: 51px;
      outline: none;
      transform: scale(1.05) translateX(-2px);
    }
    .menu-dropdown a:active {
      background: #444444;
      color: #fbbf24;
      transform: scale(0.97);
    }
    .menu-dropdown .notif-badge {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      box-shadow: none;
      border: none;
      font-weight: 700;
      font-size: 13px;
      min-width: 22px;
      height: 18px;
      background: linear-gradient(120deg, #fae024 70%, #f87171 100%);
      color: #222b3a;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-family: "Orbitron", sans-serif;
      border-radius: 7px;
      user-select: none;
      padding: 0 6px;
      line-height: 18px;
      white-space: nowrap;
    }
    .menu-dropdown a .icon {
      display: inline-flex;
      width: 22px;
      height: 22px;
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      fill: #bbbbbb;
      filter: drop-shadow(0 1px 6px #bbbbbb66);
      transition: fill 0.13s, filter 0.11s;
      user-select: none;
    }
    .menu-dropdown a:hover .icon,
    .menu-dropdown a:focus .icon {
      fill: #fff;
      filter: drop-shadow(0 2px 8px #fff4);
    }

    /* ===== Body & Inventory Styles ===== */
    html, body {
      background: #2e2e2e;
      color: #d1d5db;
      min-height: 100vh;
      width: 100vw;
      font-family: 'Poppins', 'Orbitron', Arial, sans-serif;
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      padding-top: 50px; /* To make space for fixed header */
      transition: background 0.4s ease, color 0.4s ease;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    .page-title {
      font-family: 'Orbitron', Arial, sans-serif;
      font-size: 2rem;
      font-weight: 900;
      color: #9ca3af;
      text-align: center;
      padding: 28px 0 16px 0;
      letter-spacing: 0.08em;
      text-shadow: 0 2px 10px rgba(100, 100, 100, 0.6);
      user-select: none;
      transition: color 0.3s ease;
    }
    main {
      padding: 0 16px 22px 16px;
      max-width: 420px;
      margin: 0 auto;
      box-sizing: border-box;
      font-family: 'Poppins', Arial, sans-serif;
      font-size: 1.1rem;
      user-select: none;
      will-change: transform, opacity;
      transition: color 0.3s ease;
    }
    .inv-section {
      margin-bottom: 36px;
      will-change: transform, opacity;
      transition: opacity 0.4s ease;
    }
    .inv-category-title {
      font-family: 'Orbitron', Arial, Helvetica, sans-serif;
      font-weight: 700;
      font-size: 1.3rem;
      color: #9ca3af;
      margin: 20px 0 12px 0;
      letter-spacing: 0.03em;
      text-shadow: 0 1px 10px rgba(45, 45, 45, 0.6);
      user-select: none;
      transition: color 0.3s ease;
    }
    .inv-items {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 14px;
      will-change: transform, opacity;
      transition: all 0.3s ease;
    }
    .item-card {
      background: #3a3a3a;
      border-radius: 14px;
      box-shadow: 0 3px 15px rgba(150, 150, 150, 0.25);
      padding: 14px 10px 18px 10px;
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      user-select: none;
      box-sizing: border-box;
      position: relative;
      cursor: default;
      will-change: box-shadow, transform;
      transition: box-shadow 0.25s ease, transform 0.25s ease;
    }
    .item-card:hover {
      box-shadow: 0 8px 24px rgba(120, 120, 120, 0.45);
      transform: translateY(-3px);
    }
    .item-card img {
      border-radius: 12px;
      width: 52px;
      height: 52px;
      object-fit: cover;
      box-shadow: 0 2px 12px rgba(110, 110, 110, 0.45);
      background: #444;
      margin-bottom: 9px;
      transition: box-shadow 0.3s ease;
    }
    .item-card .item-name {
      font-family: 'Poppins', Arial, sans-serif;
      font-size: 0.9rem;
      font-weight: 700;
      color: #d1d5db;
      text-align: center;
      margin-bottom: 9px;
      user-select: none;
      line-height: 1.2;
      word-break: break-word;
      text-shadow: 0 1px 12px rgba(209, 213, 219, 0.3);
      transition: color 0.3s ease;
    }
    .item-card .equip-btn, .item-card .remove-btn {
      font-family: 'Poppins', Arial, sans-serif;
      font-weight: 700;
      font-size: 0.9rem;
      border-radius: 12px;
      padding: 7px 14px;
      border: none;
      cursor: pointer;
      transition: background 0.3s ease, color 0.3s ease, box-shadow 0.3s ease;
      width: 100%;
      box-sizing: border-box;
      margin-bottom: 6px;
      user-select: none;
      will-change: background-color, color, box-shadow;
    }
    .item-card .equip-btn {
      background: linear-gradient(98deg,#9ca3af 51%,#6b7280 100%);
      color: #f9fafb;
      box-shadow: 0 1px 9px rgba(156, 163, 175, 0.7);
    }
    .item-card .equip-btn:hover:not(:disabled) {
      background: linear-gradient(98deg,#6b7280 51%,#9ca3af 100%);
      box-shadow: 0 0 15px rgba(200, 200, 200, 0.9);
      color: #fff;
    }
    .item-card .equip-btn:disabled {
      background: #4b5563;
      color: #9ca3af;
      cursor: not-allowed;
      box-shadow: none;
    }
    .item-card .remove-btn {
      background: #ef4444;
      color: #fff;
      box-shadow: 0 1px 9px #ef4444cc;
    }
    .item-card .remove-btn:hover {
      background: #dc2626;
      box-shadow: 0 2px 12px #dc2626dd;
    }
    .equip-status {
      font-family: 'Orbitron', Arial, sans-serif;
      font-size: 0.85rem;
      color: #9ca3af;
      font-weight: 700;
      user-select: none;
      margin-bottom: 8px;
      text-align: center;
      text-shadow: 0 1px 7px rgba(156, 163, 175, 0.7);
      transition: color 0.3s ease;
    }
    .popup {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      background: #6b7280;
      color: #f9fafb;
      padding: 14px 24px;
      border-radius: 12px;
      font-weight: 700;
      box-shadow: 0 4px 16px #000a;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.35s ease;
      z-index: 4000;
      will-change: opacity;
    }
    .popup.show {
      opacity: 1;
      pointer-events: auto;
    }
    @media (max-width: 600px) {
      main { padding: 0 8px 18vw 8px; max-width: 100vw; font-size: 1rem; }
      .inv-items { gap: 12px; grid-template-columns: repeat(3, 1fr);}
      .item-card { padding: 12px 10px 14px 10px; }
      .item-card img { width: 48px; height: 48px; margin-bottom: 8px;}
      .item-card .item-name { font-size: 0.85rem; margin-bottom: 7px; }
      .item-card .equip-btn, .item-card .remove-btn { padding: 6px 12px; font-size: 0.85rem; }
      .inv-category-title { font-size: 1.1rem; margin: 14px 0 8px 0;}
      .page-title { font-size: 1.7rem; padding: 22px 0 14px 0; }
      .equip-status { font-size: 0.8rem; }
    }
    
    @keyframes notifpop {
      0% { transform: scale(1); }
      50% { transform: scale(1.3); }
      100% { transform: scale(1); }
    }
  </style>
</head>
<body>

  <header id="mainHeader">
    <div class="header-inner">
      <div class="logo-container" tabindex="0" aria-label="Sharky Chat Logo">
        <img src="https://firebasestorage.googleapis.com/v0/b/sharky-chat-007.firebasestorage.app/o/gc-logo.png?alt=media&token=ddfe6e46-7351-4a07-8140-ea702b1bd823" alt="Sharky Logo" />
        <div class="logo-text">SHARKY CHAT</div>
      </div>
      <button class="menu-btn" id="menuBtn" type="button" aria-label="Toggle menu">
        â˜°
        <span class="notif-badge" id="menuNotif" style="display:none;">0</span>
      </button>
    </div>
    <nav class="menu-dropdown" role="menu" aria-label="Main Navigation">
      <button class="close-btn" aria-label="Close menu" title="Close menu" type="button">
        <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false" role="img" xmlns="http://www.w3.org/2000/svg">
          <line x1="18" y1="6" x2="6" y2="18" />
          <line x1="6" y1="6" x2="18" y2="18" />
        </svg>
      </button>
      <a href="profile.html" role="menuitem" tabindex="0">
        <span class="icon" aria-hidden="true">
          <svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg"><circle cx="16" cy="12" r="7"/><ellipse cx="16" cy="23.5" rx="12" ry="6.5"/></svg>
        </span>
        Profile
      </a>
      <a href="chatrooms.html" role="menuitem" tabindex="0">
        <span class="icon" aria-hidden="true">
          <svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg"><rect x="2" y="8" width="28" height="16" rx="5"/><rect x="12" y="6" width="8" height="4" rx="2"/><circle cx="7" cy="12" r="2"/><circle cx="25" cy="12" r="2"/></svg>
        </span>
        Chat Rooms
      </a>
      <a href="friends.html" role="menuitem" tabindex="0">
        <span class="icon" aria-hidden="true">
          <svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg"><circle cx="10" cy="12" r="5"/><circle cx="22" cy="12" r="5"/><ellipse cx="16" cy="23" rx="12" ry="6"/></svg>
        </span>
        Friends
        <span id="friends-notif" class="notif-badge" style="display:none;">0</span>
      </a>
      <a href="add-friends.html" role="menuitem" tabindex="0">
        <span class="icon" aria-hidden="true">
          <svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg"><circle cx="15" cy="13" r="7"/><rect x="23" y="19" width="9" height="3" rx="1.5"/><rect x="26" y="16" width="3" height="9" rx="1.5"/></svg>
        </span>
        Add Friend
      </a>
      <a href="inbox.html" role="menuitem" tabindex="0">
        <span class="icon" aria-hidden="true">
          <svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg"><rect x="4" y="8" width="24" height="16" rx="4"/><polyline points="4,8 16,18 28,8" fill="none" stroke="#60a5fa" stroke-width="2"/></svg>
        </span>
        Messages
        <span id="messages-notif" class="notif-badge" style="display:none;">0</span>
      </a>
      <a href="wallet.html" role="menuitem" tabindex="0">
        <span class="icon" aria-hidden="true">
          <svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg"><rect x="4" y="10" width="24" height="12" rx="3"/><ellipse cx="24" cy="16" rx="2" ry="2"/><rect x="6" y="13" width="20" height="4" rx="2"/><circle cx="17" cy="16" r="2" fill="#fff"/></svg>
        </span>
        Wallet
      </a>
      <a href="shop.html" role="menuitem" tabindex="0">
        <span class="icon" aria-hidden="true">
          <svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg"><rect x="6" y="13" width="20" height="9" rx="3"/><rect x="12" y="7" width="8" height="6" rx="2"/><rect x="13" y="22" width="6" height="4" rx="2"/><circle cx="10" cy="26" r="2"/><circle cx="22" cy="26" r="2"/></svg>
        </span>
        Shop
      </a>
      <a href="inventory.html" role="menuitem" tabindex="0">
        <span class="icon" aria-hidden="true">
          <svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg"><rect x="7" y="10" width="18" height="12" rx="3"/><rect x="11" y="6" width="10" height="4" rx="2"/><rect x="13" y="22" width="6" height="4" rx="2"/><path d="M7 22h18"/><circle cx="16" cy="18" r="2"/></svg>
        </span>
        Inventory
      </a>
      <a href="news.html" role="menuitem" tabindex="0">
        <span class="icon" aria-hidden="true">
          <svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg"><rect x="5" y="7" width="22" height="18" rx="4"/><rect x="9" y="11" width="14" height="2" rx="1"/><rect x="9" y="16" width="8" height="2" rx="1"/><circle cx="10" cy="21" r="2"/><rect x="14" y="20" width="7" height="2" rx="1"/></svg>
        </span>
        News
      </a>
      <a href="level.html" role="menuitem" tabindex="0">
        <span class="icon" aria-hidden="true">
          <svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg"><path d="M16 5v17" stroke="#6699ff" stroke-width="2.5" stroke-linecap="round"/><circle cx="16" cy="26" r="5" fill="#38bdf8" stroke="#bae6fd" stroke-width="1.5"/><rect x="11" y="13" width="10" height="4" rx="2" fill="#bae6fd" /><rect x="13" y="8" width="6" height="3" rx="1.5" fill="#60a5fa"/></svg>
        </span>
        Level
      </a>
      <a href="refer.html" role="menuitem" tabindex="0">
        <span class="icon" aria-hidden="true">
          <svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg"><circle cx="16" cy="16" r="13" fill="#5eead4" /><path d="M22.5,14h-8.7l3-3m-2.8,8a3,3,0,1,0-3,-3" stroke="#262626" stroke-width="2.3" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </span>
        Refer A Friend
      </a>
      <a href="verify-email.html" role="menuitem" tabindex="0">
        <span class="icon" aria-hidden="true">
          <svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg"><rect x="5" y="8" width="22" height="16" rx="5"/><polyline points="5,8 16,18 27,8" fill="none" stroke="#2dd4bf" stroke-width="2"/><circle cx="16" cy="19" r="2.5"/></svg>
        </span>
        Email Verification
      </a>
      <a href="help.html" role="menuitem" tabindex="0">
        <span class="icon" aria-hidden="true">
          <svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg"><circle cx="16" cy="16" r="12" fill="none" stroke="#fbbf24" stroke-width="2"/><text x="16" y="20" text-anchor="middle" fill="#fbbf24" font-size="8" font-family="Orbitron">?</text></svg>
        </span>
        Help
      </a>
      <a href="social-media.html" role="menuitem" tabindex="0">
        <span class="icon" aria-hidden="true">
          <svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg"><circle cx="8" cy="12" r="3"/><circle cx="24" cy="12" r="3"/><circle cx="16" cy="22" r="3"/><line x1="8" y1="15" x2="16" y2="19" stroke="#60a5fa" stroke-width="2"/><line x1="24" y1="15" x2="16" y2="19" stroke="#60a5fa" stroke-width="2"/></svg>
        </span>
        Social Media
      </a>
      <a href="#" id="themeSwitch" role="menuitem" tabindex="0">
        <span class="icon" aria-hidden="true">
          <svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg"><circle cx="16" cy="16" r="12"/><path d="M16 4v8"/><circle cx="16" cy="16" r="5" fill="#fff"/></svg>
        </span>
        Change Theme
      </a>
    </nav>
  </header>

  <div class="page-title">INVENTORY</div>
  <main>
    <div class="inv-section">
      <div class="inv-category-title">Banner</div>
      <div class="inv-items" id="invBanner"></div>
    </div>
    <div class="inv-section">
      <div class="inv-category-title">Badges</div>
      <div class="inv-items" id="invBadges"></div>
    </div>
  </main>
  <div id="popup" class="popup">Item Equipped</div>

  <script type="module">
    import {initializeApp} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import {getAuth,onAuthStateChanged} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import {getFirestore,doc,onSnapshot,setDoc,collection,query,where,getDocs} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBGfgy9OeMTJ__oOAFxoBW-eIOYlvhObZM",
      authDomain: "sharky-chat-007.firebaseapp.com",
      projectId: "sharky-chat-007",
      storageBucket: "sharky-chat-007.appspot.com",
      messagingSenderId: "637104796242",
      appId: "1:637104796242:web:74ac36b86af91be15ea58b",
      measurementId: "G-HT9T3P9KST"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let uid = '';
    let inventory = {};
    let equipped = {};

    const itemsMeta = {
      banner: {
        "banner_stars_profile": {
          id: "banner_stars_profile",
          name: "Stars Profile Banner",
          image: "https://user-gen-media-assets.s3.amazonaws.com/gpt4o_images/94c0fcfa-2a7a-46f1-ad8d-9ae08a932228.png"
        },
        "banner_cute_rabbit": {
          id: "banner_cute_rabbit",
          name: "Cute Rabbit Banner",
          image: "https://user-gen-media-assets.s3.amazonaws.com/gpt4o_images/c4c60231-2b74-427d-8037-98f1b33227f1.png"
        },
        "banner_peaceful_house_3d": {
          id: "banner_peaceful_house_3d",
          name: "3D Peaceful House Banner",
          image: "https://user-gen-media-assets.s3.amazonaws.com/gpt4o_images/3baf3830-1a64-425c-bd6f-905bacbc84ad.png"
        },
        "banner_4d_illusion": {
          id: "banner_4d_illusion",
          name: "4D Illusion Banner",
          image: "https://user-gen-media-assets.s3.amazonaws.com/gpt4o_images/0704da65-dc4f-4ece-adbc-cd598182010c.png"
        },
        "banner_3d_luxury": {
          id: "banner_3d_luxury",
          name: "3D Luxury Banner",
          image: "https://user-gen-media-assets.s3.amazonaws.com/gpt4o_images/5d228e0c-1e37-4101-90e4-28313586a6af.png"
        },
        "banner_3d_moon": {
          id: "banner_3d_moon",
          name: "3D Moon Banner",
          image: "https://user-gen-media-assets.s3.amazonaws.com/gpt4o_images/d185a9a8-660f-4396-9925-b3760299e111.png"
        },
        "banner_3d_gaming": {
          id: "banner_3d_gaming",
          name: "3D Gaming Banner",
          image: "https://user-gen-media-assets.s3.amazonaws.com/gpt4o_images/86b48c74-56b9-4e3d-b82c-4be753dd9234.png"
        },
        "banner_cartoon_one_eyed_devil": {
          id: "banner_cartoon_one_eyed_devil",
          name: "Cartoon One Eyed Devil Banner",
          image: "https://user-gen-media-assets.s3.amazonaws.com/gpt4o_images/c33cf83a-151b-4f56-ad81-5b2f2c4b9164.png"
        },
        "banner_bmw_headlight_evil": {
          id: "banner_bmw_headlight_evil",
          name: "BMW Headlight Evil Banner",
          image: "https://user-gen-media-assets.s3.amazonaws.com/gpt4o_images/e3a07e8f-23af-42d5-9a5d-03f4f768ec76.png"
        },
        "banner_cartoon_turtle": {
          id: "banner_cartoon_turtle",
          name: "Cartoon Turtle Banner",
          image: "https://user-gen-media-assets.s3.amazonaws.com/gpt4o_images/73c882c5-e531-4b01-a356-75fdc5e4f822.png"
        },
        "banner_3d_rain": {
          id: "banner_3d_rain",
          name: "3D Rain Banner",
          image: "https://user-gen-media-assets.s3.amazonaws.com/gpt4o_images/09250fbd-e0a9-4861-9251-8033325be157.png"
        },
        "banner_verified_reward": {
          id: "banner_verified_reward",
          name: "Verified Email Banner",
          image: "https://user-gen-media-assets.s3.amazonaws.com/gpt4o_images/6aa80a52-fd37-4979-ad7a-8eeb994a8f46.png"
        }
      },
      badge: {
        "badge_star_light": {
          id: 'badge_star_light',
          name: 'Star Light Badge',
          image: 'https://user-gen-media-assets.s3.amazonaws.com/gpt4o_images/cb7afe60-1c8e-4af6-8780-01856f63b51d.png'
        },
        "badge_moon_dark": {
          id: 'badge_moon_dark',
          name: 'Moon Dark Badge',
          image: 'https://user-gen-media-assets.s3.amazonaws.com/gpt4o_images/60a43f65-1ab7-4923-8788-758778130a22.png'
        },
        "badge_rising_star": {
          id: 'badge_rising_star',
          name: 'Rising Star Badge',
          image: 'https://user-gen-media-assets.s3.amazonaws.com/gpt4o_images/43fb251c-b5e8-4541-a786-d91e060eb7f0.png'
        },
        "badge_luxury": {
          id: 'badge_luxury',
          name: 'Luxury Badge',
          image: 'https://user-gen-media-assets.s3.amazonaws.com/gpt4o_images/23b9ac5c-faaf-4d14-ad52-65aab320e878.png'
        },
        "badge_legendary": {
          id: "badge_legendary",
          name: "Legendary Badge",
          image: "https://user-gen-media-assets.s3.amazonaws.com/gpt4o_images/85b7077f-5e80-42e1-890f-ec78df6afd0e.png"
        },
        "badge_warrior": {
          id: "badge_warrior",
          name: "Warrior Badge",
          image: "https://user-gen-media-assets.s3.amazonaws.com/gpt4o_images/8315ccb8-4f68-4dc9-b1c9-225b62ed2a87.png"
        },
        "badge_wolf": {
          id: "badge_wolf",
          name: "Wolf Badge",
          image: "https://user-gen-media-assets.s3.amazonaws.com/gpt4o_images/94674004-81f1-4aa5-afe2-15c097b29a76.png"
        },
        "badge_lion": {
          id: "badge_lion",
          name: "Lion Badge",
          image: "https://user-gen-media-assets.s3.amazonaws.com/gpt4o_images/f026bd24-7f5b-44d8-9312-a190d6d30933.png"
        },
        "badge_king": {
          id: "badge_king",
          name: "King Badge",
          image: "https://user-gen-media-assets.s3.amazonaws.com/gpt4o_images/a07d8670-6f91-43b1-884e-79a347c3fda0.png"
        },
        "badge_email_verified": {
          id: "badge_email_verified",
          name: "Verified Email Badge",
          image: "https://user-gen-media-assets.s3.amazonaws.com/gpt4o_images/f03edc77-9d2e-45e2-a3ef-a1ae6ea0483b.png"
        }
      }
    };

    function showPopup(msg){
      const popup=document.getElementById("popup");
      popup.textContent=msg;
      popup.classList.add("show");
      setTimeout(()=>popup.classList.remove("show"),2000);
    }

    function createItemCard(item, category) {
      const card = document.createElement("div");
      card.className = "item-card";

      const equipKey = category;
      const isEquipped = equipped[equipKey] === item.id;

      card.innerHTML = `
        <img src="${item.image}" alt="${item.name}" />
        <div class="item-name">${item.name}</div>
        ${isEquipped ? 
          `<div class="equip-status">Equipped</div>
           <button class="remove-btn">Remove</button>` : 
          `<button class="equip-btn">Equip</button>`
        }
      `;

      if(isEquipped){
        const removeBtn = card.querySelector(".remove-btn");
        removeBtn.onclick = async () => {
          const newEquipped = {...equipped};
          newEquipped[equipKey] = null;
          await setDoc(doc(db,"equipped", uid), newEquipped, {merge:true});
          showPopup("Item Removed");
        };
      } else {
        const equipBtn = card.querySelector(".equip-btn");
        equipBtn.onclick = async () => {
          const newEquipped = {...equipped};
          newEquipped[equipKey] = item.id;
          await setDoc(doc(db,"equipped", uid), newEquipped, {merge:true});
          showPopup("Item Equipped");
        };
      }

      return card;
    }

    function renderCategory(category, containerId) {
      const container = document.getElementById(containerId);
      container.innerHTML = "";
      const itemsList = itemsMeta[category];
      for (const id in itemsList) {
        if(inventory[id]){
          container.appendChild(createItemCard(itemsList[id], category));
        }
      }
    }

    function bumpBadge(el) {
      if (!el) return;
      el.style.animation = "";
      setTimeout(() => {
        el.style.animation = "notifpop .34s";
      }, 25);
    }
    function bumpBadgeDropdown(el) {
      if (!el) return;
      el.style.animation = "";
      setTimeout(() => {
        el.style.animation = "notifpop .33s";
      }, 30);
    }

    const menuNotif = document.getElementById("menuNotif");
    const friendsNotif = document.getElementById("friends-notif");
    const messagesNotif = document.getElementById("messages-notif");

    let myUsername = "";
    let myUID = "";

    function setupMenuNotifications(uid, username) {
      onSnapshot(
        query(collection(db, "friendRequests"), where("to", "==", uid), where("status", "==", "pending")),
        (snap) => {
          const frCount = snap.size;
          menuNotif.dataset.fr = frCount;
          friendsNotif.textContent = frCount > 99 ? "99+" : frCount;
          friendsNotif.style.display = frCount > 0 ? "inline-flex" : "none";
          bumpBadgeDropdown(friendsNotif);
          updateMenuBadge();
        }
      );
    }

    async function setupMessageNotifications(uid, username) {
      const friendsSnap = await getDocs(collection(db, "friends"));
      let myFriends = [];
      friendsSnap.forEach((doc) => {
        if (doc.id === uid && doc.data()) myFriends = Object.keys(doc.data());
      });
      if (myFriends.length === 0) {
        messagesNotif.style.display = "none";
        updateMenuBadge();
        return;
      }
      let unseenTracker = {};
      let usernamesData = {};
      let batchSize = 10;

      for (let i = 0; i < myFriends.length; i += batchSize) {
        let batch = myFriends.slice(i, i + batchSize);
        const usersSnap = await getDocs(query(collection(db, "users"), where("__name__", "in", batch)));
        usersSnap.forEach((doc) => {
          usernamesData[doc.id] = doc.data().username;
        });
      }

      for (const fid of myFriends) {
        const friendUsername = usernamesData[fid];
        if (!friendUsername || friendUsername === username) continue;
        const chatId = [username, friendUsername].sort().join("_");
        const msgRef = collection(db, "personalMessages", chatId, "messages");
        onSnapshot(
          query(msgRef, where("recipient", "==", username), where("seen", "==", false)),
          (snap) => {
            let unseen = 0;
            snap.forEach((doc) => {
              if (doc.data().sender !== username) unseen++;
            });
            unseenTracker[chatId] = unseen;
            updateMessagesBadge();
          }
        );
      }

      function updateMessagesBadge() {
        let totalUnseen = Object.values(unseenTracker).reduce((a, b) => a + b, 0);
        messagesNotif.dataset.count = totalUnseen;
        messagesNotif.textContent = totalUnseen > 99 ? "99+" : totalUnseen;
        messagesNotif.style.display = totalUnseen > 0 ? "inline-flex" : "none";
        bumpBadge(messagesNotif);
        updateMenuBadge();
      }
    }

    function updateMenuBadge() {
      const frCount = parseInt(menuNotif.dataset.fr) || 0;
      const msgCount = parseInt(messagesNotif.dataset.count) || 0;
      const total = frCount + msgCount;
      if (total > 0) {
        menuNotif.textContent = total > 99 ? "99+" : total;
        menuNotif.style.display = "inline-flex";
        bumpBadge(menuNotif);
      } else {
        menuNotif.style.display = "none";
      }
    }

    onAuthStateChanged(auth, async (user) => {
      if(!user){
        alert("Please login first.");
        window.location.href = "index.html";
        return;
      }
      uid = user.uid;

      const userDoc = await getDocs(query(collection(db, "users"), where("__name__", "==", uid)));
      userDoc.forEach(docSnap => {
        myUsername = docSnap.data()?.username || "";
      });

      setupMenuNotifications(uid, myUsername);
      setupMessageNotifications(uid, myUsername);

      const invRef = doc(db,"inventories", uid);
      const eqRef = doc(db,"equipped", uid);

      onSnapshot(invRef, snap => {
        inventory = snap.exists() ? snap.data() : {};
        renderCategory("banner", "invBanner");
        renderCategory("badge", "invBadges");
      });

      onSnapshot(eqRef, snap => {
        equipped = snap.exists() ? snap.data() : {};
        renderCategory("banner", "invBanner");
        renderCategory("badge", "invBadges");
      });
    });

    const mainHeader = document.getElementById("mainHeader");
    const menuBtn = document.getElementById("menuBtn");
    const closeBtn = document.querySelector(".menu-dropdown .close-btn");

    menuBtn.addEventListener("click", (e) => {
      mainHeader.classList.toggle("expanded");
      e.stopPropagation();
    });

    closeBtn.addEventListener("click", (e) => {
      mainHeader.classList.remove("expanded");
      menuBtn.focus();
      e.stopPropagation();
    });

    document.addEventListener("click", (e) => {
      if (!mainHeader.contains(e.target)) mainHeader.classList.remove("expanded");
    });

    document.querySelector(".menu-dropdown").addEventListener("click", (e) => {
      if (e.target.tagName === "A") mainHeader.classList.remove("expanded");
    });

    const themeSwitch = document.getElementById("themeSwitch");
    if (themeSwitch) {
      themeSwitch.addEventListener("click", function () {
        document.body.classList.toggle("light-theme");
        const theme = document.body.classList.contains("light-theme") ? "light" : "dark";
        localStorage.setItem("theme", theme);
        mainHeader.classList.remove("expanded");
      });
    }
  </script>
</body>
</html>