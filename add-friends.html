<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Sharky Chat â€” Search Users</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0,user-scalable=no" />
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Roboto:wght@400;500;700&family=Poppins:wght@600;700&family=Inter:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    html,
    body {
      margin: 0;
      padding: 0;
      min-height: 100vh;
      background: #555555; 
      color: #e2e8f0;
      font-family: "Poppins", "Segoe UI", Arial, Helvetica, sans-serif;
      width: 100vw;
      overflow-x: hidden;
      box-sizing: border-box;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    ::-webkit-scrollbar {
      width: 8px;
      background: transparent;
    }
    ::-webkit-scrollbar-thumb {
      background: #3a3a3a;
      border-radius: 7px;
    }

    header {
      background: #555555; /* full grey */
      position: fixed;
      top: 0;
      left: 0;
      z-index: 2000;
      width: 100vw;
      box-shadow: 0 2px 17px #22222290;
      min-height: 50px;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      border-radius: 0;
      transition: box-shadow 0.23s;
      color: #d1d1d1;
    }
    .header-inner {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 16px;
      min-height: 50px;
      position: relative;
      z-index: 1;
      font-family: "Poppins", Arial, sans-serif;
      font-size: 1.02rem;
      cursor: default;
      color: inherit;
    }
    .logo-container {
      display: flex;
      align-items: center;
      gap: 8px;
      -webkit-tap-highlight-color: transparent;
    }
    .logo-container img {
      height: 30px;
      animation: float 3.3s ease-in-out infinite;
      user-select: none;
      pointer-events: none;
      filter: none; /* removed invert/brightness filter for clarity */
      image-rendering: crisp-edges;
    }
    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-4px); }
    }
    .logo-text {
      font-family: "Orbitron", Arial, Helvetica, sans-serif;
      font-size: 1.1rem;
      color: #bbbbbb;
      text-shadow: 0 0 5px #88888888;
      font-weight: 800;
      letter-spacing: 0.055em;
      margin-left: 2px;
      user-select: none;
    }
    .menu-btn {
      font-size: 1.5rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      min-width: 38px;
      height: 36px;
      color: #d0d0d0;
      outline: none;
      border: none;
      background: none;
      border-radius: 9px;
      position: relative;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
      transition: background 0.16s, transform 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .menu-btn:active {
      background: #444444;
      transform: scale(0.93);
    }
    .menu-btn .notif-badge {
      background: linear-gradient(105deg, #f87171 65%, #fb923c 110%);
      color: white;
      font-weight: 700;
      font-family: "Orbitron", sans-serif;
      min-width: 12px;
      height: 12px;
      padding: 0 6px;
      font-size: 12px;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      position: absolute;
      top: 1px;
      right: 1px;
      border: 1px solid #555555;
      box-shadow: 0 2px 6px #ef444488;
      pointer-events: none;
      z-index: 10;
      user-select: none;
    }
    .menu-dropdown {
      position: fixed;
      top: 0;
      right: -100%;
      height: 100vh;
      width: 220px;
      background: rgba(85, 85, 85, 0.97);
      box-shadow: -4px 0 26px rgba(0, 0, 0, 0.77);
      padding-top: 54px;
      padding-bottom: 22px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      font-family: "Poppins", Arial, sans-serif;
      font-weight: 600;
      font-size: 0.85rem;
      overflow-y: auto;
      transition: right 0.31s cubic-bezier(0.65, 0.01, 0.32, 1.03);
      z-index: 2500;
      user-select: none;
      color: #d1d1d1;
    }
    header.expanded .menu-dropdown {
      right: 0;
    }
    .menu-dropdown .close-btn {
      position: absolute;
      left: 11px;
      top: 13px;
      background: transparent;
      border: none;
      cursor: pointer;
      padding: 0;
      outline: none;
      z-index: 2600;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.2s ease;
      color: #bbbbbb;
      user-select: none;
    }
    .menu-dropdown .close-btn:hover,
    .menu-dropdown .close-btn:focus {
      color: #e0e0e0;
      transform: scale(1.22);
    }
    .menu-dropdown .close-btn svg {
      width: 22px;
      height: 22px;
      stroke: currentColor;
      stroke-width: 2.5;
      stroke-linecap: round;
      stroke-linejoin: round;
      user-select: none;
    }
    .menu-dropdown a {
      color: #bbbbbb;
      padding: 13px 17px 13px 46px;
      text-decoration: none;
      border-bottom: 2px solid #444444;
      display: flex;
      align-items: center;
      gap: 15px;
      background: none;
      transition: background 0.13s, color 0.13s, padding-left 0.11s, transform 0.16s;
      letter-spacing: 0.02em;
      user-select: none;
      font-weight: 600;
      font-size: 0.85rem;
      will-change: transform;
    }
    .menu-dropdown a:hover,
    .menu-dropdown a:focus {
      background: #666666;
      color: #ffffff;
      padding-left: 51px;
      outline: none;
      transform: scale(1.05) translateX(-2px);
    }
    .menu-dropdown a:active {
      background: #444444;
      color: #fbbf24;
      transform: scale(0.97);
    }
    .menu-dropdown .notif-badge {
      position: static;
      margin-left: 7px;
      box-shadow: none;
      border: none;
      font-weight: 700;
      font-size: 13px;
      min-width: 22px;
      height: 18px;
      background: linear-gradient(120deg, #fae024 70%, #f87171 100%);
      color: #222b3a;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-family: "Orbitron", sans-serif;
      border-radius: 7px;
      user-select: none;
    }
    .menu-dropdown a .icon {
      display: inline-flex;
      width: 22px;
      height: 22px;
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      fill: #bbbbbb;
      filter: drop-shadow(0 1px 6px #bbbbbb66);
      transition: fill 0.13s, filter 0.11s;
      user-select: none;
    }
    .menu-dropdown a:hover .icon,
    .menu-dropdown a:focus .icon {
      fill: #fff;
      filter: drop-shadow(0 2px 8px #fff4);
    }

    main {
      padding: 54px 12px 20px 12px;
      max-width: 960px;
      margin: 0 auto;
      box-sizing: border-box;
      font-family: "Segoe UI", Arial, sans-serif;
      font-weight: 500;
      color: #d1d1d1;
    }

    .search-box {
      max-width: 600px;
      margin: 38px 12px 0 12px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      background: #444444dd;
      border-radius: 30px;
      box-shadow: 0 3px 20px #2a2a2a6a;
      padding: 18px 20px;
      color: #e3f2fd;
    }

    input[type="text"] {
      padding: 14px 18px;
      border-radius: 24px;
      border: none;
      font-size: 1.05rem;
      background: #333333;
      color: #e3f2fd;
      width: 100%;
      outline: none;
      transition: box-shadow 0.15s, border 0.12s;
      font-family: "Segoe UI", Arial, sans-serif;
      font-weight: 500;
      box-sizing: border-box;
    }

    input[type="text"]:focus {
      border: 2px solid #bbbbbb;
      box-shadow: 0 0 12px #88888899;
      color: #fff;
      background: #444444;
    }

    .results {
      margin-top: 12px;
      background: #3a3a3a;
      border-radius: 14px;
      padding: 8px 12px;
      max-height: 260px;
      overflow-y: auto;
      box-shadow: 0 0 16px #22222257 inset;
      color: #cccccc;
      font-weight: 700;
      font-family: "Segoe UI", Arial, sans-serif;
    }

    .user-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 10px 10px 10px;
      border-bottom: 1.2px solid #555555;
      cursor: pointer;
      border-radius: 6px;
      transition: background 0.14s, color 0.18s;
      user-select: none;
      font-weight: 700;
      font-family: "Segoe UI", Arial, sans-serif;
      color: #cccccc;
      font-size: 1rem;
    }

    .user-item:hover {
      background: #666666;
      color: #f1f9ff;
    }

    .user-pic {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid #bbbbbb;
      box-shadow: 0 0 10px #bbbbbb5e;
      user-select: none;
      flex-shrink: 0;
    }

    .user-name {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      font-family: "Segoe UI", Arial, sans-serif;
      font-size: 1rem;
      font-weight: 700;
      color: inherit;
      flex: 1 1 auto;
      user-select: text;
    }

    .all-users-section {
      margin: 38px 12px 18px 12px;
      max-width: 960px;
      background: #454545c2;
      border-radius: 22px;
      box-shadow: 0 3px 32px #2222221c;
      padding: 20px 12px 30px 12px;
      display: flex;
      flex-direction: column;
      user-select: none;
      color: #d1d1d1;
    }

    .all-users-title {
      font-family: "Orbitron", Arial, sans-serif;
      font-size: 2rem;
      color: #bbbbbb;
      margin-bottom: 16px;
      font-weight: 800;
      letter-spacing: 0.05em;
      text-align: center;
      text-shadow: 0 0 10px #88888833;
      user-select: none;
    }

    /* New user-row style: full width, one user per row */
    .user-row {
      display: flex;
      align-items: center;
      gap: 15px;
      background: #555555;
      border-radius: 12px;
      padding: 12px 16px;
      margin-bottom: 12px;
      cursor: pointer;
      box-shadow: 0 2px 6px #22222288;
      transition: background 0.2s ease, box-shadow 0.2s ease;
      color: #eeeeee;
      font-family: "Segoe UI", Arial, sans-serif;
      font-weight: 600;
      font-size: 1.1rem;
    }
    .user-row:hover {
      background: #666666;
      box-shadow: 0 3px 12px #444444cc;
      color: #ffffff;
    }
    .user-row .user-pic {
      width: 56px;
      height: 56px;
      border: 2px solid #bbbbbb;
      box-shadow: 0 0 12px #bbbbbb77;
    }
    .user-info {
      display: flex;
      flex-direction: column;
      justify-content: center;
      min-width: 0;
    }
    .user-info .username {
      font-weight: 700;
      font-size: 1.2rem;
      color: #dddcdc;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .user-info .details {
      font-weight: 400;
      font-size: 0.9rem;
      color: #ccccccaa;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-top: 2px;
    }

    @media (max-width: 768px) {
      .search-box {
        margin: 30px 12px 0 12px;
        max-width: 100%;
      }
      .user-row {
        font-size: 1rem;
        padding: 10px 14px;
      }
      .user-row .user-pic {
        width: 48px;
        height: 48px;
      }
      .user-info .username {
        font-size: 1rem;
      }
      .user-info .details {
        font-size: 0.85rem;
      }
    }

    @media (max-width: 480px) {
      .search-box {
        margin: 24px 12px 0 12px;
        max-width: 100%;
      }
      .user-row {
        font-size: 0.9rem;
        padding: 8px 12px;
      }
      .user-row .user-pic {
        width: 44px;
        height: 44px;
      }
      .user-info .username {
        font-size: 0.95rem;
      }
      .user-info .details {
        font-size: 0.75rem;
      }
    }
  </style>
</head>
<body>
 <header id="mainHeader">
    <div class="header-inner">
      <div class="logo-container">
        <img src="https://firebasestorage.googleapis.com/v0/b/sharky-chat-007.firebasestorage.app/o/gc-logo.png?alt=media&token=ddfe6e46-7351-4a07-8140-ea702b1bd823" alt="Sharky Logo" />
        <div class="logo-text">SHARKY CHAT</div>
      </div>
      <button class="menu-btn" id="menuBtn" type="button" aria-label="Toggle menu">
        â˜°
        <span class="notif-badge" id="menuNotif" style="display:none;">0</span>
      </button>
    </div>
    <nav class="menu-dropdown" role="menu" aria-label="Main Navigation">
      <button class="close-btn" aria-label="Close menu" title="Close menu">
        <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
          <line x1="18" y1="6" x2="6" y2="18" />
          <line x1="6" y1="6" x2="18" y2="18" />
        </svg>
        </button>
      <a href="profile.html" role="menuitem"><span class="icon"><svg viewBox="0 0 32 32"><circle cx="16" cy="12" r="7"/><ellipse cx="16" cy="23.5" rx="12" ry="6.5"/></svg></span>Profile</a>
      <a href="chatrooms.html" role="menuitem"><span class="icon"><svg viewBox="0 0 32 32"><rect x="2" y="8" width="28" height="16" rx="5"/><rect x="12" y="6" width="8" height="4" rx="2"/><circle cx="7" cy="12" r="2"/><circle cx="25" cy="12" r="2"/></svg></span>Chat Rooms</a>
      <a href="friends.html" role="menuitem"><span class="icon"><svg viewBox="0 0 32 32"><circle cx="10" cy="12" r="5"/><circle cx="22" cy="12" r="5"/><ellipse cx="16" cy="23" rx="12" ry="6"/></svg></span>Friends <span id="friends-notif" class="notif-badge" style="display:none;">0</span></a>
      <a href="add-friends.html" role="menuitem"><span class="icon"><svg viewBox="0 0 32 32"><circle cx="15" cy="13" r="7"/><rect x="23" y="19" width="9" height="3" rx="1.5"/><rect x="26" y="16" width="3" height="9" rx="1.5"/></svg></span>Add Friend</a>
      <a href="inbox.html" role="menuitem"><span class="icon"><svg viewBox="0 0 32 32"><rect x="4" y="8" width="24" height="16" rx="4"/><polyline points="4,8 16,18 28,8" fill="none" stroke="#60a5fa" stroke-width="2"/></svg></span>Messages <span id="messages-notif" class="notif-badge" style="display:none;">0</span></a>
      <a href="wallet.html" role="menuitem"><span class="icon"><svg viewBox="0 0 32 32"><rect x="4" y="10" width="24" height="12" rx="3"/><ellipse cx="24" cy="16" rx="2" ry="2"/><rect x="6" y="13" width="20" height="4" rx="2"/><circle cx="17" cy="16" r="2" fill="#fff"/></svg></span>Wallet</a>
      <a href="shop.html" role="menuitem"><span class="icon"><svg viewBox="0 0 32 32"><rect x="6" y="13" width="20" height="9" rx="3"/><rect x="12" y="7" width="8" height="6" rx="2"/><rect x="13" y="22" width="6" height="4" rx="2"/><circle cx="10" cy="26" r="2"/><circle cx="22" cy="26" r="2"/></svg></span>Shop</a>
      <a href="inventory.html" role="menuitem"><span class="icon"><svg viewBox="0 0 32 32"><rect x="7" y="10" width="18" height="12" rx="3"/><rect x="11" y="6" width="10" height="4" rx="2"/><rect x="13" y="22" width="6" height="4" rx="2"/><path d="M7 22h18"/><circle cx="16" cy="18" r="2"/></svg></span>Inventory</a>
      <a href="news.html" role="menuitem"><span class="icon"><svg viewBox="0 0 32 32"><rect x="5" y="7" width="22" height="18" rx="4"/><rect x="9" y="11" width="14" height="2" rx="1"/><rect x="9" y="16" width="8" height="2" rx="1"/><circle cx="10" cy="21" r="2"/><rect x="14" y="20" width="7" height="2" rx="1"/></svg></span>News</a>
      <a href="level.html" role="menuitem"><span class="icon"><svg viewBox="0 0 32 32"><path d="M16 5v17" stroke="#6699ff" stroke-width="2.5" stroke-linecap="round"/><circle cx="16" cy="26" r="5" fill="#38bdf8" stroke="#bae6fd" stroke-width="1.5"/><rect x="11" y="13" width="10" height="4" rx="2" fill="#bae6fd" /><rect x="13" y="8" width="6" height="3" rx="1.5" fill="#60a5fa"/></svg></span>Level</a>
      <a href="refer.html" role="menuitem"><span class="icon"><svg viewBox="0 0 32 32"><circle cx="16" cy="16" r="13" fill="#5eead4" /><path d="M22.5,14h-8.7l3-3m-2.8,8a3,3,0,1,0-3,-3" stroke="#262626" stroke-width="2.3" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg></span>Refer A Friend</a>
      <a href="verify-email.html" role="menuitem"><span class="icon"><svg viewBox="0 0 32 32"><rect x="5" y="8" width="22" height="16" rx="5"/><polyline points="5,8 16,18 27,8" fill="none" stroke="#2dd4bf" stroke-width="2"/><circle cx="16" cy="19" r="2.5"/></svg></span>Email Verification</a>
      <a href="help.html" role="menuitem"><span class="icon"><svg viewBox="0 0 32 32"><circle cx="16" cy="16" r="12" fill="none" stroke="#fbbf24" stroke-width="2"/><text x="16" y="20" text-anchor="middle" fill="#fbbf24" font-size="8" font-family="Orbitron">?</text></svg></span>Help</a>
      <a href="social-media.html" role="menuitem"><span class="icon"><svg viewBox="0 0 32 32"><circle cx="8" cy="12" r="3"/><circle cx="24" cy="12" r="3"/><circle cx="16" cy="22" r="3"/><line x1="8" y1="15" x2="16" y2="19" stroke="#60a5fa" stroke-width="2"/><line x1="24" y1="15" x2="16" y2="19" stroke="#60a5fa" stroke-width="2"/></svg></span>Social Media</a>
      <a href="#" id="themeSwitch" role="menuitem"><span class="icon"><svg viewBox="0 0 32 32"><circle cx="16" cy="16" r="12"/><path d="M16 4v8"/><circle cx="16" cy="16" r="5" fill="#fff"/></svg></span>Change Theme</a>
    </nav>
  </header>
<main>
  <div class="search-box">
    <input
      type="text"
      id="searchInput"
      placeholder="Enter username..."
      oninput="searchUsers()"
      autocomplete="off"
    />
    <div class="results" id="resultsBox">
      <div class="no-result">Type to search users...</div>
    </div>
  </div>
  <div class="all-users-section">
    <div class="all-users-title">All Users</div>
    <div id="allUsersCards">
      <div style="color:#bbbbbb;text-align:center;font-size:1.02rem;padding:25px;">
        Loading users...
      </div>
    </div>
  </div>
</main>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import {
    getAuth,
    onAuthStateChanged,
  } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import {
    getFirestore,
    collection,
    getDocs,
    query,
    where,
  } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBGfgy9OeMTJ__oOAFxoBW-eIOYlvhObZM",
    authDomain: "sharky-chat-007.firebaseapp.com",
    projectId: "sharky-chat-007",
    storageBucket: "sharky-chat-007.appspot.com",
    messagingSenderId: "637104796242",
    appId: "1:637104796242:web:74ac36b86af91be15ea58b",
    measurementId: "G-HT9T3P9KST",
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  let theme = localStorage.getItem("theme") || "dark";
  if (theme === "light") document.body.classList.add("light-theme");

  document.getElementById("themeSwitch").addEventListener("click", function () {
    document.body.classList.toggle("light-theme");
    theme = document.body.classList.contains("light-theme") ? "light" : "dark";
    localStorage.setItem("theme", theme);
    document.getElementById("mainHeader").classList.remove("expanded");
  });

  function bumpBadge(el, number) {
    if (!el) return;
    el.style.animation = "";
    setTimeout(() => {
      el.style.animation = "notifpop .34s";
    }, 25);
  }
  function bumpBadgeDropdown(el, number) {
    el.style.animation = "";
    setTimeout(() => {
      el.style.animation = "notifpop .33s";
    }, 30);
  }

  const menuNotif = document.getElementById("menuNotif");
  const friendsNotif = document.getElementById("friends-notif");
  const messagesNotif = document.getElementById("messages-notif");
  let myUsername = "",
    myUID = "";

  function setupMenuNotifications(uid, username) {
    import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js").then(
      ({ onSnapshot, query, collection, where }) => {
        onSnapshot(
          query(
            collection(db, "friendRequests"),
            where("to", "==", uid),
            where("status", "==", "pending")
          ),
          (snap) => {
            const frCount = snap.size;
            menuNotif.dataset.fr = frCount;
            friendsNotif.textContent = frCount > 99 ? "99+" : frCount;
            friendsNotif.style.display = frCount > 0 ? "inline-flex" : "none";
            bumpBadgeDropdown(friendsNotif, frCount);
            const msgCount = parseInt(messagesNotif.dataset.count) || 0;
            const totalBadge = frCount + msgCount;
            menuNotif.textContent = totalBadge > 99 ? "99+" : totalBadge;
            menuNotif.style.display = totalBadge > 0 ? "inline-flex" : "none";
            bumpBadge(menuNotif, totalBadge);
          }
        );
      }
    );
  }

  async function setupMessageNotifications(uid, username) {
    const myFriendsDoc = await getDocs(collection(db, "friends"));
    let myFriends = [];
    myFriendsDoc.forEach((docSnap) => {
      if (docSnap.id === uid && docSnap.data()) myFriends = Object.keys(docSnap.data());
    });
    if (!myFriends.length) return;
    let unseenTracker = {};
    let usernamesData = {};
    if (myFriends.length) {
      let snap = await getDocs(
        query(collection(db, "users"), where("__name__", "in", myFriends.slice(0, 10)))
      );
      snap.forEach((doc) => {
        usernamesData[doc.id] = doc.data().username;
      });
      if (myFriends.length > 10)
        for (let i = 10; i < myFriends.length; i += 10) {
          let s = await getDocs(
            query(collection(db, "users"), where("__name__", "in", myFriends.slice(i, i + 10)))
          );
          s.forEach((doc) => {
            usernamesData[doc.id] = doc.data().username;
          });
        }
    }
    import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js").then(
      ({ onSnapshot, query, collection, where }) => {
        for (const fid of myFriends) {
          const friendUsername = usernamesData[fid];
          if (!friendUsername || friendUsername === username) continue;
          const chatId = [username, friendUsername].sort().join("_");
          const msgRef = collection(db, "personalMessages", chatId, "messages");
          onSnapshot(
            query(
              msgRef,
              where("recipient", "==", username),
              where("seen", "==", false)
            ),
            (snap) => {
              let unseen = 0;
              snap.forEach((doc) => {
                if (doc.data().sender !== username) unseen++;
              });
              unseenTracker[chatId] = unseen;
              updateBadges();
            }
          );
        }
      }
    );
    function updateBadges() {
      let totalUnseen = Object.values(unseenTracker).reduce((a, b) => a + b, 0);
      messagesNotif.dataset.count = totalUnseen;
      messagesNotif.textContent = totalUnseen > 99 ? "99+" : totalUnseen;
      messagesNotif.style.display = totalUnseen > 0 ? "inline-flex" : "none";
      bumpBadge(messagesNotif, totalUnseen);
      const frCount = parseInt(menuNotif.dataset.fr) || 0;
      const sum = frCount + totalUnseen;
      menuNotif.textContent = sum > 99 ? "99+" : sum;
      menuNotif.style.display = sum > 0 ? "inline-flex" : "none";
      bumpBadge(menuNotif, sum);
    }
  }

  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      alert("Please login first.");
      window.location.href = "index.html";
    } else {
      let snap = await getDocs(
        query(collection(db, "users"), where("__name__", "==", user.uid))
      );
      snap.forEach((docSnap) => {
        myUsername = docSnap.data().username || "";
      });
      setupMenuNotifications(user.uid, myUsername);
      setupMessageNotifications(user.uid, myUsername);
    }
  });

  const mainHeader = document.getElementById("mainHeader");
  const menuBtn = document.getElementById("menuBtn");
  const closeBtn = document.querySelector(".menu-dropdown .close-btn");

  menuBtn.addEventListener("click", (e) => {
    mainHeader.classList.toggle("expanded");
    e.stopPropagation();
  });

  closeBtn.addEventListener("click", (e) => {
    mainHeader.classList.remove("expanded");
    menuBtn.focus();
    e.stopPropagation();
  });

  document.addEventListener("click", (e) => {
    if (!mainHeader.contains(e.target)) mainHeader.classList.remove("expanded");
  });

  document.querySelector(".menu-dropdown").addEventListener("click", (e) => {
    if (e.target.tagName === "A") mainHeader.classList.remove("expanded");
  });

  let allUsers = [];

  async function loadAllUsers() {
    const snapshot = await getDocs(collection(db, "users"));
    allUsers = [];
    snapshot.forEach((doc) => {
      const data = doc.data();
      if (data.username)
        allUsers.push({
          username: data.username,
          profilePicUrl:
            data.profilePic || "https://cdn-icons-png.flaticon.com/512/149/149071.png",
          age: data.age || "N/A",
          country: data.country || "Unknown"
        });
    });
    allUsers.sort((a, b) => a.username.localeCompare(b.username));
  }

  window.searchUsers = async () => {
    const queryTxt = document.getElementById("searchInput").value
      .toLowerCase()
      .trim();
    const resultBox = document.getElementById("resultsBox");
    if (allUsers.length === 0) await loadAllUsers();
    if (queryTxt === "") {
      resultBox.innerHTML = `<div class="no-result">Type to search users...</div>`;
      return;
    }
    const filtered = allUsers.filter((user) =>
      user.username.toLowerCase().includes(queryTxt)
    );
    resultBox.innerHTML = "";
    if (filtered.length === 0) {
      resultBox.innerHTML = `<div class="no-result">No users found.</div>`;
      return;
    }
    filtered.forEach((user) => {
      const div = document.createElement("div");
      div.className = "user-item";
      const img = document.createElement("img");
      img.className = "user-pic";
      img.src = user.profilePicUrl;
      const name = document.createElement("span");
      name.className = "user-name";
      name.textContent = user.username;
      div.appendChild(img);
      div.appendChild(name);
      div.onclick = () => {
        window.location.href = `userprofile.html?username=${encodeURIComponent(
          user.username
        )}`;
      };
      resultBox.appendChild(div);
    });
  };

  async function renderAllUsersGrid() {
    const container = document.getElementById("allUsersCards");
    if (!allUsers.length) await loadAllUsers();
    if (!allUsers.length) {
      container.innerHTML =
        "<div style='color:#bbbbbb;text-align:center;font-size:1.06rem;padding:25px;'>No users found ðŸ˜¢</div>";
      return;
    }
    container.innerHTML = "";
    allUsers.forEach((user) => {
      const userRow = document.createElement("div");
      userRow.className = "user-row";
      userRow.onclick = () => {
        window.location.href = `userprofile.html?username=${encodeURIComponent(
          user.username
        )}`;
      };

      const img = document.createElement("img");
      img.src = user.profilePicUrl;
      img.className = "user-pic";
      img.alt = `Profile pic of ${user.username}`;

      const info = document.createElement("div");
      info.className = "user-info";

      const uname = document.createElement("div");
      uname.className = "username";
      uname.textContent = user.username;

      const details = document.createElement("div");
      details.className = "details";
      details.textContent = `Age: ${user.age} | Country: ${user.country}`;

      info.appendChild(uname);
      info.appendChild(details);

      userRow.appendChild(img);
      userRow.appendChild(info);

      container.appendChild(userRow);
    });
  }

  window.addEventListener("DOMContentLoaded", renderAllUsersGrid);
</script>
</body>
</html>