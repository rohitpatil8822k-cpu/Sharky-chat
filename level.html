<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Sharky Chat â€” Level & XP</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6924983412433035"
     crossorigin="anonymous"></script>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600;700&family=Inter:wght@400;500&display=swap" rel="stylesheet"/>
  <style>
    *, *::before, *::after {
      box-sizing: border-box;
    }
    html, body {
      background: #0f172a;
      color: #cbd5e1;
      font-family: 'Inter', 'Segoe UI', Arial, Helvetica, sans-serif;
      margin: 0;
      padding: 0;
      min-height: 100vh;
      max-width: 480px;
      margin-left: auto;
      margin-right: auto;
      overflow-x: hidden;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      user-select: none;
      transition: background 0.3s, color 0.3s;
    }

    .top-bar {
        position: fixed;
        top: 0;
        left: 0;
        z-index: 2000;
        width: 100%;
        max-width: 480px;
        min-height: 50px;
        display: flex;
        align-items: center;
        padding: 0 16px;
        background: #182338;
        box-shadow: 0 2px 17px #10162325;
        transition: background 0.3s;
    }

    .back-btn {
        background: none;
        border: none;
        cursor: pointer;
        padding: 8px;
        color: #60a5fa;
        font-size: 1.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 9px;
        transition: background 0.16s, transform 0.2s;
        outline: none;
    }

    .back-btn:active {
        background: #20325c;
        transform: scale(0.93);
    }

    .back-btn svg {
        width: 24px;
        height: 24px;
        stroke: currentColor;
        stroke-width: 2.5;
        stroke-linecap: round;
        stroke-linejoin: round;
    }

    @keyframes notifpop {
      0% { transform: scale(1); }
      50% { transform: scale(1.18) rotate(-3deg); }
      100% { transform: scale(1) rotate(0deg); }
    }

    h1 {
      text-align: center;
      color: #60a5fa;
      font-family: 'Orbitron', monospace;
      font-weight: 600;
      font-size: 1.9rem;
      margin-top: 80px;
      margin-bottom: 36px;
      letter-spacing: 2px;
      user-select: text;
      text-shadow: 0 0 10px #60a5fa88;
    }

    .level-box {
      background: #1e293b;
      padding: 28px 32px;
      border-radius: 16px;
      box-shadow: 0 0 14px #3b82f6aa;
      text-align: center;
      margin: 0 20px 50px;
      transition: box-shadow 0.3s ease;
      user-select: text;
    }

    .level-box:hover {
      box-shadow: 0 0 30px #3b82f6cc, 0 0 50px #2563ebcc;
    }

    .level-info {
      font-size: 1.1rem;
      color: #a5b4fc;
      margin-bottom: 14px;
      font-weight: 500;
      letter-spacing: 0.06em;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      text-shadow: 0 0 6px #3b82f6aa;
    }

    .level-info svg {
      width: 20px;
      height: 20px;
      stroke: #60a5fa;
      stroke-width: 2;
      fill: transparent;
      filter: drop-shadow(0 0 4px #60a5faaa);
      animation: glowPulse 3s infinite ease-in-out alternate;
      flex-shrink: 0;
    }

    .xp-bar {
      background: #334155;
      border-radius: 14px;
      overflow: hidden;
      height: 22px;
      box-shadow: inset 0 0 10px #000c;
      margin-bottom: 20px;
      position: relative;
      will-change: transform;
      filter: drop-shadow(0 0 5px #2563eb66);
    }

    .xp-bar::before {
      content: 'XP Progress';
      position: absolute;
      left: 16px;
      top: 50%;
      transform: translateY(-50%);
      color: #93c5fdcc;
      font-weight: 600;
      font-size: 0.87rem;
      font-family: 'Orbitron', monospace;
      letter-spacing: 0.08em;
      pointer-events: none;
      user-select: none;
      text-shadow: 0 0 4px #2563ebaa;
    }

    .xp-fill {
      background: linear-gradient(90deg,#2563eb,#3b82f6);
      height: 100%;
      width: 0%;
      transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 0 12px #3b82f699;
      filter: drop-shadow(0 0 8px #2563ebaa);
      border-radius: 14px;
    }

    #rewardInfo {
      font-style: italic;
      color: #9ca3afaa;
      text-shadow: 0 0 8px #3b82f58a;
      font-size: 1rem;
      margin-bottom: 14px;
    }

    #coinsInfo {
      font-size: 1.15rem;
      color: #60a5fa;
      font-weight: 600;
      letter-spacing: 0.06em;
      text-shadow: 0 0 10px #3b82f6aa;
      user-select: text;
    }

    .popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.85);
      background: linear-gradient(135deg,#2563eb 0%,#3b82f6 100%);
      color: #e0e7ff;
      padding: 26px 38px;
      border-radius: 16px;
      box-shadow: 0 8px 28px #2563ebcc;
      font-family: 'Orbitron', monospace;
      font-size: 1.3rem;
      font-weight: 700;
      display: none;
      z-index: 9000;
      text-align: center;
      user-select: none;
      will-change: transform, opacity;
      transition: transform 0.35s ease, opacity 0.35s ease;
      letter-spacing: 0.12em;
    }

    .popup.show {
      display: block !important;
      transform: translate(-50%, -50%) scale(1);
      animation: popupBounce 0.6s ease forwards;
    }
    
    @keyframes glowPulse {
      0%, 100% { filter: drop-shadow(0 0 4px #3b82f6aa); }
      50% { filter: drop-shadow(0 0 14px #60a5faee); }
    }

    @keyframes popupBounce {
      0% { transform: translate(-50%, -50%) scale(0.85); opacity: 0; }
      50% { transform: translate(-50%, -50%) scale(1.1); opacity: 1; }
      100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
    }

    body.light-theme {
      background: #f5f6fa;
      color: #222c3b;
    }

    body.light-theme .top-bar {
      background: #eaf0fb;
      box-shadow: 0 2px 17px #e0e5f0;
    }

    body.light-theme .back-btn {
      color: #2563eb;
    }

    body.light-theme .back-btn:active {
      background: #dbeafe;
    }
  </style>
</head>
<body>

  <div class="top-bar">
    <button class="back-btn" id="backBtn" type="button" aria-label="Go back to previous page">
      <svg viewBox="0 0 24 24">
        <polyline points="15 18 9 12 15 6"></polyline>
      </svg>
    </button>
  </div>

  <h1>LEVEL PROGRESS</h1>

  <div class="level-box" aria-live="polite" aria-atomic="true" role="region" aria-label="User Level Progress">
    <div class="level-info" id="levelInfo" aria-label="Current Level">
      <svg aria-hidden="true" viewBox="0 0 24 24" fill="none" stroke="#60a5fa" stroke-linecap="round" stroke-linejoin="round" style="width:20px;height:20px;">
        <polygon points="12 2 15 9 22 9 17 14 19 21 12 17 5 21 7 14 2 9 9 9"></polygon>
      </svg>
      Level 1 - Beginner
    </div>
    <div class="xp-bar" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0" aria-label="Experience progress bar">
      <div class="xp-fill" id="xpFill"></div>
    </div>
    <div class="level-info" id="xpInfo" aria-label="Experience points">XP: 0 / 100</div>
    <div id="rewardInfo" aria-label="Current reward">Reward: None</div>
    <div class="level-info" id="coinsInfo" aria-label="Amount of Sharky coins"></div>
  </div>

  <div class="popup" id="levelUpPopup" aria-live="assertive" aria-atomic="true" role="alert" aria-hidden="true">Level Up! Coins Added</div>
  
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { 
      getFirestore, doc, getDoc, setDoc, addDoc, serverTimestamp, onSnapshot, collection, query, where, getDocs, updateDoc
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getDatabase, ref, onDisconnect, set as rset } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBGfgy9OeMTJ__oOAFxoBW-eIOYlvhObZM",
      authDomain: "sharky-chat-007.firebaseapp.com",
      projectId: "sharky-chat-007",
      storageBucket: "sharky-chat-007.appspot.com",
      messagingSenderId: "637104796242",
      appId: "1:637104796242:web:74ac36b86af91be15ea58b"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const rtdb = getDatabase(app);

    let uid = "";
    let level = 1, xp = 0, needed = 100;
    let myUsername = "";

    const levelData = {};
    for(let i=1; i<=100; i++) {
      levelData[i] = {
        title: `Level ${i}`,
        coins: i*10,
        reward: `+${i*10} Sharky Coins`
      };
    }

    const qp = sel => document.querySelector(sel);
    const levelInfo = qp("#levelInfo");
    const xpInfo = qp("#xpInfo");
    const xpFill = qp("#xpFill");
    const rewardInfo = qp("#rewardInfo");
    const coinsInfo = qp("#coinsInfo");
    const popup = qp("#levelUpPopup");
    const backBtn = qp("#backBtn");
    const themeSwitch = qp('#themeSwitch');
    
    function updateUI(coins){
      const title = levelData[level]?.title || "MAXED OUT";
      const reward = levelData[level]?.reward || "Special Bonus";
      levelInfo.innerHTML = `
        <svg aria-hidden="true" viewBox="0 0 24 24" fill="none" stroke="#60a5fa" stroke-linecap="round" stroke-linejoin="round" style="width:20px;height:20px;">
          <polygon points="12 2 15 9 22 9 17 14 19 21 12 17 5 21 7 14 2 9 9 9"/>
        </svg> Level ${level} - ${title}`;
      xpInfo.textContent = `XP: ${xp} / ${needed}`;  
      xpFill.style.width = (xp / needed * 100) + "%";
      qp(".xp-bar").setAttribute("aria-valuenow", Math.floor((xp / needed) * 100));
      rewardInfo.textContent = `Reward: ${reward}`;
      coinsInfo.textContent = `Sharky Coins: ${coins !== undefined ? coins : 0}`;
    }

    function showLevelUpPopup(){
      popup.setAttribute("aria-hidden", "false");
      popup.classList.add("show");
      setTimeout(() => {
        popup.classList.remove("show");
        popup.setAttribute("aria-hidden", "true");
      }, 1800);
    }

    async function gainXp(amount){
      xp += amount;
      let leveledUp = false;

      while(xp >= needed){
        xp -= needed;
        level++;
        if(level > 100) {
            level = 100;
            xp = 0;
            needed = 2100;
        } else {
            needed = Math.floor(100 + level * 20);
        }

        const coinsReward = levelData[level]?.coins || 0;
        if(coinsReward > 0){
          const walletRef = doc(db,"wallets",uid);
          const currentData = (await getDoc(walletRef)).data() || {};
          const newCoins = (currentData.sharkyCoin || 0) + coinsReward;
          await setDoc(walletRef, { sharkyCoin: newCoins }, {merge:true});
        }
        leveledUp = true;
        await addDoc(collection(db,"notifications"),{
          to: uid,
          type: "level-up",
          level: level,
          coins: coinsReward,
          seen: false,
          createdAt: serverTimestamp()
        });
      }
      if(leveledUp) showLevelUpPopup();
      
      await setDoc(doc(db,"levels",uid),{
        level: level,
        xp: xp,
        needed: needed,
        updatedAt: serverTimestamp()
      },{merge:true});
    }

    async function setupUserPresence(uid) {
        const userStatusRef = doc(db, "users", uid);
        const rtdbRef = ref(rtdb, "status/" + uid);

        await updateDoc(userStatusRef, {
            isOnline: true,
            lastSeen: serverTimestamp(),
            lastActive: serverTimestamp()
        }, { merge: true });
        
        await rset(rtdbRef, { state: "online", last_changed: serverTimestamp() });
        onDisconnect(rtdbRef).set({ state: "offline", last_changed: serverTimestamp() });
          
        let activityTimer;
        const updateActivity = () => {
            clearTimeout(activityTimer);
            updateDoc(userStatusRef, { isOnline: true, lastActive: serverTimestamp() }, { merge: true });
            
            activityTimer = setTimeout(async () => {
                await updateDoc(userStatusRef, { isOnline: false, lastSeen: serverTimestamp() }, { merge: true });
                rset(rtdbRef, { state: "idle", last_changed: serverTimestamp() });
            }, 300000);
        };

        ['mousemove', 'mousedown', 'keypress', 'scroll', 'touchstart'].forEach(event => 
            document.addEventListener(event, updateActivity, { passive: true })
        );
        updateActivity();
        
        window.addEventListener('beforeunload', async () => {
             await updateDoc(userStatusRef, { isOnline: false, lastSeen: serverTimestamp() }, { merge: true });
        });
    }


    function bumpBadge(el){
        if(!el) return;
        el.style.animation = "";
        setTimeout(() => { el.style.animation = "notifpop .34s"; }, 25);
    }

    function setupMenuNotifications(){
        onSnapshot(
          query(collection(db, "friendRequests"),
                where("to", "==", uid),
                where("status", "==", "pending")),
          (snap) => {
            const frCount = snap.size;
            const menuNotif = document.getElementById("menuNotif");
            const friendsNotif = document.getElementById("friends-notif");
            const messagesNotif = document.getElementById("messages-notif");

            let msgCount = parseInt(messagesNotif?.dataset?.count || "0") || 0;

            menuNotif.dataset.fr = frCount;
            friendsNotif.textContent = frCount > 99 ? "99+" : frCount;
            friendsNotif.style.display = frCount > 0 ? "inline-flex" : "none";

            const total = frCount + msgCount;
            menuNotif.textContent = total > 99 ? "99+" : total;
            menuNotif.style.display = total > 0 ? "inline-flex" : "none";

            bumpBadge(friendsNotif);
            bumpBadge(menuNotif);
          }
        );
    }

    async function setupMessageNotifications(){
        const friendsDoc = await getDocs(collection(db,"friends"));
        let myFriends = [];
        friendsDoc.forEach(docSnap=>{
          if(docSnap.id === uid && docSnap.data()) myFriends = Object.keys(docSnap.data());
        });
        if(!myFriends.length) return;

        let unseenTracker = {};
        let usernamesData = {};
        let myFriendsClean = myFriends.filter(id => id.length > 0);
        let batchSize = 10;

        for (let i = 0; i < myFriendsClean.length; i += batchSize) {
            let batch = myFriendsClean.slice(i, i + batchSize);
            const usersSnap = await getDocs(query(collection(db, "users"), where("__name__", "in", batch)));
            usersSnap.forEach((doc) => {
              usernamesData[doc.id] = doc.data()?.username || '';
            });
        }

        for(const fid of myFriendsClean){
          const friendUsername = usernamesData[fid];
          if(!friendUsername || friendUsername === myUsername) continue;

          const chatId = [myUsername, friendUsername].sort().join("_");
          const msgRef = collection(db,"personalMessages",chatId,"messages");
          onSnapshot(
            query(msgRef, where("recipient", "==", myUsername), where("seen", "==", false)),
            snap => {
              let unseen = 0;
              snap.forEach(doc => { if(doc.data().sender !== myUsername) unseen++; });
              unseenTracker[chatId] = unseen;
              updateBadges();
            }
          );
        }

        function updateBadges(){
          let totalUnseen = Object.values(unseenTracker).reduce((a,b)=>a+b,0);
          const messagesNotif = document.getElementById("messages-notif");
          const menuNotif = document.getElementById("menuNotif");
          
          messagesNotif.dataset.count = totalUnseen;
          messagesNotif.textContent = totalUnseen > 99 ? "99+" : totalUnseen;
          messagesNotif.style.display = totalUnseen > 0 ? "inline-flex" : "none";

          const frCount = parseInt(menuNotif.dataset.fr) || 0;
          const sum = frCount + totalUnseen;
          menuNotif.textContent = sum > 99 ? "99+" : sum;
          menuNotif.style.display = sum > 0 ? "inline-flex" : "none";

          bumpBadge(messagesNotif);
          bumpBadge(menuNotif);
        }
    }

    function setupWalletNotifications(){
      const notifCol = collection(db,"notifications");
      const notifQuery = query(notifCol,
                              where("to", "==", uid),
                              where("type", "==", "walletClaim"),
                              where("seen", "==", false));
      onSnapshot(notifQuery, snapshot => {
        updateWalletBadge(!snapshot.empty);
      });
    }

    function updateWalletBadge(show){
      const walletNotif = document.getElementById("wallet-notif");
      if(!walletNotif) return;
      if(show){
        walletNotif.textContent = "!";
        walletNotif.style.display = "inline-flex";
        bumpBadge(walletNotif);
      } else {
        walletNotif.style.display = "none";
        walletNotif.textContent = "0";
      }
    }

    backBtn.addEventListener("click", () => {
      window.history.back();
    });

    function setTheme(theme){
      if(theme === 'light'){
        document.body.classList.add('light-theme');
        localStorage.setItem('theme', 'light');
      } else {
        document.body.classList.remove('light-theme');
        localStorage.setItem('theme', 'dark');
      }
    }

    function toggleTheme(){
      if(document.body.classList.contains('light-theme')){
        setTheme('dark');
      } else {
        setTheme('light');
      }
    }

    window.addEventListener('DOMContentLoaded', () => {
      const savedTheme = localStorage.getItem('theme');
      if(savedTheme === 'light'){
        setTheme('light');
      } else {
        setTheme('dark');
      }
    });

    onAuthStateChanged(auth, async user => {
      if(!user){
        location.href = "login.html";
        return;
      }
      uid = user.uid;

      const userDoc = await getDoc(doc(db,"users",uid));
      if(userDoc.exists()) myUsername = userDoc.data().username || "";

      const docSnap = await getDoc(doc(db,"levels",uid));
      if(docSnap.exists()){
        const d = docSnap.data();
        level = d.level || 1;
        xp = d.xp || 0;
        needed = d.needed || 100;
      }

      onSnapshot(doc(db,"wallets",uid), snap => {
        const coins = (snap.exists() && snap.data().sharkyCoin) ? snap.data().sharkyCoin : 0;
        updateUI(coins);
      });
      updateUI();

      setupMenuNotifications();
      setupMessageNotifications();
      setupWalletNotifications();
      setupUserPresence(uid);
    });

    window.gainXp = gainXp;
  </script>
</body>
</html>