<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Sharky Chat â€” Friends</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0,user-scalable=no" />
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Roboto:wght@400;500;700&family=Poppins:wght@600;700&family=Inter:wght@400;600&display=swap" rel="stylesheet" />
<style>
  html, body {
    margin: 0; padding: 0; box-sizing: border-box;
    min-height: 100vh;
    width: 100%;
    overflow-x: hidden;
    background: #2e2e2e; 
    color: #f0f0f0;
    font-family: 'Inter', 'Roboto', Arial, sans-serif;
    transition: background 0.5s ease, color 0.5s ease;
  }

  header {
    background: #3a3a3a;
    position: fixed;
    top: 0;
    left: 0;
    z-index: 2000;
    width: 100vw;
    box-shadow: 0 2px 17px #00000033;
    min-height: 50px;
    user-select: none;
    transition: box-shadow 0.3s, background 0.5s ease;
  }
  .header-inner {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0 16px;
    min-height: 50px;
    position: relative;
    z-index: 1;
    font-family: "Poppins", Arial, sans-serif;
    font-size: 1.02rem;
    color: inherit;
  }
  .logo-container {
    display: flex;
    align-items: center;
    gap: 8px;
    user-select: none;
  }
  .logo-container img {
    height: 25px;
    animation: float 3.3s ease-in-out infinite;
    user-select: none;
    pointer-events: none;
  }
  @keyframes float {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-4px); }
  }
  .logo-text {
    font-family: "Orbitron", Arial, Helvetica, sans-serif;
    font-size: 1.02rem;
    color: #60a5fa;
    text-shadow: 0 0 7px #60a5fa74;
    font-weight: 800;
    letter-spacing: 0.055em;
    user-select: none;
  }
  .menu-btn {
    font-size: 1.5rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    min-width: 38px;
    height: 36px;
    color: #80caff;
    outline: none;
    border: none;
    background: none;
    border-radius: 9px;
    position: relative;
    transition: background 0.16s, transform 0.2s;
    user-select: none;
  }
  .menu-btn:active {
    background: #505050;
    transform: scale(0.93);
  }
  .menu-btn .notif-badge {
    background: linear-gradient(105deg, #f87171 65%, #fb923c 110%);
    color: white;
    font-weight: 700;
    font-family: "Orbitron", monospace;
    min-width: 12px;
    height: 12px;
    padding: 0 6px;
    font-size: 12px;
    border-radius: 50%;
    display: flex;
    justify-content: center;
    align-items: center;
    position: absolute;
    top: 1px;
    right: 1px;
    border: 1px solid #3a3a3a;
    box-shadow: 0 2px 6px #00000066;
    pointer-events: none;
    z-index: 10;
  }

  /* Menu Dropdown */
  .menu-dropdown {
    position: fixed;
    top: 0;
    right: -100%;
    height: 100vh;
    width: 220px;
    background: rgba(50, 50, 50, 0.98);
    box-shadow: -4px 0 26px rgba(0, 0, 0, 0.7);
    padding-top: 54px;
    padding-bottom: 22px;
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
    font-family: "Poppins", Arial, sans-serif;
    font-weight: 600;
    font-size: 0.85rem;
    overflow-y: auto;
    transition: right 0.35s cubic-bezier(0.65, 0.01, 0.32, 1.03);
    z-index: 2500;
    user-select: none;
  }
  header.expanded .menu-dropdown {
    right: 0;
  }
  .menu-dropdown .close-btn {
    position: absolute;
    left: 11px;
    top: 13px;
    background: transparent;
    border: none;
    cursor: pointer;
    padding: 0;
    outline: none;
    z-index: 2600;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.2s ease, color 0.3s;
    color: #8ca3ff;
  }
  .menu-dropdown .close-btn:hover,
  .menu-dropdown .close-btn:focus {
    color: #cab8ff;
    transform: scale(1.22);
  }
  .menu-dropdown .close-btn svg {
    width: 22px;
    height: 22px;
    stroke: currentColor;
    stroke-width: 2.5;
    stroke-linecap: round;
    stroke-linejoin: round;
  }
  .menu-dropdown a {
    color: #8ca3ff;
    padding: 13px 17px 13px 46px;
    text-decoration: none;
    border-bottom: 2px solid #4a4a4a;
    display: flex;
    align-items: center;
    gap: 15px;
    background: none;
    transition: background 0.13s, color 0.13s, padding-left 0.11s, transform 0.16s;
    letter-spacing: 0.02em;
    font-weight: 600;
    font-size: 0.85rem;
    position: relative;
  }
  .menu-dropdown a:hover,
  .menu-dropdown a:focus {
    background: #505050;
    color: #fff;
    padding-left: 51px;
    outline: none;
    transform: scale(1.05) translateX(-2px);
  }
  .menu-dropdown a:active {
    background: #333;
    color: #fbbf24;
    transform: scale(0.97);
  }
  .menu-dropdown .notif-badge {
    position: static;
    margin-left: 7px;
    box-shadow: none;
    border: none;
    font-weight: 700;
    font-family: "Orbitron", monospace;
    font-size: 13px;
    min-width: 22px;
    height: 18px;
    background: linear-gradient(120deg, #fae024 70%, #f87171 100%);
    color: #222b3a;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border-radius: 7px;
    user-select: none;
  }
  .menu-dropdown a .icon {
    display: inline-flex;
    width: 22px;
    height: 22px;
    position: absolute;
    left: 15px;
    top: 50%;
    transform: translateY(-50%);
    fill: #8ca3ff;
    filter: drop-shadow(0 1px 6px #8ca3ff66);
    transition: fill 0.13s, filter 0.11s;
  }
  .menu-dropdown a:hover .icon,
  .menu-dropdown a:focus .icon {
    fill: #fff;
    filter: drop-shadow(0 2px 8px #fff4);
  }

  main {
    padding: 68px 12px 12px 12px;
    max-width: 430px;
    margin: 0 auto;
    transition: color 0.3s, background 0.3s;
  }
  h1 {
    font-family: 'Poppins', Arial, sans-serif;
    font-size: 1.5rem;
    color: #89d8f4; 
    text-align: center;
    margin-bottom: 24px;
    letter-spacing: .03em;
    font-weight: 700;
    margin-top: 0;
    text-shadow: 0 2px 20px #89d8f42a;
    user-select: none;
  }
  .section-title {
    margin: 14px 0 7px 0;
    font-size: 1.09rem;
    color: #b0d0e0;
    border-bottom: 1.2px solid #555;
    padding-bottom: 4px;
    font-family: 'Poppins', Arial, sans-serif;
    letter-spacing: .01em;
    font-weight: 600;
    user-select: none;
    transition: color 0.3s ease;
  }
  .cards-container {
    margin-bottom: 17px;
    min-height: 40px;
    transition: all 0.3s ease;
  }
  .request-card, .friend-card {
    background: linear-gradient(106deg,#3a3a3a 82%,#4a4a4a 100%);
    border-radius: 13px;
    margin: 11px 0 0 0;
    display: flex;
    align-items: center;
    box-shadow: 0 2px 15px #00000044, 0 1.5px 5px #1e293b66;
    transition: transform 0.18s, box-shadow 0.13s, background 0.3s ease;
    padding: 9px 13px;
    border: 1.25px solid #555;
    gap: 0;
    font-family: 'Inter', Arial, sans-serif;
    user-select: none;
  }
  .request-card:hover, .friend-card:hover {
    transform: scale(1.012);
    box-shadow: 0 8px 32px #00000080;
    background: linear-gradient(111deg,#505050 80%,#606060 100%);
  }
  .avatar {
    width: 39px;
    height: 39px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid #89d8f4;
    margin-right: 8px;
    background: #262626;
    flex-shrink: 0;
    user-select: none;
  }
  .username {
    flex: 1;
    font-weight: 700;
    color: #89d8f4;
    font-size: 1.06rem;
    cursor: pointer;
    margin-right: 3px;
    text-overflow: ellipsis;
    white-space: nowrap;
    overflow: hidden;
    padding-right: 5px;
    font-family: 'Poppins', Arial, sans-serif;
    user-select: text;
  }
  .actions button {
    padding: 6px 12px;
    margin-left: 4px;
    background: #89d8f4;
    border: none;
    border-radius: 7px;
    color: #0f172a;
    cursor: pointer;
    font-size: 1.02rem;
    font-weight: 600;
    box-shadow: 0 1px 6px #00000033;
    outline: none;
    transition: background 0.14s, color 0.13s, transform 0.1s;
    font-family: 'Poppins', Arial, sans-serif;
    user-select: none;
  }
  .actions button.reject {
    background: #f87171;
    color: white;
  }
  .actions button.remove {
    background: #fbbf24;
    color: #573600;
  }
  .actions button:active {
    transform: scale(.96);
  }
  .empty-msg {
    color: #75879d;
    text-align: center;
    margin-top: 25px;
    font-size: 1.04rem;
    font-family: 'Inter', sans-serif;
    letter-spacing: .02em;
    user-select: none;
  }
  .card-loader {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-top: 26px;
    margin-bottom: 15px;
    user-select: none;
  }
  .spinner {
    width: 28px;
    height: 28px;
    border: 3px solid #555;
    border-top: 3px solid #89d8f4;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 12px;
    user-select: none;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  .loader-text {
    color: #b0d0e0;
    font-family: 'Poppins', Arial, sans-serif;
    font-size: 1.05rem;
    letter-spacing: 0.01em;
    user-select: none;
  }

  body.light-theme {
    background: #f0f0f0;
    color: #222c3b;
  }
  body.light-theme header {
    background: #e0e0e0;
    color: #222c3b;
  }
  body.light-theme .logo-text {
    color: #1d4ed8;
    text-shadow: 0 0 8px #60a5fa60;
  }
  body.light-theme .menu-btn {
    color: #2563eb;
  }
  body.light-theme .menu-dropdown {
    background: #eaf0fb;
    color: #1e293b;
    box-shadow: -4px 0 24px rgba(16, 24, 39, 0.09);
  }
  body.light-theme .menu-dropdown a {
    color: #2563eb;
    border-bottom: 1px solid #bfdbfe;
  }
  body.light-theme .menu-dropdown a:hover,
  body.light-theme .menu-dropdown a:focus {
    background: #dbeafe;
    color: #1e293b;
  }
  body.light-theme .menu-dropdown a:active {
    background: #dbeafe;
    color: #eab308;
  }
  body.light-theme .menu-dropdown .close-btn {
    color: #2563eb;
  }
  body.light-theme .menu-dropdown .close-btn:hover,
  body.light-theme .menu-dropdown .close-btn:focus {
    color: #a78bfa;
  }
  body.light-theme main {
    color: #222c3b;
  }
  body.light-theme .request-card,
  body.light-theme .friend-card {
    background: #e1e6f2;
    border: 1px solid #a0b9f9;
    box-shadow: 0 2px 15px #8eaaf0;
  }
  body.light-theme .request-card:hover,
  body.light-theme .friend-card:hover {
    background: #b3bef6;
    box-shadow: 0 8px 32px #5065e5;
  }
  body.light-theme .username {
    color: #2563eb;
  }
  body.light-theme .actions button {
    background: #3b82f6;
    color: white;
  }
  body.light-theme .actions button.reject {
    background: #ef4444;
    color: white;
  }
  body.light-theme .actions button.remove {
    background: #facc15;
    color: #573600;
  }

  @keyframes notifpop {
    0% { transform: scale(1); }
    50% { transform: scale(1.18) rotate(-3deg); }
    100% { transform: scale(1) rotate(0deg); }
  }
  
  /* AD Container Style (for footer ads) */
  .ad-banner-container {
      display: flex;
      justify-content: center;
      margin: 20px 0;
      max-width: 960px;
      width: 100%;
  }
</style>
</head>
<body>
<header id="mainHeader">
<div class="header-inner">
<div class="logo-container">
<img src="https://firebasestorage.googleapis.com/v0/b/sharky-chat-007.firebasestorage.app/o/gc-logo.png?alt=media&token=ddfe6e46-7351-4a07-8140-ea702b1bd823" alt="Sharky Logo" />
<div class="logo-text">SHARKY CHAT</div>
</div>
<button class="menu-btn" id="menuBtn" type="button" aria-label="Toggle menu">
â˜°
<span class="notif-badge" id="menuNotif" style="display:none;">0</span>
</button>
</div>
<nav class="menu-dropdown" role="menu" aria-label="Main Navigation">
<button class="close-btn" aria-label="Close menu" title="Close menu">
<svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
<line x1="18" y1="6" x2="6" y2="18" />
<line x1="6" y1="6" x2="18" y2="18" />
</svg>
</button>
<a href="profile.html" role="menuitem"><span class="icon"><svg viewBox="0 0 32 32"><circle cx="16" cy="12" r="7"/><ellipse cx="16" cy="23.5" rx="12" ry="6.5"/></svg></span>Profile</a>
<a href="chatrooms.html" role="menuitem"><span class="icon"><svg viewBox="0 0 32 32"><rect x="2" y="8" width="28" height="16" rx="5"/><rect x="12" y="6" width="8" height="4" rx="2"/><circle cx="7" cy="12" r="2"/><circle cx="25" cy="12" r="2"/></svg></span>Chat Rooms</a>
<a href="friends.html" role="menuitem">
<span class="icon"><svg viewBox="0 0 32 32"><circle cx="10" cy="12" r="5"/><circle cx="22" cy="12" r="5"/><ellipse cx="16" cy="23" rx="12" ry="6"/></svg></span>Friends
<span id="friends-notif" class="notif-badge" style="display:none;">0</span>
</a>
<a href="add-friends.html" role="menuitem"><span class="icon"><svg viewBox="0 0 32 32"><circle cx="15" cy="13" r="7"/><rect x="23" y="19" width="9" height="3" rx="1.5"/><rect x="26" y="16" width="3" height="9" rx="1.5"/></svg></span>Add Friend</a>
<a href="inbox.html" role="menuitem">
<span class="icon"><svg viewBox="0 0 32 32"><rect x="4" y="8" width="24" height="16" rx="4"/><polyline points="4,8 16,18 28,8" fill="none" stroke="#60a5fa" stroke-width="2"/></svg></span>Messages
<span id="messages-notif" class="notif-badge" style="display:none;">0</span>
</a>
<a href="wallet.html" role="menuitem">
<span class="icon"><svg viewBox="0 0 32 32"><rect x="4" y="10" width="24" height="12" rx="3"/><ellipse cx="24" cy="16" rx="2" ry="2"/><rect x="6" y="13" width="20" height="4" rx="2"/><circle cx="17" cy="16" r="2" fill="#fff"/></svg></span>Wallet
<span id="wallet-notif" class="notif-badge" style="display:none;">0</span>
</a>
<a href="shop.html" role="menuitem"><span class="icon"><svg viewBox="0 0 32 32"><rect x="6" y="13" width="20" height="9" rx="3"/><rect x="12" y="7" width="8" height="6" rx="2"/><rect x="13" y="22" width="6" height="4" rx="2"/><circle cx="10" cy="26" r="2"/><circle cx="22" cy="26" r="2"/></svg></span>Shop</a>
<a href="inventory.html" role="menuitem"><span class="icon"><svg viewBox="0 0 32 32"><rect x="7" y="10" width="18" height="12" rx="3"/><rect x="11" y="6" width="10" height="4" rx="2"/><rect x="13" y="22" width="6" height="4" rx="2"/><path d="M7 22h18"/><circle cx="16" cy="18" r="2"/></svg></span>Inventory</a>
<a href="news.html" role="menuitem"><span class="icon"><svg viewBox="0 0 32 32"><rect x="5" y="7" width="22" height="18" rx="4"/><rect x="9" y="11" width="14" height="2" rx="1"/><rect x="9" y="16" width="8" height="2" rx="1"/><circle cx="10" cy="21" r="2"/><rect x="14" y="20" width="7" height="2" rx="1"/></svg></span>News</a>
<a href="level.html" role="menuitem"><span class="icon"><svg viewBox="0 0 32 32"><path d="M16 5v17" stroke="#6699ff" stroke-width="2.5" stroke-linecap="round"/><circle cx="16" cy="26" r="5" fill="#38bdf8" stroke="#bae6fd" stroke-width="1.5"/><rect x="11" y="13" width="10" height="4" rx="2" fill="#bae6fd" /><rect x="13" y="8" width="6" height="3" rx="1.5" fill="#60a5fa"/></svg></span>Level</a>
<a href="refer.html" role="menuitem"><span class="icon"><svg viewBox="0 0 32 32"><circle cx="16" cy="16" r="13" fill="#5eead4" /><path d="M22.5,14h-8.7l3-3m-2.8,8a3,3,0,1,0-3,-3" stroke="#262626" stroke-width="2.3" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg></span>Refer A Friend</a>
<a href="verify-email.html" role="menuitem"><span class="icon"><svg viewBox="0 0 32 32"><rect x="5" y="8" width="22" height="16" rx="5"/><polyline points="5,8 16,18 27,8" fill="none" stroke="#2dd4bf" stroke-width="2"/><circle cx="16" cy="19" r="2.5"/></svg></span>Email Verification</a>
<a href="help.html" role="menuitem"><span class="icon"><svg viewBox="0 0 32 32"><circle cx="16" cy="16" r="12" fill="none" stroke="#fbbf24" stroke-width="2"/><text x="16" y="20" text-anchor="middle" fill="#fbbf24" font-size="8" font-family="Orbitron">?</text></svg></span>Help</a>
<a href="social-media.html" role="menuitem"><span class="icon"><svg viewBox="0 0 32 32"><circle cx="8" cy="12" r="3"/><circle cx="24" cy="12" r="3"/><circle cx="16" cy="22" r="3"/><line x1="8" y1="15" x2="16" y2="19" stroke="#60a5fa" stroke-width="2"/><line x1="24" y1="15" x2="16" y2="19" stroke="#60a5fa" stroke-width="2"/></svg></span>Social Media</a>
<a href="#" id="themeSwitch" role="menuitem"><span class="icon"><svg viewBox="0 0 32 32"><circle cx="16" cy="16" r="12"/><path d="M16 4v8"/><circle cx="16" cy="16" r="5" fill="#fff"/></svg></span>Change Theme</a>
</nav>
</header>

<main>
<h1>Friends</h1>
<div class="section-title">ðŸ‘‹ Friend Requests (Received)</div>
<div id="requests" class="cards-container"></div>
<div class="section-title">ðŸ“¤ Friend Requests (Sent)</div>
<div id="sentRequests" class="cards-container"></div>
<div class="section-title">âœ… Your Friends</div>
<div id="friends" class="cards-container"></div>
</main>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { 
    getAuth, 
    onAuthStateChanged 
  } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import { 
    getFirestore, 
    doc, getDoc, setDoc, deleteDoc, updateDoc, deleteField,
    collection, onSnapshot, getDocs, query, where, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
  import { 
    getDatabase, 
    ref, 
    onDisconnect, 
    set as rset, 
    serverTimestamp as rtdbServerTimestamp 
  } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBGfgy9OeMTJ__oOAFxoBW-eIOYlvhObZM",
    authDomain: "sharky-chat-007.firebaseapp.com",
    projectId: "sharky-chat-007",
    storageBucket: "sharky-chat-007.appspot.com",
    messagingSenderId: "637104796242",
    appId: "1:637104796242:web:74ac36b86af91be15ea58b"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);
  const rtdb = getDatabase(app);

  let myUsername = "";
  let myUID = "";

  function bumpBadge(el) {
    if (!el) return;
    el.style.animation = "";
    setTimeout(() => {
      el.style.animation = "notifpop .34s";
    }, 25);
  }

  function bumpBadgeDropdown(el) {
    if (!el) return;
    el.style.animation = "";
    setTimeout(() => {
      el.style.animation = "notifpop .33s";
    }, 30);
  }

  function updateWalletBadge(show) {
    const walletNotif = document.getElementById("wallet-notif");
    if (!walletNotif) return;
    if (show) {
      walletNotif.textContent = "!";
      walletNotif.style.display = "inline-flex";
      bumpBadgeDropdown(walletNotif);
    } else {
      walletNotif.style.display = "none";
      walletNotif.textContent = "0";
    }
  }

  function setupMenuNotifications(uid, username) {
    onSnapshot(
      query(
        collection(db, "friendRequests"),
        where("to", "==", uid),
        where("status", "==", "pending")
      ),
      (snap) => {
        const frCount = snap.size;
        const menuNotif = document.getElementById("menuNotif");
        const friendsNotif = document.getElementById("friends-notif");
        const messagesNotif = document.getElementById("messages-notif");
        let msgCount = parseInt(messagesNotif.dataset.count) || 0;

        menuNotif.dataset.fr = frCount;
        friendsNotif.textContent = frCount > 99 ? "99+" : frCount;
        friendsNotif.style.display = frCount > 0 ? "inline-flex" : "none";

        const total = frCount + msgCount;
        menuNotif.textContent = total > 99 ? "99+" : total;
        menuNotif.style.display = total > 0 ? "inline-flex" : "none";

        bumpBadge(friendsNotif);
        bumpBadge(menuNotif);
      }
    );
  }

  async function setupMessageNotifications(uid, username) {
    const myFriendsDoc = await getDocs(collection(db, "friends"));
    let myFriends = [];
    myFriendsDoc.forEach((docSnap) => {
      if (docSnap.id === uid && docSnap.data()) myFriends = Object.keys(docSnap.data());
    });
    if (!myFriends.length) return;
    let unseenTracker = {};
    let usernamesData = {};
    
    let snap = await getDocs(
      query(collection(db, "users"), where("__name__", "in", myFriends.slice(0, 10)))
    );
    snap.forEach((d) => {
      usernamesData[d.id] = d.data().username;
    });
    if (myFriends.length > 10) {
      for (let i = 10; i < myFriends.length; i += 10) {
        let s = await getDocs(
          query(collection(db, "users"), where("__name__", "in", myFriends.slice(i, i + 10)))
        );
        s.forEach((d) => {
          usernamesData[d.id] = d.data().username;
        });
      }
    }

    function updateBadges() {
      let totalUnseen = Object.values(unseenTracker).reduce((a, b) => a + b, 0);
      const messagesNotif = document.getElementById("messages-notif");
      const menuNotif = document.getElementById("menuNotif");
      const friendsNotif = document.getElementById("friends-notif");

      messagesNotif.dataset.count = totalUnseen;
      messagesNotif.textContent = totalUnseen > 99 ? "99+" : totalUnseen;
      messagesNotif.style.display = totalUnseen > 0 ? "inline-flex" : "none";

      const frCount = parseInt(menuNotif.dataset.fr) || 0;
      const sum = frCount + totalUnseen;
      
      menuNotif.textContent = sum > 99 ? "99+" : sum;
      menuNotif.style.display = sum > 0 ? "inline-flex" : "none";

      bumpBadge(messagesNotif);
      bumpBadge(menuNotif);
    }

    for (const fid of myFriends) {
      const friendUsername = usernamesData[fid];
      if (!friendUsername || friendUsername === username) continue;
      const chatId = [username, friendUsername].sort().join("_");
      const msgRef = collection(db, "personalMessages", chatId, "messages");
      onSnapshot(
        query(
          msgRef,
          where("recipient", "==", username),
          where("seen", "==", false)
        ),
        (snap) => {
          let unseen = 0;
          snap.forEach((doc) => {
            if (doc.data().sender !== username) unseen++;
          });
          unseenTracker[chatId] = unseen;
          updateBadges();
        }
      );
    }
  }

  function setupWalletNotifications(uid) {
    const notifCol = collection(db, "notifications");
    const notifQuery = query(
      notifCol,
      where("to", "==", uid),
      where("type", "==", "walletClaim"),
      where("seen", "==", false)
    );
    onSnapshot(notifQuery, (snapshot) => {
      const hasUnseen = !snapshot.empty;
      updateWalletBadge(hasUnseen);
    });
  }

  // --- ACTIVE USER PRESENCE LOGIC START (Firestore) ---
  const userRef = (uid) => doc(db, "users", uid);

  async function updatePresence(uid, active) {
    if (!uid) return;
    const updateData = {
        active: active,
        lastActive: serverTimestamp() 
    };
    try {
        await updateDoc(userRef(uid), updateData);
    } catch (error) {
        if (error.code === 'not-found') {
            await setDoc(userRef(uid), updateData, { merge: true });
        }
    }
  }

  function setupPresenceListeners(uid) {
      if (!uid) return;
      updatePresence(uid, true); 

      const setInactive = () => updatePresence(uid, false);
      
      window.addEventListener('beforeunload', setInactive);
      window.addEventListener('blur', () => updatePresence(uid, false));
      window.addEventListener('focus', () => updatePresence(uid, true));
      
      // Update every minute to keep active status current
      setInterval(() => updatePresence(uid, true), 60000); 
  }
  // --- ACTIVE USER PRESENCE LOGIC END ---

  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      window.location.href = "index.html";
      return;
    }
    myUID = user.uid;
    let snap = await getDocs(
      query(collection(db, "users"), where("__name__", "==", user.uid))
    );
    snap.forEach((docSnap) => {
      myUsername = docSnap.data().username || "";
    });
    setupMenuNotifications(user.uid, myUsername);
    setupMessageNotifications(user.uid, myUsername);
    setupWalletNotifications(user.uid);
    
    // CALL PRESENCE LISTENER
    setupPresenceListeners(user.uid); 

    loadReceivedRequests(myUID);
    loadSentRequests(myUID);
    loadFriends(myUID);
  });

  function loadReceivedRequests(uid) {
    const container = document.getElementById("requests");
    container.innerHTML = `<div class="card-loader"><div class="spinner"></div><div class="loader-text">Loading requests...</div></div>`;
    const q = query(collection(db, "friendRequests"), where("to", "==", uid), where("status", "==", "pending"));
    onSnapshot(q, async snapshot => {
      container.innerHTML = "";
      if (snapshot.empty) {
        container.innerHTML = `<div class="empty-msg">No pending requests ðŸŽ‰</div>`;
        return;
      }
      for (const docSnap of snapshot.docs) {
        const req = docSnap.data();
        let fromUid = req.from;
        let userSnap = await getDoc(doc(db, "users", fromUid));
        let info = userSnap.exists() ? userSnap.data() : {};
        let uname = req.fromName || info.username || 'Unknown';
        let pic = info.profilePic || "https://cdn-icons-png.flaticon.com/512/149/149071.png";
        const card = document.createElement("div");
        card.className = "request-card";
        card.innerHTML = `
          <img class="avatar" src="${pic}" />
          <div class="username" onclick="window.location.href='userprofile.html?username=${encodeURIComponent(uname)}'">${uname}</div>
          <div class="actions">
            <button onclick="accept('${docSnap.id}','${fromUid}','${req.to}')">Accept</button>
            <button class="reject" onclick="reject('${docSnap.id}')">Reject</button>
          </div>
        `;
        container.appendChild(card);
      }
    });
  }
  function loadSentRequests(uid) {
    const container = document.getElementById("sentRequests");
    container.innerHTML = `<div class="card-loader"><div class="spinner"></div><div class="loader-text">Loading...</div></div>`;
    const q = query(collection(db, "friendRequests"), where("from", "==", uid), where("status", "==", "pending"));
    onSnapshot(q, async snapshot => {
      container.innerHTML = "";
      if (snapshot.empty) {
        container.innerHTML = `<div class="empty-msg">No pending requests sent.</div>`;
        return;
      }
      for (const docSnap of snapshot.docs) {
        const req = docSnap.data();
        let toUid = req.to;
        let userSnap = await getDoc(doc(db, "users", toUid));
        let info = userSnap.exists() ? userSnap.data() : {};
        let uname = req.toName || info.username || 'Unknown';
        let pic = info.profilePic || "https://cdn-icons-png.flaticon.com/512/149/149071.png";
        const card = document.createElement("div");
        card.className = "request-card";
        card.innerHTML = `
          <img class="avatar" src="${pic}" />
          <div class="username" onclick="window.location.href='userprofile.html?username=${encodeURIComponent(uname)}'">${uname}</div>
          <div class="actions">
            <button class="reject" onclick="cancelSentRequest('${docSnap.id}')">Cancel</button>
          </div>
        `;
        container.appendChild(card);
      }
    });
  }
  function loadFriends(uid) {
    const friendsDiv = document.getElementById("friends");
    friendsDiv.innerHTML = `<div class="card-loader"><div class="spinner"></div><div class="loader-text">Loading friends...</div></div>`;
    onSnapshot(doc(db, "friends", uid), async (snap) => {
      friendsDiv.innerHTML = "";
      if (!snap.exists() || !snap.data() || Object.keys(snap.data()).length === 0) {
        friendsDiv.innerHTML = `<div class="empty-msg">No friends yet. Make some friends!</div>`;
        return;
      }
      for (const friendUid of Object.keys(snap.data())) {
        const userSnap = await getDoc(doc(db, "users", friendUid));
        if (userSnap.exists()) {
          const info = userSnap.data();
          const pic = info.profilePic || "https://cdn-icons-png.flaticon.com/512/149/149071.png";
          const card = document.createElement("div");
          card.className = "friend-card";
          card.innerHTML = `
            <img class="avatar" src="${pic}" />
            <div class="username" onclick="window.location.href='userprofile.html?username=${encodeURIComponent(info.username)}'">${info.username}</div>
            <div class="actions">
              <button class="remove" onclick="removeFriend('${friendUid}')">Remove</button>
            </div>
          `;
          friendsDiv.appendChild(card);
        }
      }
    });
  }

  window.accept = async function(docId, fromUid, toUid) {
    await setDoc(doc(db, "friends", toUid), { [fromUid]: true }, { merge: true });
    await setDoc(doc(db, "friends", fromUid), { [toUid]: true }, { merge: true });
    await updateDoc(doc(db, "friendRequests", docId), { status: "accepted" });
    alert("Friend request accepted ðŸŽ‰");
  };
  window.reject = async function(docId) {
    await updateDoc(doc(db, "friendRequests", docId), { status: "rejected" });
  };
  window.cancelSentRequest = async function(docId) {
    await deleteDoc(doc(db,"friendRequests",docId));
    alert("Friend request canceled!");
  };
  window.removeFriend = async function(friendUid) {
    await updateDoc(doc(db, "friends", auth.currentUser.uid), {
      [friendUid]: deleteField()
    });
    await updateDoc(doc(db, "friends", friendUid), {
      [auth.currentUser.uid]: deleteField()
    });
  };

  const mainHeader = document.getElementById("mainHeader");
  document.getElementById("menuBtn").addEventListener("click", (e) => {
    mainHeader.classList.toggle("expanded");
    e.stopPropagation();
  });
  document.querySelector(".menu-dropdown .close-btn").addEventListener("click", (e) => {
    mainHeader.classList.remove("expanded");
    e.stopPropagation();
  });
  document.addEventListener("click", (e) => {
    if (!mainHeader.contains(e.target)) mainHeader.classList.remove("expanded");
  });
  document.querySelector(".menu-dropdown").addEventListener("click", (e) => {
    if (e.target.tagName === "A") mainHeader.classList.remove("expanded");
  });

  const themeSwitch = document.getElementById("themeSwitch");
  function setTheme(theme) {
    if (theme === "light") {
      document.body.classList.add("light-theme");
      localStorage.setItem("sharky-chat-theme", "light");
    } else {
      document.body.classList.remove("light-theme");
      localStorage.setItem("sharky-chat-theme", "dark");
    }
  }
  function toggleTheme() {
    if(document.body.classList.contains("light-theme")) {
      setTheme("dark");
    } else {
      setTheme("light");
    }
  }
  themeSwitch.addEventListener("click", (e) => {
    e.preventDefault();
    toggleTheme();
  });
  (() => {
    const savedTheme = localStorage.getItem("sharky-chat-theme");
    if(savedTheme === "light") {
      setTheme("light");
    } else {
      setTheme("dark");
    }
  })();

</script>
<script type='text/javascript' src='//charmingpoliteinjunction.com/8c/81/93/8c81935dba237bd524ee7b49d4d6398a.js'></script>

<script type='text/javascript' src='//charmingpoliteinjunction.com/22/49/48/224948d8c4149a4d7c99d4253beac6ed.js'></script>
</body>
</html>