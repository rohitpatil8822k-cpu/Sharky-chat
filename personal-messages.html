<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Personal Chat - Sharky Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6924983412433035"
     crossorigin="anonymous"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Roboto:wght@400;500&family=Orbitron:wght@700&family=Poppins:wght@600;700&display=swap" rel="stylesheet"/>
  
  <style>
    :root {
      --color-dark-bg: #101018; 
      --color-mid-bg: #1a1a24; 
      --color-header: #212130; 
      --color-primary: #00e0ff; 
      --color-secondary: #ff33cc; 
      --color-text-light: #e0e0f0;
      --color-text-mute: #8a8a9e;
      --shadow-neon: 0 0 8px rgba(0, 224, 255, 0.5);
      --bubble-self: #007bff; 
      --bubble-other: #2c2c40; 
    }

    html,body{
      width:100vw;height:100vh;padding:0;margin:0;
      min-height:100svh;min-width:100vw;
      overscroll-behavior:contain;
      background: linear-gradient(135deg, var(--color-dark-bg) 0%, #000000 100%);
      box-sizing:border-box;
      overflow-x: hidden; 
      font-family: "Inter", Arial, sans-serif;
    }
    body{
      min-height:100svh; min-width:100vw;
      width:100vw; height:100svh;
      display:flex; justify-content:center; align-items:flex-start;
      padding-top: 45px; 
      color: var(--color-text-light);
    }
    
    header {
      background: var(--color-header);
      position: fixed;
      top: 0;
      left: 0;
      z-index: 2000;
      width: 100vw;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.7); 
      min-height: 45px;
      height: 45px;
      user-select: none;
      border-radius: 0;
      color: var(--color-text-light);
      font-family: "Poppins", Arial, sans-serif;
      font-size: 0.95rem; 
      border-bottom: 1px solid rgba(0, 224, 255, 0.1); 
    }
    .header-inner {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 16px;
      min-height: 45px;
      height: 45px;
      position: relative;
      cursor: default;
    }
    .logo-container {
      display: flex;
      align-items: center;
      gap: 8px;
      -webkit-tap-highlight-color: transparent;
    }
    .logo-container img {
      height: 28px; 
      animation: float 3.3s ease-in-out infinite;
      user-select: none;
      pointer-events: none;
      filter: drop-shadow(0 0 3px rgba(0, 224, 255, 0.3));
      image-rendering: crisp-edges;
    }
    @keyframes float {
      0%, 100% { transform: translateY(0) rotate(0deg); }
      50% { transform: translateY(-4px) rotate(1deg); }
    }
    .logo-text {
      font-family: "Orbitron", Arial, Helvetica, sans-serif;
      font-size: 1.1rem;
      color: var(--color-primary);
      text-shadow: 0 0 8px rgba(0, 224, 255, 0.7); 
      font-weight: 800;
      letter-spacing: 0.1em;
      margin-left: 2px;
      user-select: none;
      white-space: nowrap;
    }
    .menu-btn {
      font-size: 1.4rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      min-width: 36px;
      height: 34px;
      color: var(--color-primary);
      outline: none;
      border: 1px solid var(--color-primary); 
      background: rgba(0, 0, 0, 0.1);
      border-radius: 6px;
      position: relative;
      user-select: none;
      box-shadow: 0 0 4px var(--color-primary);
      -webkit-tap-highlight-color: transparent;
      transition: background 0.16s, transform 0.2s cubic-bezier(0.4, 0, 0.2, 1), box-shadow 0.2s;
      gap: 6px;
    }
    .menu-btn:active {
      background: var(--color-primary);
      color: var(--color-header);
      transform: scale(0.93);
      box-shadow: none;
    }
    .menu-btn .notif-badge {
      background: var(--color-secondary);
      color: white;
      font-weight: 700;
      font-family: "Orbitron", sans-serif;
      min-width: 13px;
      height: 13px;
      padding: 0 5px;
      font-size: 11px;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      position: absolute;
      top: -3px;
      right: -3px;
      border: 1px solid var(--color-header);
      box-shadow: 0 1px 5px rgba(255, 51, 204, 0.7); 
      pointer-events: none;
      z-index: 10;
      user-select: none;
    }
    .menu-dropdown {
      position: fixed;
      top: 0;
      right: -100%;
      height: 100vh;
      width: 220px;
      background: rgba(33, 33, 48, 0.98); 
      box-shadow: -6px 0 30px rgba(0, 0, 0, 0.9);
      padding-top: 50px; 
      padding-bottom: 20px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      font-family: "Poppins", Arial, sans-serif;
      font-weight: 600;
      font-size: 0.85rem;
      overflow-y: auto;
      transition: right 0.31s cubic-bezier(0.65, 0.01, 0.32, 1.03);
      z-index: 2500;
      user-select: none;
      color: var(--color-text-light);
      border-left: 2px solid var(--color-primary);
    }
    header.expanded .menu-dropdown {
      right: 0;
    }
    .menu-dropdown .close-btn {
      position: absolute;
      left: 11px;
      top: 10px;
      background: transparent;
      border: none;
      cursor: pointer;
      padding: 0;
      outline: none;
      z-index: 2600;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.2s ease;
      color: var(--color-primary);
      user-select: none;
    }
    .menu-dropdown .close-btn:hover,
    .menu-dropdown .close-btn:focus {
      color: var(--color-text-light);
      transform: scale(1.22);
    }
    .menu-dropdown .close-btn svg {
      width: 20px;
      height: 20px;
      stroke: currentColor;
      stroke-width: 2.5;
      stroke-linecap: round;
      stroke-linejoin: round;
      user-select: none;
    }
    .menu-dropdown a {
      color: var(--color-text-light);
      padding: 11px 17px 11px 44px;
      text-decoration: none;
      border-bottom: 1px solid var(--color-mid-bg);
      display: flex;
      align-items: center;
      gap: 15px;
      background: none;
      transition: background 0.13s, color 0.13s, padding-left 0.11s, transform 0.16s;
      letter-spacing: 0.02em;
      user-select: none;
      font-weight: 600;
      font-size: 0.82rem;
      will-change: transform;
      position: relative;
    }
    .menu-dropdown a:hover,
    .menu-dropdown a:focus {
      background: #2c2c40;
      color: var(--color-primary);
      padding-left: 49px;
      outline: none;
      transform: scale(1.01) translateX(-1px);
    }
    .menu-dropdown a:active {
      background: var(--color-mid-bg);
      color: var(--color-secondary);
      transform: scale(0.98);
    }
    .menu-dropdown .notif-badge {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      box-shadow: none;
      border: none;
      font-weight: 700;
      font-size: 12px;
      min-width: 20px;
      height: 17px;
      background: linear-gradient(120deg, var(--color-secondary) 70%, #ff66e0 100%);
      color: var(--color-header);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-family: "Poppins", sans-serif;
      border-radius: 6px;
      user-select: none;
      padding: 0 5px;
      line-height: 17px;
      white-space: nowrap;
    }
    .menu-dropdown a .icon {
      display: inline-flex;
      width: 20px;
      height: 20px;
      position: absolute;
      left: 13px;
      top: 50%;
      transform: translateY(-50%);
      fill: var(--color-text-mute);
      filter: drop-shadow(0 0 2px var(--color-text-mute));
      transition: fill 0.13s, filter 0.11s;
      user-select: none;
    }
    .menu-dropdown a:hover .icon,
    .menu-dropdown a:focus .icon {
      fill: var(--color-primary);
      filter: drop-shadow(0 0 5px var(--color-primary));
    }
    
    .main-wrap {
      width:100vw;max-width:380px;min-width:290px;
      height:calc(100svh - 45px);
      max-height:calc(100svh - 45px);
      min-height:350px;
      background: var(--color-mid-bg);
      margin:0 auto;
      box-shadow:0 0 0 2px rgba(0, 224, 255, 0.1);
      border-radius:18px;
      display:flex;flex-direction:column;
      position:relative;
      overflow:hidden; 
      justify-content:flex-start;
      margin-top: -45px;
    }

    .chat-header-sticky {
      flex-shrink:0;display:flex;align-items:center;gap:12px;
      padding:0 12px 0 4px;
      border-bottom:2px solid var(--color-primary); 
      background:var(--color-header); 
      height:55px;
      min-height:55px;
      z-index:101;
      margin:0;
      position: fixed;
      top: 45px;
      left: 50%;
      transform: translateX(-50%);
      width: 100%;
      max-width: 380px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
      border-top-left-radius: 0;
      border-top-right-radius: 0;
    }
    
    .back-btn {background:none;border:none;cursor:pointer;padding:8px;display:flex;align-items:center;border-radius:50%;margin-right:6px;transition:background .15s;font-size:1.04rem; color: var(--color-text-mute);}
    .back-btn:focus,.back-btn:hover {background:#353545;}
    .back-icon {width:20px;height:20px;}
    .back-icon path{stroke: var(--color-primary);}

    .chat-part-pic {
      width:38px; height:38px; min-width:38px; min-height:38px; border-radius:50%;
      border:2px solid var(--color-secondary);
      object-fit:cover; background:#212128;
      box-shadow:0 0 0 1px rgba(255, 51, 204, 0.3); 
      transition: none; aspect-ratio:1/1; display:block;
    }
    .user-name-status-wrap {display:flex;flex-direction:column;align-items:flex-start;margin-right:15px;}
    .chat-part-name{
      font-family:'Inter',sans-serif;
      color:var(--color-text-light);
      font-size:1.0rem;
      font-weight:700;
      max-width:44vw;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
      text-shadow: 0 0 2px rgba(0, 0, 0, 0.5);
    }
    .user-status{
      font-size:.8rem;
      font-family:'Roboto',sans-serif;
      margin-top:2px;
      line-height: 1.2;
    }
    .user-status.green{color:#4ade80;font-weight:600;}
    .user-status.gray{color:var(--color-text-mute);font-weight:500;}

    .header-action-btn{
      background:var(--color-mid-bg);
      color:var(--color-primary);border:1px solid var(--color-primary);
      border-radius:6px;
      padding:4px 8px;font-weight:700;cursor:pointer;
      font-size:.7rem;margin-right:2px;
      min-width:28px; margin-left:5px;
      transition: background .2s, transform .1s;
    }
    .header-action-btn:hover{background:var(--color-primary); color:var(--color-header); transform: translateY(-1px);}
    .block-btn{background:var(--color-secondary)!important;color:white!important; border: 1px solid var(--color-secondary)!important;}
    .block-btn:hover{background:#cc0099!important;}
    .chat-header-sticky > .header-action-btn,
    .chat-header-sticky > .block-btn {margin-left:auto;}
    .chat-header-sticky > .block-btn {margin-left:5px;}

    /* * Loading Overlay Styles 
    */
    .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: var(--color-mid-bg);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        opacity: 1;
        transition: opacity 0.5s;
        pointer-events: auto;
    }
    .loading-overlay.hidden {
        opacity: 0;
        pointer-events: none;
    }
    .loader {
        width: 50px;
        height: 50px;
        border: 5px solid rgba(0, 224, 255, 0.2);
        border-top-color: var(--color-primary);
        border-radius: 50%;
        animation: spin 1s ease-in-out infinite;
        margin-bottom: 15px;
        box-shadow: 0 0 10px rgba(0, 224, 255, 0.5);
    }
    .loading-text {
        color: var(--color-primary);
        font-family: 'Orbitron', sans-serif;
        font-size: 1.1rem;
        text-shadow: 0 0 5px rgba(0, 224, 255, 0.7);
    }
    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    .chat-box{
      flex:1 1 auto;
      overflow-y:auto;
      display:flex;flex-direction:column;gap:10px;
      padding:15px 12px;
      width:100%;background:none;scroll-behavior:smooth;margin:0;
      margin-top: 100px; 
      margin-bottom: 75px; /* Adjusted to accommodate new input bar and footer */
      opacity: 0; /* Chat box hidden initially */
      transition: opacity 0.5s ease-in;
    }
    .chat-box.loaded {
        opacity: 1; /* Make visible when loaded */
    }

    .message-row{display:flex;align-items:flex-end;width:100%;margin-bottom:0;z-index:1;}
    .message-row.own{justify-content:flex-end;}
    .message-bubble{
      font-family:'Roboto',Arial,sans-serif;
      background:var(--bubble-other);
      color:var(--color-text-light);
      padding:10px 15px;
      border-radius:15px 15px 15px 4px;
      max-width:calc(80% - 20px);
      word-break:break-word;position:relative;font-size:0.95rem;font-weight:400;
      box-shadow:0 1px 4px rgba(0, 0, 0, 0.2);
      border:none;
      min-width:25px;letter-spacing:.01em;
      transition:transform .15s, background .15s, box-shadow .15s;
      animation:bubbleUp .22s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      cursor:pointer;z-index:10;display:flex;flex-direction:column;
    }
    .message-bubble:hover { box-shadow:0 2px 8px rgba(0, 0, 0, 0.4); }
    .message-row.own .message-bubble{
      background:var(--bubble-self);
      color:#fff;
      border-radius:15px 15px 4px 15px;
      box-shadow:0 1px 5px rgba(0, 123, 255, 0.6);
      align-self:flex-end;
    }
    .message-row.own .message-bubble:hover{ box-shadow:0 2px 8px rgba(0, 123, 255, 0.8); }

    .message-bubble.media {
        padding: 6px;
        max-width: 200px;
        min-width: unset;
        background: var(--color-mid-bg);
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.3);
    }
    .message-row.own .message-bubble.media {
        background: var(--bubble-self);
        box-shadow: 0 1px 4px rgba(0, 123, 255, 0.6);
    }
    .message-bubble.media img {
        display: block;
        max-width: 100%;
        border-radius: 10px;
        object-fit: contain;
    }
    .message-bubble.media audio {
        width: 100%;
        max-width: 190px;
        display: block;
        margin-top: 4px;
        border-radius: 8px;
        background: rgba(0, 0, 0, 0.2);
        outline: none;
    }
    .message-bubble.sticker img {
        width: 100px;
        height: 100px;
        border-radius: 0;
        margin: 0;
        padding: 0;
        background: none;
    }
    .message-bubble.sticker {
        padding: 0;
        background: none;
        box-shadow: none;
        min-width: unset;
        max-width: 110px;
        animation:stickerPop .22s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    @keyframes stickerPop{
        from{transform:scale(0.8);opacity:0;}
        to{transform:scale(1);opacity:1;}
    }
    .message-row.own .message-bubble.sticker {
        background: none;
        box-shadow: none;
    }
    
    .bubble-menu-btn{
      background:none;border:none;outline:none;position:absolute;
      top:4px;right:4px;font-size:1.16rem;color:var(--color-text-mute);opacity:0.8;
      cursor:pointer;border-radius:50%;width:28px;height:28px;
      display:flex;align-items:center;justify-content:center;z-index:12;
      transition:background .13s;
    }
    .bubble-menu-btn:hover, .bubble-menu-btn:focus{background:rgba(255, 255, 255, 0.1); color:#fff;}

    .bubble-menu-pop{
      position:absolute;top:4px;right:34px;
      z-index:200;background:var(--color-header);
      border-radius:10px;
      box-shadow:0 6px 20px rgba(0, 0, 0, 0.5);
      border:1px solid #3c3c50;
      min-width:38px;display:flex;flex-direction:row;opacity:0;pointer-events:none;transform:translateX(0);transition:opacity 0.18s, transform 0.22s;
      will-change:transform,opacity;
    }
    .bubble-menu-pop.menu-open {
      opacity:1; pointer-events:auto; transform:translateX(-10px);
    }
    .bubble-menu-pop button{
      background:none;border:none;color:var(--color-text-light);padding:10px 14px;cursor:pointer;
      font-size:1.1rem; border:none;transition:background .11s;
    }
    .bubble-menu-pop button:hover{background:#353545;}

    .bubble-edit-input{
        font-size:0.95rem;border-radius:8px;border:1px solid var(--color-primary);
        padding:7px 12px;background:var(--color-dark-bg);color:var(--color-text-light);
        width:98%;margin-bottom:4px;font-family:inherit;font-weight:400;
        outline: none;
    }

    .msg-meta-line {
      display:flex; align-items:center; gap:6px; margin-top:4px;
      align-self: flex-end;
    }
    .message-bubble.media .msg-meta-line, .message-bubble.sticker .msg-meta-line {
        margin-top: 0;
        padding-right: 2px;
    }
    .msg-timestamp {
      font-size:.7rem;
      color:var(--color-text-mute);
      font-family:'Inter',sans-serif;
      user-select:text;
      opacity:.9;
      order: 1;
    }
    .message-row.own .msg-timestamp { color: #b3d9ff; }
    
    .tick-ic{margin-left:5px;vertical-align:middle;width:13px;height:13px;display:inline-block;opacity:.9;}
    .tick-ic svg{width:100%;height:100%;}
    
    .tick-ic.gray svg{
        background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 22 22"><path d="M6 12.6L9.4 16L16 8.6" fill="none" stroke="%238a8a9e" stroke-width="2.1" stroke-linecap="round" stroke-linejoin="round"/></svg>') center no-repeat;
        background-size: cover;
    }
    
    .tick-ic.blue svg{
        background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 22 22"><path d="M4 13.8L7.6 17L13.9 9.6" fill="none" stroke="%2338BDF8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M10.6 17.2L17.6 8.5" fill="none" stroke="%2338BDF8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>') center no-repeat;
        background-size: cover;
    }

    .input-bar{
      position: fixed; 
      bottom: 30px; /* Space for the new footer */
      left: 50%; 
      transform: translateX(-50%); 
      width: 100%;
      max-width:380px; 
      display:flex;
      padding:8px 10px;
      background:var(--color-header);
      gap:8px;align-items:center;z-index:111;
      box-shadow:0 -3px 12px rgba(0, 0, 0, 0.5);
      border-top: 1px solid rgba(0, 224, 255, 0.1); 
    }
    .input-bar input[type="text"]{
        flex:1;padding:10px 14px;border-radius:20px;
        background:var(--color-mid-bg);
        color:var(--color-text-light);
        font-size:0.98rem;
        font-family: 'Roboto', sans-serif;
        outline: none;
        transition: box-shadow .2s;
        border: none;
    }
    .input-bar input[type="text"]:focus{
        box-shadow: 0 0 0 2px var(--color-primary);
    }
    .input-bar button{
      background:var(--color-primary);
      color:var(--color-header);
      padding:10px 16px;
      border:none;border-radius:20px;
      font-weight:700;cursor:pointer;
      font-size:0.95rem;
      transition: background .2s, transform .1s, box-shadow .2s;
      flex-shrink: 0;
      box-shadow: 0 0 8px rgba(0, 224, 255, 0.5);
    }
    .input-bar button:hover{background:#00aaff; transform: translateY(-1px); box-shadow: 0 0 10px rgba(0, 224, 255, 0.7);}
    .input-bar-blocked{
        flex:1;padding:10px 14px;border-radius:9px;border:none;
        background:#282830;
        color:#f87171;font-size:0.95rem;text-align:center;
        pointer-events:none;font-weight:500;
    }
    .toast{position:fixed;bottom:140px;left:50%;transform:translateX(-50%);background:#10b981;color:white;padding:9px 18px;border-radius:7px;font-weight:600;display:none;z-index:115;box-shadow:0 3px 10px rgba(0, 0, 0, 0.2);}
    .toast.err{background:#ef4444;}
    .toast.open{display:block;}

    /* New Footer Style */
    .sharky-footer {
        position: fixed;
        bottom: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 100%;
        max-width: 380px;
        height: 30px;
        min-height: 30px;
        background: var(--color-header); 
        border-top: 1px solid rgba(0, 224, 255, 0.1);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 120;
        border-bottom-left-radius: 18px;
        border-bottom-right-radius: 18px;
        box-shadow: 0 -1px 8px rgba(0, 0, 0, 0.4);
    }
    .sharky-footer span {
        font-family: 'Orbitron', sans-serif;
        font-size: 0.85rem;
        font-weight: 700;
        color: var(--color-secondary); 
        letter-spacing: 0.15em;
        text-shadow: 0 0 5px rgba(255, 51, 204, 0.7);
    }

    .attach-btn {
        background: none;
        border: none;
        cursor: pointer;
        color: var(--color-primary);
        padding: 8px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.15s, color 0.15s, box-shadow 0.15s;
        flex-shrink: 0;
        width: 40px;
        height: 40px;
    }
    .attach-btn:hover {
        background: var(--color-mid-bg);
        color: var(--color-primary);
        box-shadow: 0 0 4px var(--color-primary);
    }
    .attach-btn svg {
        width: 22px;
        height: 22px;
        fill: currentColor;
    }
    .attach-popup {
        position: absolute;
        bottom: 50px;
        left: 10px;
        background: var(--color-header);
        border-radius: 12px;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.8), 0 0 10px rgba(0, 224, 255, 0.3);
        padding: 8px;
        display: flex;
        flex-direction: column;
        gap: 4px;
        z-index: 112;
        opacity: 0;
        transform: translateY(10px);
        pointer-events: none;
        transition: opacity 0.2s, transform 0.2s;
        border: 1px solid var(--color-primary); 
    }
    .attach-popup.open {
        opacity: 1;
        transform: translateY(0);
        pointer-events: auto;
    }
    .attach-popup button {
        background: var(--color-mid-bg);
        color: var(--color-text-light);
        border: none;
        padding: 10px 14px;
        border-radius: 6px;
        cursor: pointer;
        text-align: left;
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 0.9rem;
        font-weight: 600;
        transition: background 0.1s;
    }
    .attach-popup button:hover {
        background: #353545;
        color: var(--color-primary);
    }
    .attach-popup button svg {
        width: 18px;
        height: 18px;
        fill: var(--color-primary);
    }
    
    .sticker-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.9);
        z-index: 10000;
        display: none;
        justify-content: center;
        align-items: center;
        opacity: 0;
        transition: opacity 0.3s;
    }
    .sticker-modal-overlay.open {
        display: flex;
        opacity: 1;
    }
    .sticker-modal {
        background: var(--color-mid-bg);
        border-radius: 15px;
        width: 90%;
        max-width: 340px;
        box-shadow: 0 0 20px rgba(255, 51, 204, 0.5);
        display: flex;
        flex-direction: column;
        transform: scale(0.9);
        transition: transform 0.3s;
        border: 2px solid var(--color-secondary);
    }
    .sticker-modal-overlay.open .sticker-modal {
        transform: scale(1);
    }
    .sticker-modal-header {
        padding: 15px;
        border-bottom: 1px solid #454560;
        color: var(--color-text-light);
        font-family: 'Poppins', sans-serif;
        font-weight: 600;
        font-size: 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .sticker-modal-close {
        background: none;
        border: none;
        color: var(--color-secondary);
        cursor: pointer;
        font-size: 1.2rem;
        padding: 5px;
        border-radius: 50%;
        transition: color 0.15s, background 0.15s;
    }
    .sticker-modal-close:hover {
        color: var(--color-text-light);
        background: #353545;
    }
    .sticker-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
        padding: 15px;
        max-height: 400px;
        overflow-y: auto;
        justify-items: center;
        scrollbar-color: var(--color-primary) var(--color-mid-bg);
    }
    .sticker-item {
        position: relative;
        cursor: pointer;
        border: 3px solid transparent;
        border-radius: 12px;
        transition: border-color 0.15s, transform 0.1s;
        padding: 5px;
    }
    .sticker-item:hover {
        border-color: var(--color-primary);
        transform: scale(1.03);
    }
    .sticker-item.selected {
        border-color: var(--color-secondary);
        box-shadow: 0 0 0 2px rgba(255, 51, 204, 0.4);
    }
    .sticker-item img {
        width: 100%;
        height: auto;
        max-width: 100px;
        display: block;
        pointer-events: none;
    }
    .sticker-selected-tick {
        position: absolute;
        top: 5px;
        right: 5px;
        background: var(--color-secondary);
        color: white;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        display: none;
        justify-content: center;
        align-items: center;
        font-size: 12px;
        font-weight: 700;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.5);
    }
    .sticker-item.selected .sticker-selected-tick {
        display: flex;
    }
    .sticker-modal-footer {
        padding: 15px;
        border-top: 1px solid #454560;
        display: flex;
        justify-content: flex-end;
    }
    .sticker-send-btn {
        background: var(--color-primary);
        color: var(--color-header);
        border: none;
        padding: 10px 20px;
        border-radius: 9px;
        font-weight: 600;
        cursor: pointer;
        font-size: 0.95rem;
        transition: background 0.2s, transform 0.1s, box-shadow 0.2s;
        box-shadow: 0 0 8px rgba(0, 224, 255, 0.5);
    }
    .sticker-send-btn:hover {
        background: #00aaff;
        transform: translateY(-1px);
    }
    .sticker-send-btn:disabled {
        background: var(--color-text-mute);
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }

    @media (max-width:480px){
      body { padding-top: 45px; }
      .main-wrap{max-width:100vw; margin-top:0; border-radius: 0; height:100svh;}
      .chat-box{padding:10px 8px; 
        margin-top: 95px; 
        margin-bottom: 70px; /* Adjusted for mobile view */
      }
      .input-bar{max-width:100vw; padding: 6px 8px; bottom: 30px; border-radius: 0;}
      .sharky-footer{max-width:100vw; border-radius: 0;} 
      .chat-header-sticky { max-width: 100vw; }
      .attach-popup { bottom: 50px; left: 8px;} 
      .sticker-modal { width: 95%; }
    }
    @keyframes bubbleUp{
        from{opacity:0;transform:translateY(10px) scale(0.95);}
        to{opacity:1;transform:none;}
    }
  </style>
</head>
<body>
  <header id="mainHeader">
    <div class="header-inner">
      <div class="logo-container" tabindex="0" aria-label="Sharky Chat Logo">
        <img src="https://firebasestorage.googleapis.com/v0/b/sharky-chat-007.firebasestorage.app/o/gc-logo.png?alt=media&token=ddfe6e46-7351-4a07-8140-ea702b1bd823" alt="Sharky Logo" />
        <div class="logo-text">SHARKY CHAT</div>
      </div>
      <button class="menu-btn" id="menuBtn" type="button" aria-label="Toggle menu">
        â˜°
        <span class="notif-badge" id="menuNotif" style="display:none;">0</span>
      </button>
    </div>
    <nav class="menu-dropdown" role="menu" aria-label="Main Navigation">
      <button class="close-btn" aria-label="Close menu" title="Close menu" type="button">
        <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false" role="img" xmlns="http://www.w3.org/2000/svg">
          <line x1="18" y1="6" x2="6" y2="18" />
          <line x1="6" y1="6" x2="18" y2="18" />
        </svg>
      </button>
      <a href="profile.html" role="menuitem" tabindex="0">
        <span class="icon" aria-hidden="true">
          <svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg"><circle cx="16" cy="12" r="7"/><ellipse cx="16" cy="23.5" rx="12" ry="6.5"/></svg>
        </span>
        Profile
      </a>
      <a href="chatrooms.html" role="menuitem" tabindex="0">
        <span class="icon" aria-hidden="true">
          <svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg"><rect x="2" y="8" width="28" height="16" rx="5"/><rect x="12" y="6" width="8" height="4" rx="2"/><circle cx="7" cy="12" r="2"/><circle cx="25" cy="12" r="2"/></svg>
        </span>
        Chat Rooms
      </a>
      <a href="friends.html" role="menuitem" tabindex="0">
        <span class="icon" aria-hidden="true">
          <svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg"><circle cx="10" cy="12" r="5"/><circle cx="22" cy="12" r="5"/><ellipse cx="16" cy="23" rx="12" ry="6"/></svg>
        </span>
        Friends
        <span id="friends-notif" class="notif-badge" style="display:none;">0</span>
      </a>
      <a href="add-friends.html" role="menuitem" tabindex="0">
        <span class="icon" aria-hidden="true">
          <svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg"><circle cx="15" cy="13" r="7"/><rect x="23" y="19" width="9" height="3" rx="1.5"/><rect x="26" y="16" width="3" height="9" rx="1.5"/></svg>
        </span>
        Add Friend
      </a>
      <a href="inbox.html" role="menuitem" tabindex="0">
        <span class="icon" aria-hidden="true">
          <svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg"><rect x="4" y="8" width="24" height="16" rx="4"/><polyline points="4,8 16,18 28,8" fill="none" stroke="#60a5fa" stroke-width="2"/></svg>
        </span>
        Messages
        <span id="messages-notif" class="notif-badge" style="display:none;">0</span>
      </a>
      <a href="wallet.html" role="menuitem" tabindex="0">
        <span class="icon" aria-hidden="true">
          <svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg"><rect x="4" y="10" width="24" height="12" rx="3"/><ellipse cx="24" cy="16" rx="2" ry="2"/><rect x="6" y="13" width="20" height="4" rx="2"/><circle cx="17" cy="16" r="2" fill="#fff"/></svg>
        </span>
        Wallet
      </a>
      <a href="shop.html" role="menuitem" tabindex="0">
        <span class="icon" aria-hidden="true">
          <svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg"><rect x="6" y="13" width="20" height="9" rx="3"/><rect x="12" y="7" width="8" height="6" rx="2"/><rect x="13" y="22" width="6" height="4" rx="2"/><circle cx="10" cy="26" r="2"/><circle cx="22" cy="26" r="2"/></svg>
        </span>
        Shop
      </a>
      <a href="inventory.html" role="menuitem" tabindex="0">
        <span class="icon" aria-hidden="true">
          <svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg"><rect x="7" y="10" width="18" height="12" rx="3"/><rect x="11" y="6" width="10" height="4" rx="2"/><rect x="13" y="22" width="6" height="4" rx="2"/><path d="M7 22h18"/><circle cx="16" cy="18" r="2"/></svg>
        </span>
        Inventory
      </a>
      <a href="news.html" role="menuitem" tabindex="0">
        <span class="icon" aria-hidden="true">
          <svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg"><rect x="5" y="7" width="22" height="18" rx="4"/><rect x="9" y="11" width="14" height="2" rx="1"/><rect x="9" y="16" width="8" height="2" rx="1"/><circle cx="10" cy="21" r="2"/><rect x="14" y="20" width="7" height="2" rx="1"/></svg>
        </span>
        News
      </a>
      <a href="level.html" role="menuitem" tabindex="0">
        <span class="icon" aria-hidden="true">
          <svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg"><path d="M16 5v17" stroke="#6699ff" stroke-width="2.5" stroke-linecap="round"/><circle cx="16" cy="26" r="5" fill="#38bdf8" stroke="#bae6fd" stroke-width="1.5"/><rect x="11" y="13" width="10" height="4" rx="2" fill="#bae6fd" /><rect x="13" y="8" width="6" height="3" rx="1.5" fill="#60a5fa"/></svg>
        </span>
        Level
      </a>
      <a href="refer.html" role="menuitem" tabindex="0">
        <span class="icon" aria-hidden="true">
          <svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg"><circle cx="16" cy="16" r="13" fill="#5eead4" /><path d="M22.5,14h-8.7l3-3m-2.8,8a3,3,0,1,0-3,-3" stroke="#262626" stroke-width="2.3" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </span>
        Refer A Friend
      </a>
      <a href="verify-email.html" role="menuitem" tabindex="0">
        <span class="icon" aria-hidden="true">
          <svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg"><rect x="5" y="8" width="22" height="16" rx="5"/><polyline points="5,8 16,18 27,8" fill="none" stroke="#2dd4bf" stroke-width="2"/><circle cx="16" cy="19" r="2.5"/></svg>
        </span>
        Email Verification
      </a>
      <a href="help.html" role="menuitem" tabindex="0">
        <span class="icon" aria-hidden="true">
          <svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg"><circle cx="16" cy="16" r="12" fill="none" stroke="#fbbf24" stroke-width="2"/><text x="16" y="20" text-anchor="middle" fill="#fbbf24" font-size="8" font-family="Orbitron">?</text></svg>
        </span>
        Help
      </a>
      <a href="social-media.html" role="menuitem" tabindex="0">
        <span class="icon" aria-hidden="true">
          <svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg"><circle cx="8" cy="12" r="3"/><circle cx="24" cy="12" r="3"/><circle cx="16" cy="22" r="3"/><line x1="8" y1="15" x2="16" y2="19" stroke="#60a5fa" stroke-width="2"/><line x1="24" y1="15" x2="16" y2="19" stroke="#60a5fa" stroke-width="2"/></svg>
        </span>
        Social Media
      </a>
      <a href="#" id="themeSwitch" role="menuitem" tabindex="0">
        <span class="icon" aria-hidden="true">
          <svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg"><circle cx="16" cy="16" r="12"/><path d="M16 4v8"/><circle cx="16" cy="16" r="5" fill="#fff"/></svg>
        </span>
        Change Theme
      </a>
    </nav>
  </header>
  
  <div class="main-wrap">
    <div class="chat-header-sticky">
      <button class="back-btn" onclick="history.back()" title="Go back">
        <svg class="back-icon" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/></svg>
      </button>
      <img id="userPicSticky" class="chat-part-pic" src="https://via.placeholder.com/38x38?text=U" alt="user"/>
      <div class="user-name-status-wrap">
        <span class="chat-part-name" id="userNameSticky">Sharky User</span> 
        <span id="userStatus" class="user-status green">Online</span>
      </div>
      <button onclick="clearAllMessages()" class="header-action-btn" title="Clear all messages">ðŸ—‘</button>
      <button onclick="toggleBlock()" id="blockBtn" class="header-action-btn block-btn">Block</button>
    </div>
    
    <div id="chatBox" class="chat-box">
      </div>

    <div id="loadingOverlay" class="loading-overlay">
        <div class="loader"></div>
        <div class="loading-text">LOADING CHAT...</div>
    </div>
    <div class="toast" id="toast"></div>

    <div id="inputBar" class="input-bar">
      <button class="attach-btn" id="attachBtn" type="button" aria-label="Attach File">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path d="M15 15a4 4 0 01-8 0v-4a2 2 0 014 0v4a.5.5 0 001 0v-4a.5.5 0 00-1 0v4a.5.5 0 01-1 0V9a2 2 0 014 0v4a4 4 0 008 0v-4a.5.5 0 00-1 0v4a.5.5 0 01-1 0v-4a2 2 0 00-4 0v4a.5.5 0 011 0v-4a.5.5 0 00-1 0v6a4 4 0 01-8 0v-4a.5.5 0 001 0v4a.5.5 0 01-1 0v-4a2 2 0 00-4 0v4a4 4 0 008 0z" fill="currentColor"/>
            <path d="M12 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2zm0 18c-4.411 0-8-3.589-8-8s3.589-8 8-8 8 3.589 8 8-3.589 8-8 8z" fill="currentColor" fill-opacity="0.2"/>
        </svg>
      </button>
      <div class="attach-popup" id="attachPopup">
        <button id="sendImageBtn" type="button">
            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M18 5v14H6V5h12zm0-2H6a2 2 0 00-2 2v14a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2zM9 13.5l3 3 3-3.75V15a2 2 0 002 2H7a2 2 0 002-2v-1.5zM15.5 9.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0z"/></svg>
            Send Image
        </button>
        <input type="file" id="imageInput" accept="image/*" style="display:none;"/>
        
        <button id="sendAudioBtn" type="button">
            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a3.5 3.5 0 003.5-3.5V6a3.5 3.5 0 00-7 0v5a3.5 3.5 0 003.5 3.5zM12 17c-2.3 0-4.3-.9-5.7-2.3L4 16.5a8 8 0 008 4c4.4 0 8-3.6 8-8h-2c0 3.3-2.7 6-6 6zM15 10v1a3 3 0 01-6 0v-1h2v1a1 1 0 002 0v-1h2z"/></svg>
            Send Audio
        </button>
        <input type="file" id="audioInput" accept="audio/*" style="display:none;"/>
        
        <button id="sendStickerBtn" type="button">
            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M18 5v14H6V5h12zm0-2H6a2 2 0 00-2 2v14a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2zM8 10a1 1 0 11-2 0 1 1 0 012 0zm10 0a1 1 0 11-2 0 1 1 0 012 0zm-7 7.5a4 4 0 01-4-4h2a2 2 0 004 0h2a4 4 0 01-4 4z"/></svg>
            Stickers
        </button>
      </div>

      <input type="text" id="messageInput" placeholder="Type a message..." autocomplete="off"/>
      <button id="sendBtn" onclick="sendMessage()">Send</button>
    </div>

    <div class="sharky-footer">
        <span>SHARKY CHAT</span>
    </div>
  </div>

  <div class="sticker-modal-overlay" id="stickerModalOverlay">
      <div class="sticker-modal">
          <div class="sticker-modal-header">
              Select a Sticker
              <button class="sticker-modal-close" id="closeStickerModal">&times;</button>
          </div>
          <div class="sticker-grid" id="stickerGrid">
             
          </div>
          <div class="sticker-modal-footer">
              <button class="sticker-send-btn" id="sendSelectedStickerBtn" disabled>Send Sticker in Chat</button>
          </div>
      </div>
  </div>
  
  <script>
    document.addEventListener('DOMContentLoaded', function() {
        const loadingOverlay = document.getElementById('loadingOverlay');
        const chatBox = document.getElementById('chatBox');
        if (loadingOverlay) {
                loadingOverlay.classList.add('hidden');
            
             setTimeout(() => {
                loadingOverlay.style.display = 'none';
                
                if (chatBox) {
                    chatBox.classList.add('loaded');
                }
            }, 500); 
        }
    });
  </script>
</body>
</html>
   <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, query, where, onSnapshot, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    const firebaseConfig = {
      apiKey: "AIzaSyBGfgy9OeMTJ__oOAFxoBW-eIOYlvhObZM",
      authDomain: "sharky-chat-007.firebaseapp.com",
      projectId: "sharky-chat-007",
      storageBucket: "sharky-chat-007.appspot.com",
      messagingSenderId: "637104796242",
      appId: "1:637104796242:web:74ac36b86af91be15ea58b",
      measurementId: "G-HT9T3P9KST",
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const menuNotif = document.getElementById("menuNotif");
    const friendsNotif = document.getElementById("friends-notif");
    const messagesNotif = document.getElementById("messages-notif");

    let myUsername = "";
    let myUID = "";

    function bumpBadge(el, number) {
      if (!el) return;
      el.style.animation = "";
      setTimeout(() => {
        el.style.animation = "notifpop .34s";
      }, 25);
    }
    function bumpBadgeDropdown(el, number) {
      if (!el) return;
      el.style.animation = "";
      setTimeout(() => {
        el.style.animation = "notifpop .33s";
      }, 30);
    }

    function setupMenuNotifications(uid, username) {
      onSnapshot(
        query(collection(db, "friendRequests"), where("to", "==", uid), where("status", "==", "pending")),
        (snap) => {
          const frCount = snap.size;
          menuNotif.dataset.fr = frCount;
          friendsNotif.textContent = frCount > 99 ? "99+" : frCount;
          friendsNotif.style.display = frCount > 0 ? "inline-flex" : "none";
          bumpBadgeDropdown(friendsNotif, frCount);
          updateMenuBadge();
        }
      );
    }

    async function setupMessageNotifications(uid, username) {
      const friendsSnap = await getDocs(query(collection(db, "friends"), where(uid, "!=", null)));
      let myFriends = [];
      friendsSnap.forEach((doc) => {
        if (doc.id === uid && doc.data()) myFriends = Object.keys(doc.data());
      });
      
      if (myFriends.length === 0) {
        messagesNotif.style.display = "none";
        updateMenuBadge();
        return;
      }
      
      let unseenTracker = {};
      let usernamesData = {};
      
      let batchSize = 10;
      for (let i = 0; i < myFriends.length; i += batchSize) {
        let batch = myFriends.slice(i, i + batchSize);
        const usersSnap = await getDocs(query(collection(db, "users"), where("__name__", "in", batch)));
        usersSnap.forEach((doc) => {
          usernamesData[doc.id] = doc.data().username;
        });
      }

      for (const fid of myFriends) {
        const friendUsername = usernamesData[fid];
        if (!friendUsername || friendUsername === username) continue;
        const chatId = [username, friendUsername].sort().join("_");
        const msgRef = collection(db, "personalMessages", chatId, "messages");
        
        onSnapshot(
          query(msgRef, where("recipient", "==", username), where("seen", "==", false)),
          (snap) => {
            let unseen = 0;
            snap.forEach((doc) => {
              if (doc.data().sender !== username) unseen++;
            });
            unseenTracker[chatId] = unseen;
            updateMessagesBadge();
          }
        );
      }
      function updateMessagesBadge() {
        let totalUnseen = Object.values(unseenTracker).reduce((a, b) => a + b, 0);
        messagesNotif.dataset.count = totalUnseen;
        messagesNotif.textContent = totalUnseen > 99 ? "99+" : totalUnseen;
        messagesNotif.style.display = totalUnseen > 0 ? "inline-flex" : "none";
        bumpBadge(messagesNotif, totalUnseen);
        updateMenuBadge();
      }
    }

    function updateMenuBadge() {
      const frCount = parseInt(menuNotif.dataset.fr) || 0;
      const msgCount = parseInt(messagesNotif.dataset.count) || 0;
      const total = frCount + msgCount;
      if (total > 0) {
        menuNotif.textContent = total > 99 ? "99+" : total;
        menuNotif.style.display = "inline-flex";
        bumpBadge(menuNotif, total);
      } else {
        menuNotif.style.display = "none";
      }
    }
    
    const mainHeader = document.getElementById("mainHeader");
    const menuBtn = document.getElementById("menuBtn");
    const closeBtn = document.querySelector(".menu-dropdown .close-btn");

    menuBtn.addEventListener("click", (e) => {
      mainHeader.classList.toggle("expanded");
      e.stopPropagation();
    });

    closeBtn.addEventListener("click", (e) => {
mainHeader.classList.remove("expanded");
      menuBtn.focus();
      e.stopPropagation();
    });
   closeBtn.addEventListener("click", (e) => {
      mainHeader.classList.remove("expanded");
      menuBtn.focus();
      e.stopPropagation();
    });

    document.addEventListener("click", (e) => {
      if (!mainHeader.contains(e.target)) mainHeader.classList.remove("expanded");
    });

    document.querySelector(".menu-dropdown").addEventListener("click", (e) => {
      if (e.target.tagName === "A") mainHeader.classList.remove("expanded");
    });

    const themeSwitch = document.getElementById("themeSwitch");
    if (themeSwitch) {
      themeSwitch.addEventListener("click", function () {
        document.body.classList.toggle("light-theme");
        const theme = document.body.classList.contains("light-theme") ? "light" : "dark";
        localStorage.setItem("theme", theme);
        mainHeader.classList.remove("expanded");
      });
    }

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        console.log("User not logged in. Notification listeners are skipped.");
      } else {
        myUID = user.uid;
        try {
          let snap = await getDocs(query(collection(db, "users"), where("__name__", "==", myUID)));
          snap.forEach((docSnap) => {
            myUsername = docSnap.data().username || "";
          });
          setupMenuNotifications(myUID, myUsername);
          setupMessageNotifications(myUID, myUsername);
        } catch (error) {
           console.error("Error setting up new header notifications:", error);
        }
      }
    });
  </script>
  
  <script>
    const CLOUDINARY_URL = "https://api.cloudinary.com/v1_1/dlqvchjl3/image/upload";
    const CLOUDINARY_UPLOAD_PRESET = "personal_chat"; 
    const CHAT_FOLDER = "personal_chat";

    function closeAllMsgMenus() {
      document.querySelectorAll('.bubble-menu-pop').forEach(e=>{
        e.style.opacity="0";
        e.classList.remove("menu-open");
        setTimeout(()=>{e.style.display="flex";}, 200); 
      });
    }
    window.addEventListener('keydown', e=>{ if(e.key==="Escape") closeAllMsgMenus(); });
    window.addEventListener('click', (e)=>{
      if(!e.target.closest('.bubble-menu-pop') && !e.target.closest('.bubble-menu-btn') && !e.target.closest('#attachPopup') && !e.target.closest('#attachBtn') && !e.target.closest('.sticker-modal-overlay')){
        closeAllMsgMenus();
        document.getElementById('attachPopup').classList.remove('open');
      }
    });
    function showToast(msg, err) {
      const t = document.getElementById("toast");
      t.innerText = msg;
      t.className = "toast" + (err ? " err" : "");
      t.style.display = "block";
      setTimeout(() => t.style.display = "none", 2100);
    }
    const firebaseConfigCompat = {
      apiKey: "AIzaSyBGfgy9OeMTJ__oOAFxoBW-eIOYlvhObZM",
      authDomain: "sharky-chat-007.firebaseapp.com",
      projectId: "sharky-chat-007",
      storageBucket: "sharky-chat-007.appspot.com",
      messagingSenderId: "637104796242",
      appId: "1:637104796242:web:74ac36b86af91be15ea58b",
      measurementId: "G-HT9T3P9KST"
    };
    firebase.initializeApp(firebaseConfigCompat);

    const authCompat = firebase.auth();
    const dbCompat = firebase.firestore();
    const otherUsername = new URLSearchParams(location.search).get("username");
    let currentUsername = null, chatId = "", partnerPicUrl = "", partnerUID = "",
        areFriends = false, partnerBlockedMe = false, iBlockedPartner = false;
    const chatBox = document.getElementById("chatBox");
    const stickyPic = document.getElementById("userPicSticky");
    const stickyName = document.getElementById("userNameSticky");
    const userStatus = document.getElementById("userStatus");
    let blockBtn = document.getElementById("blockBtn");
    let inputBar = document.getElementById("inputBar");
    let partnerUIDLoaded = "";

    function setupUserPresenceTracking(userUID) {
        if (!userUID) return;
        const userRef = dbCompat.collection("users").doc(userUID);
        
        const updatePresence = () => {
             userRef.update({
                active: true,
                online: true,
                lastActive: firebase.firestore.FieldValue.serverTimestamp(),
                lastSeen: Date.now()
            }).catch(e => console.error("Presence update failed:", e));
        };
        
        updatePresence();

        const presenceInterval = setInterval(updatePresence, 60000);

        window.addEventListener('beforeunload', () => {
            userRef.update({ active: false, online: false });
        });
        
        authCompat.onAuthStateChanged(user => {
            if (!user) clearInterval(presenceInterval);
        });
    }

    function timeAgo(timestampMs) {
        if (!timestampMs) return 'Unknown';
        const now = Date.now();
        const seconds = Math.floor((now - timestampMs) / 1000);

        if (seconds < 60) return 'â— Active just now';
        
        const minutes = Math.floor(seconds / 60);
        if (minutes < 60) return `Active ${minutes}m ago`;

        const hours = Math.floor(minutes / 60);
        if (hours < 24) return `Active ${hours}h ago`;

        const days = Math.floor(hours / 24);
        if (days < 7) return `Active ${days}d ago`;

        const weeks = Math.floor(days / 7);
        if (weeks < 4) return `Active ${weeks}w ago`;
        
        return 'Active long ago';
    }
    function updateInputBarState() {
      if (partnerBlockedMe) {
        inputBar.innerHTML = `<div class="input-bar-blocked">You are blocked and cannot message.</div>`;
      } else if (iBlockedPartner) {
        inputBar.innerHTML = `<div class="input-bar-blocked">You have blocked this user. Unblock to chat.</div>`;
      } else if (!areFriends) {
        inputBar.innerHTML = `<div class="input-bar-blocked">You can only chat with friends.</div>`;
      } else {
        inputBar.innerHTML = `
          <button class="attach-btn" id="attachBtn" type="button" aria-label="Attach File">
            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M15 15a4 4 0 01-8 0v-4a2 2 0 014 0v4a.5.5 0 001 0v-4a.5.5 0 00-1 0v4a.5.5 0 01-1 0V9a2 2 0 014 0v4a4 4 0 008 0v-4a.5.5 0 00-1 0v4a.5.5 0 01-1 0v-4a2 2 0 00-4 0v4a.5.5 0 011 0v-4a.5.5 0 00-1 0v6a4 4 0 01-8 0v-4a.5.5 0 001 0v4a.5.5 0 01-1 0v-4a2 2 0 00-4 0v4a4 4 0 008 0z" fill="currentColor"/>
                <path d="M12 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2zm0 18c-4.411 0-8-3.589-8-8s3.589-8 8-8 8 3.589 8 8-3.589 8-8 8z" fill="currentColor" fill-opacity="0.2"/>
            </svg>
          </button>
          <div class="attach-popup" id="attachPopup">
            <button id="sendImageBtn" type="button">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M18 5v14H6V5h12zm0-2H6a2 2 0 00-2 2v14a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2zM9 13.5l3 3 3-3.75V15a2 2 0 002 2H7a2 2 0 002-2v-1.5zM15.5 9.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0z"/></svg>
                Send Image
            </button>
            <input type="file" id="imageInput" accept="image/*" style="display:none;"/>
            
            <button id="sendAudioBtn" type="button">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 14.5a3.5 3.5 0 003.5-3.5V6a3.5 3.5 0 00-7 0v5a3.5 3.5 0 003.5 3.5zM12 17c-2.3 0-4.3-.9-5.7-2.3L4 16.5a8 8 0 008 4c4.4 0 8-3.6 8-8h-2c0 3.3-2.7 6-6 6zM15 10v1a3 3 0 01-6 0v-1h2v1a1 1 0 002 0v-1h2z"/></svg>
                Send Audio
            </button>
            <input type="file" id="audioInput" accept="audio/*" style="display:none;"/>
            
            <button id="sendStickerBtn" type="button">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M18 5v14H6V5h12zm0-2H6a2 2 0 00-2 2v14a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2zM8 10a1 1 0 11-2 0 1 1 0 012 0zm10 0a1 1 0 11-2 0 1 1 0 012 0zm-7 7.5a4 4 0 01-4-4h2a2 2 0 004 0h2a4 4 0 01-4 4z"/></svg>
                Stickers
            </button>
          </div>
          <input type="text" id="messageInput" placeholder="Type a message..." autocomplete="off"/>
          <button id="sendBtn" onclick="sendMessage()">Send</button>
        `;
        document.getElementById("messageInput").addEventListener("keydown", function(e){
          if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); sendMessage();}
        });
        setupAttachmentListeners();
      }
    }

    async function checkBlockStates() {
      if (!currentUsername || !otherUsername) return;
      let myBlockSnap = await dbCompat.doc(`blocked/${currentUsername}/list/${otherUsername}`).get();
      iBlockedPartner = myBlockSnap.exists;
      let partnerBlockSnap = await dbCompat.doc(`blocked/${otherUsername}/list/${currentUsername}`).get();
      partnerBlockedMe = partnerBlockSnap.exists;
      blockBtn.innerText = iBlockedPartner ? "Unblock" : "Block";
      updateInputBarState();
    }

    async function updateProfilePresenceSticky(uid) {
      if (!uid) return;
      let snap = await dbCompat.collection("users").doc(uid).get();
      if(snap.exists) {
        const data = snap.data();
        const lastSeenMs = data.lastSeen;
        const isActive = data.active;
        
        if (isActive) {
            userStatus.className = "user-status green";
            userStatus.textContent = "â— Active Now";
        } else if (lastSeenMs) {
            userStatus.className = "user-status gray";
            userStatus.textContent = timeAgo(lastSeenMs);
        } else {
            userStatus.className = "user-status gray";
            userStatus.textContent = "Offline";
        }
      } else {
        userStatus.className = "user-status gray";
        userStatus.textContent = "Offline";
      }
    }
    authCompat.onAuthStateChanged(async function(user) {
      if (!user) return console.log("User not logged in in compat script. Chat logic skipped.");

      setupUserPresenceTracking(user.uid);

      const userDoc = await dbCompat.collection("users").doc(user.uid).get();
      currentUsername = userDoc.data().username;

      const otherQ = dbCompat.collection("users").where("username", "==", otherUsername);
      const otherSnap = await otherQ.get();
      if (otherSnap.empty) { showToast("User not found", 1); return; }
      const partner = otherSnap.docs[0].data();
      partnerPicUrl = partner.profilePic || "https://cdn-icons-png.flaticon.com/512/149/149071.png";
      partnerUID = partner.uid;
      partnerUIDLoaded = partner.uid;
      stickyPic.src = partnerPicUrl;
      stickyPic.onload = function(){ stickyPic.style.objectFit="cover";stickyPic.style.borderRadius="50%";};
      stickyPic.onerror = function(){ stickyPic.src = "https://cdn-icons-png.flaticon.com/512/149/149071.png"; };
      stickyName.textContent = partner.username;

      updateProfilePresenceSticky(partner.uid);
      setInterval(()=>updateProfilePresenceSticky(partnerUIDLoaded), 12000);

      const friendsDoc = await dbCompat.collection("friends").doc(user.uid).get();
      areFriends = friendsDoc.exists && friendsDoc.data() && friendsDoc.data()[partnerUID];

      chatId = [currentUsername, otherUsername].sort().join("_");
      await checkBlockStates();
      loadMessages();

      dbCompat.doc(`blocked/${currentUsername}/list/${otherUsername}`).onSnapshot(()=>checkBlockStates());
      dbCompat.doc(`blocked/${otherUsername}/list/${currentUsername}`).onSnapshot(()=>checkBlockStates());

      const msgCol = dbCompat.collection("personalMessages").doc(chatId).collection("messages");
      msgCol.orderBy("timestamp").limitToLast(40).onSnapshot(async snapshot => {
        snapshot.docs.forEach(async docSnap => {
          const m = docSnap.data();
          if (m.recipient === currentUsername && !m.seen) {
            await docSnap.ref.update({ seen: true });
          }
        });
      });
    });
    function formatDateTimeForMsg(ts) {
      let d = ts.seconds ? new Date(ts.seconds*1000) : (typeof ts==="object"&&ts.toDate?ts.toDate():new Date(ts));
      let h = d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
      return {h, dt: d.toLocaleDateString([], {year:"2-digit",month:"short",day:"numeric"})};
    }

    let sending = false;
    window.sendMessage = async (type = "text", content = null) => {
      const input = document.getElementById("messageInput");
      let text = (type === "text" && input) ? input.value.trim() : "";
      
      if (type === "text" && (!text || sending)) return;
      if (type !== "text" && (!content || sending)) return;
      
      if (partnerBlockedMe || iBlockedPartner || !areFriends) {
         showToast(partnerBlockedMe ? 'You are blocked.' : iBlockedPartner ? 'Unblock to send messages.' : 'You can only message friends.', 1);
         return;
      }
      
      sending = true;
      if (input) input.value = "";
      
      try {
        const msgCol = dbCompat.collection(`personalMessages`).doc(chatId).collection('messages');
        
        const snap = await msgCol.orderBy("timestamp").get();
        if (snap.size >= 40) {
          let extra = snap.size - 39;
          let dels = snap.docs.slice(0, extra);
          const deleteBatch = dbCompat.batch();
          dels.forEach(d => deleteBatch.delete(d.ref));
          await deleteBatch.commit();
        }
        
        const msgData = {
          sender: currentUsername,
          recipient: otherUsername,
          type: type,
          seen: false,
          timestamp: firebase.firestore.FieldValue.serverTimestamp(),
          edited: false
        };

        if (type === "text") {
            msgData.text = text;
        } else if (type === "image" || type === "audio") {
            msgData.url = content.url;
            msgData.caption = content.caption || "";
        } else if (type === "sticker") {
            msgData.stickerId = content;
            msgData.url = getStickerUrl(content); 
        }

        await msgCol.add(msgData);
      } catch (e) { showToast("âŒ Send failed",1); console.error(e); }
      sending = false;
    };
    
    const STICKER_LINKS = {
        "sticker-1": "https://user-gen-media-assets.s3.amazonaws.com/seedream_images/7a737310-46e6-4b22-bafe-6eb47a6d0075.png",
        "sticker-2": "https://user-gen-media-assets.s3.amazonaws.com/seedream_images/65d87776-b276-4c0a-9e73-836ce149f4ef.png",
      "happy-shark": "https://user-gen-media-assets.s3.amazonaws.com/seedream_images/7fb5dd52-2f24-42df-9c24-3b148885f92d.png",
    "waving-shark": "https://user-gen-media-assets.s3.amazonaws.com/seedream_images/babcc3d9-e00d-4838-a69c-3026f1dc0822.png",
    "thoughtful-shark": "https://user-gen-media-assets.s3.amazonaws.com/seedream_images/5dffa697-fece-43c3-a575-f022163a6ac4.png",
    "cool-shark": "https://user-gen-media-assets.s3.amazonaws.com/seedream_images/f19ecac3-6f13-4f97-b84d-2f4cb5b3ded7.png",
    "sleepy-shark": "https://user-gen-media-assets.s3.amazonaws.com/seedream_images/e951b0a4-6fa9-43d8-9116-64da569e1d21.png",
    "love-heart-shark": "https://user-gen-media-assets.s3.amazonaws.com/seedream_images/c019b63b-143b-4ad6-9808-604523045855.png",
      "crying-shark": "https://user-gen-media-assets.s3.amazonaws.com/seedream_images/291a9c1e-be3d-420e-a61c-7efc13193b7a.png",
    "angry-shark": "https://user-gen-media-assets.s3.amazonaws.com/seedream_images/1e5c0b5b-cacd-4848-890d-a64103832adb.png",
    "thumbs-up-shark": "https://user-gen-media-assets.s3.amazonaws.com/seedream_images/53f00561-5897-4bcd-8a42-c6ddae434a47.png",
    "star-gazing-shark": "https://user-gen-media-assets.s3.amazonaws.com/seedream_images/60d20309-bc28-4478-acf2-1648011a209b.png",
    "reading-shark": "https://user-gen-media-assets.s3.amazonaws.com/seedream_images/5248621f-4ea5-43c3-b527-bf16be05b364.png",
    "hungry-shark": "https://user-gen-media-assets.s3.amazonaws.com/seedream_images/8c27c06c-ac17-4f87-ba84-62c2372331c3.png",
    "pizza-shark": "https://user-gen-media-assets.s3.amazonaws.com/seedream_images/3f0db47e-6334-4b0c-a2c7-a47584a957a0.png"
};

    function getStickerUrl(id) {
        return STICKER_LINKS[id] || "";
    }

    let lastMsgStates = {};
    function addMessageToUI(m, docRef, idx,lastIdx) {
      const isOwn = m.sender === currentUsername;
      const msgRow = document.createElement("div");
      msgRow.className = "message-row" + (isOwn ? " own" : "");
      const bubble = document.createElement("div");
      bubble.className = "message-bubble";
      
      if (m.type === "image") {
          bubble.classList.add("media");
          const img = document.createElement("img");
          img.src = m.url;
          img.alt = "Sent Image";
          bubble.appendChild(img);
          if (m.caption) {
              const caption = document.createElement("div");
              caption.textContent = m.caption;
              caption.style.marginTop = "5px";
              caption.style.fontSize = "0.85rem";
              caption.style.color = isOwn ? "#f0f8ff" : "#d1d5db";
              bubble.appendChild(caption);
          }
      } else if (m.type === "audio") {
          bubble.classList.add("media");
          const audio = document.createElement("audio");
          audio.src = m.url;
          audio.controls = true;
          bubble.appendChild(audio);
      } else if (m.type === "sticker") {
          bubble.classList.add("sticker");
          const stickerImg = document.createElement("img");
          stickerImg.src = m.url;
          stickerImg.alt = "Sticker";
          bubble.appendChild(stickerImg);
      } else if (m.type === "text") {
        if (isOwn) {
          const btn = document.createElement("button");
          btn.className = "bubble-menu-btn";
          btn.innerHTML = `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="5" r="1.5"/><circle cx="12" cy="12" r="1.5"/><circle cx="12" cy="19" r="1.5"/>
          </svg>`;
          const menuPopup = document.createElement("div");
          menuPopup.className = "bubble-menu-pop";
          const bEdit = document.createElement("button");
          bEdit.innerHTML = 'âœï¸';
          bEdit.title = "Edit";
          bEdit.onclick = function(e){ e.stopPropagation(); closeAllMsgMenus(); startEditMessage(docRef); };
          const bDel = document.createElement("button");
          bDel.innerHTML = 'ðŸ—‘ï¸';
          bDel.title = "Delete";
          bDel.onclick = function(e){ e.stopPropagation(); closeAllMsgMenus(); deleteMessage(docRef); };
          menuPopup.appendChild(bEdit); menuPopup.appendChild(bDel);
          bubble.appendChild(btn); bubble.appendChild(menuPopup);
  
          btn.addEventListener('click', function(e){
            e.stopPropagation();
            document.querySelectorAll('.bubble-menu-pop.menu-open').forEach(pp=>{
              if(pp!==menuPopup){ pp.classList.remove('menu-open'); pp.style.opacity="0"; }
            });
            if(menuPopup.classList.contains('menu-open')){
              menuPopup.classList.remove('menu-open');
              menuPopup.style.opacity="0";
            } else {
              menuPopup.style.display = "flex";
              setTimeout(()=>{ menuPopup.classList.add("menu-open"); menuPopup.style.opacity="1"; }, 1);
            }
          });
        }
        
        if (isOwn && m.editing) {
          const input = document.createElement("input");
          input.className = "bubble-edit-input";
          input.value = m.text;
          input.onkeydown = function(e){
            if(e.key==="Enter") confirmEditMessage(docRef, input.value);
            if(e.key==="Escape") cancelEditMessage(docRef);
          };
          bubble.appendChild(input);
          setTimeout(()=>input.focus(),30);
        } else {
          bubble.appendChild(document.createTextNode(m.text || ""));
        }
      }
      
      let metaRow = document.createElement("div");
      metaRow.className = "msg-meta-line";
      const ts = m.timestamp ? formatDateTimeForMsg(m.timestamp) : {h:"",dt:""};
      const tspan = document.createElement("span");
      tspan.className = "msg-timestamp";
      tspan.textContent = ts.h + (m.edited && m.type==='text' ? ' (edited)' : '');
      metaRow.appendChild(tspan);
      
      if (isOwn) {
        let tickSpan = document.createElement("span");
        tickSpan.className = "tick-ic";
        tickSpan.innerHTML = `<span><svg></svg></span>`; 
        
        if (m.seen) {
          tickSpan.classList.add("blue");
        } else {
          tickSpan.classList.add("gray");
        }

        if (m.__justSeen) { tickSpan.classList.add("pop"); }

        metaRow.appendChild(tickSpan);
      }
      
      bubble.appendChild(metaRow);
      msgRow.appendChild(bubble);
      chatBox.appendChild(msgRow);
      if(idx === lastIdx || isOwn) {
          setTimeout(()=>chatBox.scrollTop = chatBox.scrollHeight, 40);
      }
    }

    function loadMessages() {
      if(!chatId) return;
      const msgCol = dbCompat.collection(`personalMessages`).doc(chatId).collection("messages");
      msgCol.orderBy("timestamp").limitToLast(40).onSnapshot(
        function(snapshot) {
          chatBox.innerHTML = "";
          const docs = snapshot.docs;
          docs.forEach((docSnap, idx) => {
            const m = docSnap.data();
            let msgId = docSnap.id;
            let oldState = lastMsgStates[msgId];
            let state = { seen: m.seen };
            
            if (m.seen && oldState && !oldState.seen) {
              m.__justSeen = true;
              setTimeout(()=>{ m.__justSeen = false; }, 400);
            }
            
            addMessageToUI(m, docSnap.ref, idx, docs.length-1);
            lastMsgStates[msgId] = state;
          });
        }
      );
    }
    
    function startEditMessage(ref) { ref.update({editing:true}); }
    function cancelEditMessage(ref) { ref.update({editing:false}); }
    function confirmEditMessage(ref, text) {
      if (!text.trim()) return showToast("Message cannot be empty", 1);
      ref.update({text:text.trim(), editing:false, edited:true });
      showToast("Message updated");
    }
    function deleteMessage(ref) {
      ref.delete();
      showToast("Deleted");
    }
    
    window.toggleBlock = async () => {
      if (!currentUsername || !otherUsername) return showToast("Cannot block/unblock yet, loading...", 1);
      const blockRef = dbCompat.doc(`blocked/${currentUsername}/list/${otherUsername}`);
      const snap = await blockRef.get();
      if (snap.exists) {
        await blockRef.delete();
        showToast("User unblocked");
      } else {
        await blockRef.set({ user: otherUsername, timestamp:firebase.firestore.FieldValue.serverTimestamp() });
        showToast("User blocked");
      }
    };
    
    window.clearAllMessages = async () => {
      if (!chatId) return;
      if (!confirm("Are you sure you want to delete all messages from this chat? This cannot be undone.")) return;

      const msgCol = dbCompat.collection("personalMessages").doc(chatId).collection("messages");
      const snapshot = await msgCol.get();
      
      const batch = dbCompat.batch();
      snapshot.docs.forEach(docSnap => {
        batch.delete(docSnap.ref);
      });
      await batch.commit();
      
      showToast("All messages cleared");
    };
    
    let selectedStickerId = null;
    const stickerModalOverlay = document.getElementById('stickerModalOverlay');
    const stickerGrid = document.getElementById('stickerGrid');
    const sendSelectedStickerBtn = document.getElementById('sendSelectedStickerBtn');

    function openStickerModal() {
        stickerModalOverlay.classList.add('open');
        selectedStickerId = null;
        sendSelectedStickerBtn.disabled = true;
        renderStickerGrid();
    }
    function closeStickerModal() {
        stickerModalOverlay.classList.remove('open');
    }

    function renderStickerGrid() {
        stickerGrid.innerHTML = "";
        
        Object.entries(STICKER_LINKS).forEach(([id, url]) => {
            const item = document.createElement('div');
            item.className = 'sticker-item';
            item.dataset.stickerId = id;
            item.innerHTML = `
                <img src="${url}" alt="${id.replace('-', ' ')} sticker" loading="lazy"/>
                <span class="sticker-selected-tick">âœ“</span>
            `;
            item.onclick = () => selectSticker(id, item);
            stickerGrid.appendChild(item);
        });
    }

    function selectSticker(id, element) {
        document.querySelectorAll('.sticker-item').forEach(el => el.classList.remove('selected'));
        element.classList.add('selected');
        selectedStickerId = id;
        sendSelectedStickerBtn.disabled = false;
    }

    function setupAttachmentListeners() {
        const attachBtn = document.getElementById('attachBtn');
        const attachPopup = document.getElementById('attachPopup');
        const imageInput = document.getElementById('imageInput');
        const sendImageBtn = document.getElementById('sendImageBtn');
        const audioInput = document.getElementById('audioInput');
        const sendAudioBtn = document.getElementById('sendAudioBtn');
        const sendStickerBtn = document.getElementById('sendStickerBtn');
        const closeStickerModalBtn = document.getElementById('closeStickerModal');

        attachBtn.onclick = function(e) {
            e.stopPropagation();
            attachPopup.classList.toggle('open');
        };

        sendImageBtn.onclick = function() {
            imageInput.click();
            attachPopup.classList.remove('open');
        };

        sendAudioBtn.onclick = function() {
            audioInput.click();
            attachPopup.classList.remove('open');
        };
        
        sendStickerBtn.onclick = function() {
            openStickerModal();
            attachPopup.classList.remove('open');
        };

        imageInput.onchange = function(e) {
            const file = e.target.files[0];
            if (file) {
                uploadFileToCloudinary(file, "image");
            }
            imageInput.value = '';
        };

        audioInput.onchange = function(e) {
            const file = e.target.files[0];
            if (file) {
                uploadFileToCloudinary(file, "audio");
            }
            audioInput.value = '';
        };

        closeStickerModalBtn.onclick = closeStickerModal;
        stickerModalOverlay.onclick = function(e) {
            if (e.target.id === 'stickerModalOverlay') closeStickerModal();
        };

        sendSelectedStickerBtn.onclick = async function() {
            if (selectedStickerId) {
                await sendMessage("sticker", selectedStickerId);
                closeStickerModal();
                showToast("Sticker Sent! ðŸ¦ˆ");
            }
        };
    }

    async function uploadFileToCloudinary(file, type) {
      if (!file) return;
      if (CLOUDINARY_UPLOAD_PRESET === "YOUR_CLOUDINARY_UPLOAD_PRESET") {
        return showToast("âš ï¸ Cloudinary Upload Preset is not configured.", 1);
      }
      
      showToast(`Uploading ${type}...`, 0);
      const formData = new FormData();
      formData.append('file', file);
      formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
      formData.append('folder', CHAT_FOLDER);
      
      try {
        const response = await fetch(CLOUDINARY_URL, {
          method: 'POST',
          body: formData
        });

        const data = await response.json();
        if (data.secure_url) {
          const content = { url: data.secure_url, caption: (type === 'image' ? prompt("Add a caption (optional):") : null) };
          await sendMessage(type, content);
          showToast(`${type.charAt(0).toUpperCase() + type.slice(1)} sent successfully!`, 0);
        } else {
          showToast(`Cloudinary upload failed: ${data.error ? data.error.message : 'Unknown error'}`, 1);
          console.error("Cloudinary Error:", data);
        }
      } catch (e) {
        showToast("Network error during upload.", 1);
        console.error("Upload Error:", e);
      }
    }
  </script>
</body>
</html>